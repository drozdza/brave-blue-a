<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>Brave Blue A</title>
<link rel="icon" type="image/png" href="brave_blue_a.png">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript">
GET={
    DEBUG:0,
    BLUR:0,
    FRAMES:0,
    CANVAS:0,
    FPS:0,
};
(function(){
    var GETs = document.location.href.split('?')[1];
    if(typeof GETs != 'undefined'){
        GETs = GETs.split('&');
        for(var gi=0; gi<GETs.length; ++gi){
            var BUM = GETs[gi].split('=');
            switch(BUM[0]){
                case 'debug':  GET['DEBUG']  = BUM[1]; break;
                case 'blur':   GET['BLUR']   = BUM[1]; break;
                case 'frames': GET['FRAMES'] = BUM[1]; break;
                case 'canvas': GET['CANVAS'] = BUM[1]; break;
                case 'fps':    GET['FPS']    = BUM[1]; break;
            }
        }
    }
})();

function cloneObj(obj){
    var copy;
    if (null == obj || "object" != typeof obj) return obj;
    if (obj instanceof Array) {
        copy = [];
        for (var i = 0, len = obj.length; i < len; i++) {
            copy[i] = cloneObj(obj[i]);
        }
        return copy;
    }
    if (obj instanceof Object) {
        copy = {};
        for (var attr in obj) {
            if (obj.hasOwnProperty(attr)) copy[attr] = cloneObj(obj[attr]);
        }
        return copy;
    }
}

function betweenAngles(what,angle1,angle2){
    what = (what- -720)%360;
    angle1 = (angle1- -720)%360;
    angle2 = (angle2- -720)%360;

    if(angle1 > angle2 && (angle1 < what || angle2 > what))    return true;
    if(angle1 < angle2 && angle1 < what && angle2 > what)    return true;
    return false;
}

</script>
<script type="text/javascript">
NAMES={};
NAMES.Ships={
    M:'muerto',
    T:'tartaros',
    B:'belzebub',
    N:'nemezis',
    Q:'orhenes',
    U:'dregos',
    A:'carras',
    K:'koriaz',
    C:'cloacker',
    F:'fariax',
    G:'gargamon',
    S:'hajaher',
    D:'dandares',
    J:'juggernaut',
    V:'vitotas',
    E:'edison',
    H:'hiacynt',
    W:'warastein',
    I:'iskariot',
    R:'royale',
};
NAMES.ModName = {
    healerProd: 'Heal',
    esteemProd: '<div class="smaller_title">Moves Estimation</div>',
    shieldProd: 'Shield',
    radar:      'Radar',
    bulletProd: 'Bullets',
    bombProd:   'Bombs',
    missleProd: 'Missles',
    laserProd:  'Laser',
    teleProd:   'Teleport',
    spotRegion: '<div class="smaller_title">Ships Spot</div>',
};

ObjectPutDatas={
    healing_missle:{
        viewLetter: 'J',
        viewLetterSize: 12,
        viewColor: '0f0',
        viewAngle: 180,

        lifeM: 1,
        speed: 13,
        speedT: 20,
        Power: 1,
        doingTime: 230,
        toDo: [{T:'die'}],
        Manouver: 'followEntity',
    },
    missle:{
        viewLetter: 'Y',
        viewLetterSize: 12,
        viewColor: '#ff0',
        viewAngle: 0,

        lifeM: 1,
        speed: 15,
        speedT: 3,
        Power: 1,
        doingTime: 200,
        toDo: [{T:'expire'}],
        Manouver: 'followEntity',
    },
    bullet_bomb:{
        viewLetter: 'P',
        viewLetterSize: 12,
        viewColor: '#ff0',
        viewAngle: 0,

        lifeM: 1,
        speed: 15,
        speedT: 2,
        Power: 1,
        doingTime: 35,
        toDo: [{T:'expire'}],
        Manouver: 'goStraight',
    },
    space_mine:{
        viewLetter: 'R',
        viewLetterSize: 10,
        viewColor: '#ff0',
        viewAngle: 0,

        lifeM: 1,
        onHit: {Do:'explode',Power: 4, Dist: 35, explodeType: 'nails', NailsRad: 24, NailsSpeed: 6, NailsSpeedPlus: 0, NailsDec: 45, NailsDecPlus: 0, NailsAngleCenter: 8, NailsAngleBoth: 1, NailsNeutral: true},
        onDie: {Do:'explode',Power: 4, Dist: 35, explodeType: 'nails', NailsRad: 24, NailsSpeed: 6, NailsSpeedPlus: 0, NailsDec: 45, NailsDecPlus: 0, NailsAngleCenter: 8, NailsAngleBoth: 1, NailsNeutral: true},

        // onHit: {Do:'explode',Power: 4, Dist: 35, explodeType: 'nails', NailsRad: 24, NailsSpeed: 4, NailsSpeedPlus: 6, NailsDec: 16, NailsDecPlus: 6, NailsNeutral: true},
        // onDie: {Do:'explode',Power: 4, Dist: 35, explodeType: 'nails', NailsRad: 24, NailsSpeed: 4, NailsSpeedPlus: 6, NailsDec: 16, NailsDecPlus: 6, NailsNeutral: true},

        squadScheme: {
            0:{ angle: 0, radius: 0, id: -1, make: {What:{RoundField:1},objData:{x:0,y:-1000, angle: 0, radius: 150, colorInactive: false, colorActive: 'rgba(255,0,0,0.4)', OneTimeEffect: 1, OneTimeOffset: 10, OneTimeDetect: 1, dontHit:['B','BE','E','M','ME','A']}}}
        },

        detectMovementField:{ angle: 0, radius: 80, color: "rgba(255,0,0,0.4)"}
    },
    star:{
        viewLIBpath:'StarPath', // *
        viewPathSize:30,
        viewColor:'white',
        viewAngle:0,
        viewHitPattern:'StarHit',
        lifeM:6,
    },
    Gstar:{
        viewLIBpath:'StarPath', // *
        viewPathSize:170,
        viewColor:'yellow',
        viewAngle:0,
        viewXY:180,
        radius: 90,
        undestructible: 1,
        bounceType: 'straight',
    },
    RoundField:{
        radius: 50,
        circleColor:[255,255,255,0.2],
        undestructible: 1,
    },
    SquareField:{
        radius: 50,
        color: 'red',
        squareAngle: 0,
        squareLen: 50,
        squareWidth: 15,
        undestructible: 1,
    },
    ConeField:{
        radius: 50,
        color: 'red',
        coneAngle: 180,
        coneRad2: 50,
        angle: 0,
        undestructible: 1,
    },


    enemyShip:{
        TT: 'enemy',
        lastSpeedT: 0,
        doSquad: -1,//??
        dec: 50,    //??
        ammo: -50,    //??
        spotEnemyFlag: false,
        gotHitFlag: false,
        heardExplosionFlag: false,
        newOrderFlag: false,
        awareAboutEnemy: false,
        lastSeenEnemy: -1,
        radius: 15,

        toDo:[],
        doingTime: -1,
        Manouver: 'goStraight',
        AlarmLvl: 2,


    },
    carras:{
        viewLetter: 'A',
        viewLetterSize: 16,
        viewColor: 'red',
        viewAngle: 0,
        viewHitPattern: 'HullFire_20',
        lifeM: 5,

        spotLvl: 2,

        weapon:[{t:'single', Power:1, Dec: 50, Speed: 10, gunSpeed: 15, lastShot: 100, maxSpeed: 2, minAlarm: 5}],

        AlarmLvl: 2,
        doingNow: 'changeManouver',
        doingTime: -1,
        Manouver: 'goStraight',
        toDo: [
            {N:55,T:'alarmAboutSpottedEnemy', minAlarm: 5, alarmRadius: 250},
            {N:45,T:'lowerAlarmLvl', minAlarm: 5, minEnemyDontSeen: 750, goToAlarmLvl: 4, goToSpotLvl: 2},
            {N:35,T:'followEnemy', minAlarm: 5, goToSpotLvl: 3 },
            {N:23,T:'stayInRegion', X:0, Y:0, Radius: 1700 },
            {N:18,T:'changeManouver2', maxAlarm: 4, minAlarm: 3, straightMin: 20, straightPlus: 80, turnMin: 10, turnPlus: 80  },
            {N:15,T:'changeManouver', maxAlarm: 3, straightMin: 60, straightPlus: 100, turnMin: 30, turnPlus: 70  },
        ],
    },
    muerto:{
        viewLetter: 'M',
        viewLetterSize: 40,
        viewColor: 'red',
        viewAngle: 0,
        viewHitPattern: 'HullFire_40',
        lifeM: 9,
        radius: 20,

        spotLvl: 2,

        AlarmLvl: 2,
        doingNow: 'changeManouver',
        doingTime: -1,
        Manouver: 'goStraight',
        toDo: [
            {N:23,T:'stayInRegion', X:-800, Y:0, Radius: 500 },
            {N:15,T:'changeManouver', maxAlarm: 3, straightMin: 60, straightPlus: 100, turnMin: 30, turnPlus: 70  },
        ],
    },
    nemezis:{
        viewLetter: 'N',
        viewLetterSize: 40,
        viewColor: 'red',
        viewAngle: 0,
        viewHitPattern: 'HullFire_40',
        lifeM: 4,
        radius: 20,
    },
    warastein:{
        viewLetter: 'W',
        viewLetterSize: 40,
        viewColor: 'red',
        viewAngle: 0,
        viewHitPattern: 'HullFire_40',
        lifeM: 11,
        radius: 23,
    },
    dandares:{
        viewLetter: 'D',
        viewLetterSize: 40,
        viewColor: 'red',
        viewAngle: 270,
        viewHitPattern: 'HullFire_40',
        lifeM: 7,
        radius: 20,

        weapon: [{t:'makeShieldBlob', gunSpeed: 25, lastShot: 100, shieldBlobMaxHp: 6, maxSpeed: 2}],

        squadSchemeType: {t:'round', count: 16, radius: 100},
        squadScheme: [],

        AlarmLvl: 2,
        doingNow: 'changeManouver',
        doingTime: -1,
        Manouver: 'goStraight'
    },
    shieldBlob:{
        viewLetter: '#',
        viewLetterSize: 40,
        colorFill:[0,255,200,1],
        viewAngle: 0,
        lifeM: 3,
        radius: 21,
        viewHitPattern:'ShieldBlobHit',

        backgroundCircle: 21,
        colorCircle:[0,200,100,1],
    },
    royale:{
        viewLetter: 'R',
        viewLetterSize: 40,
        viewColor: 'red',
        viewAngle: 0,
        viewHitPattern: 'HullFire_40',
        lifeM: 16,
        radius: 20,
    },
    edison:{
        viewLetter: 'E',
        viewLetterSize: 40,
        viewColor: 'red',
        viewAngle: 0,
        viewHitPattern: 'HullFire_40',
        lifeM: 9,
        radius: 20,
    },
    hiacynt:{
        viewLetter: 'H',
        viewLetterSize: 20,
        viewColor: 'red',
        viewAngle: 0,
        viewHitPattern: 'HullFire_20',
        lifeM: 4,
    },
    iskariot:{
        viewLetter: 'I',
        viewLetterSize: 20,
        viewColor: 'red',
        viewAngle: 0,
        viewHitPattern: 'HullFire_20',
        lifeM: 3,

        jump: 3,
        jumpM: 3,
        jumpT: 0,

        spotLvl: 2,

        weapon:[
            {t:'refilJumps', jumpA: 300, jumpM: 3, maxSpeed: 2, doNextWeapon: true},
            {t:'double2', Power:1, Dec: 35, Speed: 12, gunSpeed: 20, lastShot: 100, maxSpeed: 2, minAlarm: 5},
        ],

        AlarmLvl: 2,
        doingNow: 'changeManouver',
        doingTime: -1,
        Manouver: 'goStraight',
        toDo: [
            {N:55,T:'alarmAboutSpottedEnemy', minAlarm: 5, alarmRadius: 250},
            {N:45,T:'lowerAlarmLvl', minAlarm: 5, minEnemyDontSeen: 750, goToAlarmLvl: 4, goToSpotLvl: 2},
            {N:35,T:'followEnemy', minAlarm: 5, goToSpotLvl: 3 },
            {N:23,T:'stayInRegion', X:0, Y:0, Radius: 1700 },
            {N:18,T:'changeManouver2', maxAlarm: 4, minAlarm: 3, straightMin: 20, straightPlus: 80, turnMin: 10, turnPlus: 80  },
            {N:15,T:'changeManouver', maxAlarm: 3, straightMin: 60, straightPlus: 100, turnMin: 30, turnPlus: 70  },
        ],
    },
    tartaros:{
        viewLetter: 'T',
        viewLetterSize: 60,
        viewColor: 'red',
        viewAngle: 0,
        viewHitPattern: 'HullFire_40',
        lifeM: 9,
        radius: 27,
    },
    belzebub:{
        viewLetter: 'B',
        viewLetterSize: 40,
        viewColor: 'red',
        viewAngle: 90,
        viewHitPattern: 'HullFire_40',
        lifeM: 9,
        radius: 20,
    },
    koriaz:{
        viewLetter: 'K',
        viewLetterSize: 16,
        viewColor: 'red',
        viewAngle: 270,
        viewHitPattern: 'HullFire_20',
        lifeM: 7,
        radius: 10,
    },
    fariax:{
        viewLetter: 'F',
        viewLetterSize: 40,
        viewColor: 'red',
        viewAngle: 0,
        viewHitPattern: 'HullFire_40',
        lifeM: 9,
        radius: 20,
    },
    dregos:{
        viewLetter: 'U',
        viewLetterSize: 20,
        viewColor: 'red',
        viewAngle: 0,
        viewHitPattern: 'HullFire_20',
        lifeM: 9,
    },
    vitotas:{
        viewLetter: 'V',
        viewLetterSize: 20,
        viewColor: 'red',
        viewAngle: 0,
        viewHitPattern: 'HullFire_20',
        lifeM: 5,
    },
    cloacker:{
        viewLetter: 'C',
        viewLetterSize: 20,
        viewColor: 'red',
        viewAngle: 270,
        viewHitPattern: 'HullFire_20',
        lifeM: 3,
    },
    hajaher:{
        viewLetter: 'S',
        viewLetterSize: 20,
        viewColor: 'red',
        viewAngle: 0,
        viewHitPattern: 'HullFire_20',
        lifeM: 6,
    },
    orhenes:{
        viewLetter: 'Q',
        viewLetterSize: 80,
        viewColor: 'red',
        viewAngle: 0,
        viewHitPattern: 'HullFire_80',
        lifeM: 60,
        radius: 40,
    },
    juggernaut:{
        viewLetter: 'J',
        viewLetterSize: 80,
        viewColor: 'red',
        viewAngle: 0,
        viewHitPattern: 'HullFire_80',
        lifeM: 12,
        radius: 40,
    },
    gargamon:{
        viewLetter: 'G',
        viewLetterSize: 80,
        viewColor: 'red',
        viewAngle: 270,
        viewHitPattern: 'HullFire_80',
        lifeM: 22,
        radius: 40,
    },

};

/*
            {N:74,T:'alarmAboutIncomingFire', gotHitFlag: true, minAlarm: 5, alarmRadius: 220},
            {N:73,T:'avoidIncomingFire', gotHitFlag: true, minAlarm: 2, avoidTime: 12},
            {N:72,T:'avoidIncomingFire', incomingFireFlag: true, minAlarm: 5, avoidTime: 12},
            {N:55,T:'alarmAboutSpottedEnemy', minAlarm: 5, alarmRadius: 250},
            {N:45,T:'lowerAlarmLvl', minAlarm: 5, minEnemyDontSeen: 750, goToAlarmLvl: 4, goToSpotLvl: 2},
            {N:35,T:'followEnemy', minAlarm: 5, goToSpotLvl: 3 },
            {N:23,T:'stayInRegion', X:0, Y:0, Radius: 1700 },
            {N:18,T:'changeManouver2', maxAlarm: 4, minAlarm: 3, straightMin: 20, straightPlus: 80, turnMin: 10, turnPlus: 80  },
            {N:15,T:'changeManouver', maxAlarm: 3, straightMin: 60, straightPlus: 100, turnMin: 30, turnPlus: 70  },
            {N:1, T:'goStraight', straightMin: 200, straightPlus: 100 },
*/

BoardMODS={
    sitOnMap:{
        toDo:[
            {N:22,T:'stayInRegion', X:0, Y:0, Radius: 700 },
            {N:1, T:'goStraight', straightMin: 200, straightPlus: 100 },
        ],
    },
    allAvoid:{
        who:['A','S','C','U','H'],
        toDo:[
            {N:74,T:'alarmAboutIncomingFire', gotHitFlag: true, minAlarm: 5, alarmRadius: 150},
            {N:73,T:'avoidIncomingFire', gotHitFlag: true, minAlarm: 2, avoidTime: 12},
            {N:72,T:'avoidIncomingFire', incomingFireFlag: true, minAlarm: 5, avoidTime: 12},
        ],
    },

};

BOARDS={
    'u1':{
        MapRadius:60,MapRadius2:2400,
        BoardMods:['sitOnMap','allAvoid'],
        Place:[
            {Random:{X: 0, Y: 0, Radius: 200}, What: {K:1}},

            {What:{SquareField:1},objData:{x:59,y:-933, squareAngle: 45, squareLen: 500, squareWidth: 30, fieldAnim: 'DestructionField', PeriodDamage: 1, PeriodTime: 20, PeriodOffset: 20}},

            {What:{SquareField:1},objData:{x:0,y:-1000, squareAngle: 45, squareLen: 500, squareWidth: 30, fieldAnim: 'WindField', bounceType:'wind',bounceForce:5,windAngle:60}},

            {What:{SquareField:1},objData:{x:800,y:-730, squareAngle: 45, squareLen: 500, squareWidth: 70, fieldAnim: 'WindField', vectorType:'wind', vectorForce:5, windAngle:60}},

            {What:{ConeField:1},objData:{x:400,y:-1000, radius: 220, angle: 110, coneAngle: 40, coneRad2: 40, fieldAnim: 'DestructionField', PeriodDamage: 1, PeriodTime: 20, PeriodOffset: 20}},
            {What:{ConeField:1},objData:{x:-200,y:-1000, radius: 220, angle: 270, coneAngle: 110, coneRad2: 0, fieldAnim:'WindField', bounceType:'wind',bounceForce:1,windAngle:60}},

            {What:{RoundField:1},objData:{x:-1500,y:100, radius:160, fieldAnim: 'WindField', bounceType:'wind',bounceForce:1,windAngle:60}},
            {What:{RoundField:1},objData:{x:-1000,y:400, radius:160, fieldAnim: 'GravityField', bounceType:'gravity',bounceForce:8}},
            {What:{RoundField:1},objData:{x:1400,y:-850, radius:160, fieldAnim: 'GravityField', vectorType:'gravity',vectorForce:8}},
            {What:{RoundField:1},objData:{x:1800,y:-1100, radius:160, fieldAnim: 'GravityField', vectorType:'gentle',vectorForce:8}},
            {What:{RoundField:1},objData:{x:-1000,y:-400, radius:200, fieldAnim: 'OrbitalField', bounceType:'orbital',bounceForce1:2,bounceForce2:6}},
            {What:{RoundField:1},objData:{x:1400,y:-1300, radius:200, fieldAnim: 'OrbitalField', vectorType:'orbital',vectorForce:4,vectorForceAdd:4}},
            {What:{RoundField:1},objData:{x:-1300,y:-100, radius:80, fieldAnim: 'ShellField', bounceType:'gentle',bounceForce:5}},
            {What:{Star:1},objData:{x:-1300,y:-100}},
            {What:{RoundField:1},objData:{x:-1500,y:-150, radius:50, fieldAnim: 'ShellField', bounceType:'gentle',bounceForce:5}},
            {What:{Star:1},objData:{x:-1500,y:-150}},
            {What:{RoundField:1},objData:{x:-1700,y:-50, radius:50, fieldAnim: 'ShellField', bounceType:'gentle',bounceForce:1}},
            {What:{Star:1},objData:{x:-1700,y:-50}},
            {What:{J:1},objData:{x:-1000,y:600,angle:90,toDo:[{N:0,T:'sleeping',maxAlarm:0,straightMin:10,straightPlus:50}],AlarmLvl:0}},


            {What:{ConeField:1},objData:{x:50,y:-500, radius: 250, angle: 10, coneAngle: 40, coneRad2: 50, simpleFilling: 'rgba(255,255,0,0.6)', bounceType:'diagonal',bounceTeleport:true}},

            {What:{ConeField:1},objData:{x:50,y:-400, radius: 250, angle: 100, coneAngle: 30, coneRad2: 50, simpleFilling: 'rgba(255,255,0,0.6)', bounceType:'diagonal',bounceTeleport:true}},

            {What:{ConeField:1},objData:{x:-50,y:-400, radius: 250, angle: 230, coneAngle: 40, coneRad2: 50, simpleFilling: 'rgba(255,255,0,0.6)', bounceType:'diagonal',bounceTeleport:true}},

            {What:{ConeField:1},objData:{x:-50,y:-500, radius: 250, angle: 300, coneAngle: 30, coneRad2: 50, simpleFilling: 'rgba(255,255,0,0.6)', bounceType:'diagonal',bounceTeleport:true}},


            {What:{SquareField:1},objData:{x:-500,y:300, squareAngle: 90, squareLen: 300, squareWidth: 60, simpleFilling: 'rgba(255,255,0,0.6)', bounceType:'diagonal',bounceTeleport:true}},
            {What:{SquareField:1},objData:{x:-500,y:420, squareAngle: 86, squareLen: 303, squareWidth: 20, simpleFilling: 'rgba(255,255,0,0.6)', bounceType:'diagonal',bounceTeleport:true}},
            {What:{SquareField:1},objData:{x:7,y:400, squareAngle: 230, squareLen: 200, squareWidth: 100, simpleFilling: 'rgba(255,255,0,0.6)', bounceType:'diagonal',bounceTeleport:true}},

            {What:{SquareField:1},objData:{x:667,y:-67, squareAngle: 45, squareLen: 210, squareWidth: 30, simpleFilling: 'rgba(255,255,0,0.6)', bounceType:'diagonal',bounceTeleport:true}},
            {What:{ConeField:1},objData:{x:600,y:0, radius: 400, angle: 70, coneAngle: 120, coneRad2: 300, simpleFilling: 'rgba(255,255,0,0.6)', bounceType:'diagonal',bounceTeleport:true}},
            {What:{RoundField:1},objData:{x:600,y:0, radius:100, simpleFilling: 'rgba(255,255,0,0.6)', bounceType:'diagonal',bounceTeleport:true}},

            {What:{ConeField:1},objData:{x:2000,y:0, radius: 600, angle: 90, coneAngle: 170, coneRad2: 550, simpleFilling: 'rgba(0,180,0,0.6)', bounceType:'diagonal',bounceTeleport:true}},
            {What:{RoundField:1},objData:{x:2000,y:0, radius: 480, angle: 90, simpleFilling: 'rgba(0,180,0,0.6)', bounceType:'diagonal',bounceTeleport:true}},

            {What:{RoundField:1},objData:{x:-700,y:-67, radius:10, simpleFilling: 'rgba(155,155,255,0.8)', teleportOnHit: 'random', teleportOnHitDist: 500}},
            {What:{RoundField:1},objData:{x:-600,y:0, radius:10, simpleFilling: 'rgba(155,155,255,0.8)', teleportOnHit: 120,  teleportOnHitDist: 520, teleportOnHitDistPlus: 200}},
            {What:{RoundField:1},objData:{x:-700,y:67, radius:10, simpleFilling: 'rgba(155,155,255,0.8)', teleportOnHit: 'aligned', teleportOnHitDist: 1000}},


            {What:{RoundField:1},objData:{x:-600,y:-1200, radius:200, fieldAnim: 'DestructionField', PeriodDamage: 1, PeriodTime: 6, PeriodOffset: 20, dontHit:['B','BE']}},
            {What:{RoundField:1},objData:{x:-975,y:-905, radius:200, fieldAnim: 'ElectricityField', OneTimeEffect: 1, OneTimeOffset: 20, OneTimeDamage: 4, dontHit:['B','BE']}},
            {What:{RoundField:1},objData:{x:-600,y:-600, radius:200, fieldAnim: 'ShellField', PeriodDamage: 1, PeriodTime: 20, PeriodOffset: 20, SlowDownTo: 2, SlowDownBy: 3, dontHit:['E','P']}},

            {What:{RoundField:1},objData:{x:-910,y: 850, radius:60, fieldAnim: 'ElectricityField', OneTimeEffect: 1, OneTimeOffset: 20, OneTimeDamage: 4, dontHit:['B','BE']}},
            {What:{RoundField:1},objData:{x:-800,y: 1020, radius:60, fieldAnim: 'ElectricityField', OneTimeEffect: 1, OneTimeDamage: 4, dontHit:['B','BE']}},
            {What:{RoundField:1},objData:{x:-600,y: 1100, radius:60, fieldAnim: 'ElectricityField', OneTimeEffect: 1, OneTimeOffset: 20, OneTimeDamage: 4, dontHit:['B','BE']}},
            {What:{RoundField:1},objData:{x:-600,y: 800, radius:200, fieldAnim: 'HealingField', PeriodTime: 50, PeriodOffset: 5, PeriodHeal: 1, dontHit:['B','E','BE']}},

            {What:{LineOfMines:1},objData:{x:280, y:830, radius:500, angle: 45, distance: 80}},
            {What:{LineOfMines:1},objData:{x:480, y:830, radius:500, angle: 45, distance: 80}},
            {What:{LineOfMines:1},objData:{x:680, y:830, radius:500, angle: 45, distance: 80}},

            {What:{Gstar:1},objData:{x:-140,y:900,bounceType:'diagonal',bounceTeleport:true}},
            {What:{Gstar:1},objData:{x:140,y:900,bounceType:'diagonal',bounceTeleport:true}},
        ],
    },
    '*1':{
        MapRadius:60,MapRadius2:2400,
        BoardMods:['sitOnMap','allAvoid'],

        Place:[
            {Random:{X: 1000, Y: 1000, Radius: 200}, What:{Star: 20, A: 20}},
            {Random:{X: 1000, Y: -1000, Radius: 200}, What:{Star: 20, M: 10}},
            {Random:{X: -1000, Y: -1000, Radius: 100}, What:{Q: 10}},

            {What:{RoundField:1},objData:{x:0,y:-400, radius:200, fieldAnim: 'GravityField', bounceType:'gentle',bounceForce:1}},
            {What:{Gstar:1},objData:{x:-140,y:900,bounceType:'diagonal',}},
            {What:{Gstar:1},objData:{x:140,y:900,bounceType:'diagonal',}},

            {What:{J:1},objData:{x:0,y:600,angle:90,toDo:[{N:0,T:'sleeping',maxAlarm:0,straightMin:10,straightPlus:50}],AlarmLvl:0}},
            {What:{Star:1},objData:{x:100,y:600}},
            {What:{Star:1},objData:{x:100,y:640}},
            {What:{Star:1},objData:{x:100,y:680}},
            {What:{Star:1},objData:{x:100,y:720}},
            {What:{Star:1},objData:{x:100,y:760}},
            {What:{Star:1},objData:{x:100,y:800}},
        ],
    },
    '*A':{
        BoardMods:['sitOnMap','allAvoid'],
        Place:[
            {Random:{X: 200, Y: 200, Radius: 200}, What:{Star: 5, A: 25}},
        ],
    },
    '*I':{
        BoardMods:['sitOnMap','allAvoid'],
        Place:[
            {Random:{X: 200, Y: 200, Radius: 200}, What:{Star: 20, I: 20}},
        ],
    },
    '*D':{
        BoardMods:['sitOnMap','allAvoid'],
        Place:[
            {Random:{X: 200, Y: 200, Radius: 200}, What:{Star: 20, D: 10, M: 5, A: 5}},
        ],
    },
    '*M':{
        BoardMods:['sitOnMap'],
        Place:[
            {Random:{X: 200, Y: 200, Radius: 200}, What:{Star: 20, M: 15}},
        ],
    },
    'Start':{MapRadius:600,MapRadius2:2400,O:{ K:1, Star: 300}},
    'Q':{MapRadius:1000,MapRadius2:1000,O:{ Q: 3, Star: 10}},
    'U':{MapRadius:1200,MapRadius2:1800,O:{ A: 5, U: 10, Star: 10}},
    'T':{MapRadius:1000,MapRadius2:1000,O:{ T: 10, Star: 10}},
    'B':{MapRadius:1000,MapRadius2:1000,O:{ B: 115, Star: 10}},
    'N':{MapRadius:1000,MapRadius2:1000,O:{ N: 10, Star: 10}},
    'K':{MapRadius:1000,MapRadius2:1000,O:{ K: 5, A:15, Star: 10}},
    'C':{MapRadius:1000,MapRadius2:1000,O:{ C: 10, Star: 10}},
    'F':{MapRadius:1000,MapRadius2:1000,O:{ F: 10, Q:2, A:10, Star: 10}},
    'G':{MapRadius:1000,MapRadius2:1000,O:{ G:6, Star: 10}},
    'S':{MapRadius:1400,MapRadius2:1400,O:{ S: 10, Star: 10}},
    'J':{MapRadius:1100,MapRadius2:1100,O:{ J: 8, N: 1, K:2, Star: 10}},
    'V':{MapRadius:1100,MapRadius2:1100,O:{ V: 10, Star: 50}},
    'E':{MapRadius:1100,MapRadius2:1100,O:{ E: 10, Star: 10}},
    'H':{MapRadius:1100,MapRadius2:1100,O:{ H: 10, T:10, Star: 10}},
    'W':{MapRadius:1100,MapRadius2:1100,O:{ W: 10, K:2, Star: 10}},
    'R':{MapRadius:1500,MapRadius2:1800,O:{ R: 10, Star: 10}},
    'ShieldTest':{MapRadius:1500,MapRadius2:1500,GiveEnergyFields:25,O:{ F: 2, U:2, Q:1, T:2, K:1,C:1,B:1,N:1,M:1, A:5, Star: 20}},
    'SuperSecure':{MapRadius:1000,MapRadius2:1000,O:{ F: 10, K:10, Q:1, A:10, Star: 10}},
    'Followers':{MapRadius:2700,MapRadius2:3200,O:{  U:10, A:10, S:10, V:10, Star: 100}},
    'BigOnes':{MapRadius:2700,MapRadius2:3200,O:{  Q:10, F:10, K:10, D:10, G:10, J:10, W:10, Star: 100}},
    'HardCore':{MapRadius:2700,MapRadius2:3200,O:{ M:10, T:10, B:10, N:20, Q:4, U:10, A:12, K:10, F:10, C:10, G:4, S:10, D:10, J:6, V:10, E:10, H:10, R:10, W:4, I:10, Star: 100}},
};

SHIPpresets={
    1:{
        Weight: 25,
        lifeM: 6,
        life: 6,
        EnergyM: 20,
        SpeedM: 20,
        AmmoStorage: 20,
        Ammo: 0,
        ShowFireRange: false,
        ShowAmmoIndicator: true,
        GlueFireToEstimated: 100,
        GlueFireToLaser: 70,
        KeysModules:{69:[0]},
        FireType: 0,
        FireType2: 1,
        MouseDown1: false,
        MouseDown2: false,
        FireTypes:[
            {T:'single',  gunS:0,GunSpeed: 5, Speed: 17, Dec: 30, AmmoUse: 1, Power: 1},
            {T:'rose',    gunS:0,GunSpeed: 4, AtOnce: 9, AmmoUse: 5, RoseAngle: 3, Speed: 15, Dec: 30, Power: 1},
        ],
        Modules:[
            {T:'bulletProd',Disabled:0,Emin:2,Emax:4,ProdX:4,E:0,Prod:0,ifProd:40 },
        ],
    },
    3:{
        Weight: 25,
        lifeM: 6,
        EnergyFieldMax: 2,
        EnergyM: 20,
        SpeedM: 20,
        AmmoStorage: 50,
        Ammo: 0,
        BombStorage: 12,
        Bombs: 12,
        ShowFireRange: false,
        ShowAmmoIndicator: true,
        GlueFireToEstimated: 100,
        GlueFireToLaser: 70,
        KeysModules:{69:[0,1],82:[11],84:[2],81:[4],70:[5]},
        FireType: 0,
        FireType2: 4,
        MouseDown1: false,
        MouseDown2: false,
        FireTypes:[
            {T:'single',  gunS:0,GunSpeed: 5, Speed: 17, Dec: 30, AmmoUse: 1, Power: 1},
            {T:'double',  gunS:0,GunSpeed: 1, Speed: 15, Dec: 30, AmmoUse: 2, Power: 1},
            {T:'rose',    gunS:0,GunSpeed: 4, AtOnce: 9, AmmoUse: 5, RoseAngle: 3, Speed: 15, Dec: 30, Power: 1},
            {T:'bomb',    gunS:0,GunSpeed: 5, BombUse: 1, Speed: 10, Dec: 30, Power: 4, Dist: 80},
        ],
        Modules:[
            {T:'shieldProd',Disabled:0,Emin:0.1,Emax:1,ProdX:1,E:0,Prod:0,ifProd:90 },
            {T:'bulletProd',Disabled:0,Emin:2,Emax:4,ProdX:4,E:0,Prod:0,ifProd:40 },
            {T:'healerProd',Disabled:0,Emin:4,Emax:16,ProdX:1,E:0,Prod:0,ifProd:120 },
            {T:'bombProd',  Disabled:0,Emin:1,Emax:10,ProdX:1,E:0,Prod:0,ifProd:60 },
        ],
    },
    17:{
        Weight: 25,
        lifeM: 11,
        EnergyFieldMax: 22,
        EnergyM: 40,
        SpeedM: 20,
        AmmoStorage: 50,
        Ammo: 0,
        MissleStorage: 10,
        Missles: 10,
        BombStorage: 12,
        Bombs: 12,
        ShowFireRange: false,
        ShowAmmoIndicator: true,
        GlueFireToEstimated: 100,
        GlueFireToLaser: 70,
        ShowRadar: true,
        KeysModules:{69:[0,5],82:[11],84:[2],81:[4],70:[8]},
        FireType: 0,
        FireType2: 8,
        MouseDown1: false,
        MouseDown2: false,
        FireTypes:[
            {T:'single',  gunS:0,GunSpeed: 5, Speed: 17, Dec: 30, AmmoUse: 1, Power: 1},
            {T:'double',  gunS:0,GunSpeed: 1, Speed: 15, Dec: 30, AmmoUse: 2, Power: 1},
            {T:'rose',    gunS:0,GunSpeed: 4, AtOnce: 9, AmmoUse: 5, RoseAngle: 3, Speed: 15, Dec: 30, Power: 1},
            {T:'laser',   gunS:0,GunSpeed: 10, Speed: 650, Dec: 1, AmmoUse: 1, Power: 5},
            {T:'rose',    gunS:0,GunSpeed: 7, AtOnce: 37, AmmoUse: 10, RoseAngle: 5, Speed: 17, Dec: 12, Power: 1},
            {T:'missle',  gunS:0,GunSpeed: 2, MissleUse: 1, Speed: 12, SpeedT: 4, Dec: 400, AimRadius: 120, Power: 2},
            {T:'missleR', gunS:0,GunSpeed: 6, MissleUse: 5, Speed: 12, AtOnce: 8, SpeedT: 6, Dec: 95, AimRadius: 60, Power: 2},
            {T:'bomb',    gunS:0,GunSpeed: 5, BombUse: 1, Speed: 10, Dec: 30, Power: 4, Dist: 80},
            {T:'tele',    gunS:0,GunSpeed: 3, Speed: 400, Dec: 1},
        ],
        Modules:[
            {T:'shieldProd',Disabled:0,Emin:0.1,Emax:1,ProdX:1,E:0,Prod:0,ifProd:2 },
            {T:'spotRegion',Disabled:1,Emin:4,Emax:4,ProdX:1,E:0,Prod:0,ifProd:1 },
            {T:'teleProd',  Disabled:0,Emin:2,Emax:4,ProdX:4,E:0,Prod:0,ifProd:60, TeleLoad: 0, TeleLoadM: 6 },
            {T:'bulletProd',Disabled:0,Emin:2,Emax:4,ProdX:4,E:0,Prod:0,ifProd:40 },
            {T:'esteemProd',Disabled:1,Emin:1,Emax:1,ProdX:1,E:0,Prod:0,ifProd:9000 },
            {T:'healerProd',Disabled:0,Emin:4,Emax:16,ProdX:1,E:0,Prod:0,ifProd:90 },
            {T:'bombProd',  Disabled:0,Emin:1,Emax:10,ProdX:1,E:0,Prod:0,ifProd:60 },
            {T:'missleProd',Disabled:0,Emin:1,Emax:6,ProdX:4,E:0,Prod:0,ifProd:4 },
            {T:'laserProd', Disabled:1,Emin:2,Emax:4,ProdX:6,E:0,Prod:0,ifProd:240, LaserLoad: 0, LaserLoadM: 4 },
            {T:'bulletProd',Disabled:0,Emin:2,Emax:4,ProdX:4,E:0,Prod:0,ifProd:60 },
            {T:'bulletProd',Disabled:0,Emin:6,Emax:12,ProdX:4,E:0,Prod:0,ifProd:5 },
            {T:'radar',     Disabled:1,Emin:1,Emax:30,ProdX:20,E:0,Prod:0,ifProd:360,Radius:2500},
        ],
    },
}
</script>
<script type="text/javascript">
function MENUobject(){

    this.ShipPresetChoosen = 1;
     this.start = function(){
        this.makeMenuBoards();
        this.makeMenuShip();
        this.showMenu='Boards';
        $('.ToggleMenu').click(function(){ MENU.toggleMenu(); });
    }

    this.makeMenuBoards = function(){
        var html = '';
        html+='<div class="keys">';
            html+='<span>1-9 - change Fire Type</span>';
            html+='<span>P - pause</span>';
            html+='<span>ESC - end level</span>';
        html+='</div>';

        html+='<div class="ShipPresets"><span>Choose: </span>';
        for(var m in SHIPpresets)
            html+='<div class="chooseShipPresets" id="chooseShipPresets_'+m+'">'+m+'</div>';
        html+='</div>';

        for(var m in BOARDS)
            html+='<div class="MainMenuButton" id="MainMenuButton_'+m+'">'+m+'</div>';

        $('#Menu').append('<div id="MenuBoards">'+html+'</div>');

        $('.chooseShipPresets').unbind().click(function(){  MENU.click_chooseShipPresets( $(this).attr('id').split('_')[1] ); });
        $('#chooseShipPresets_'+this.ShipPresetChoosen).addClass('choosenPreset');


        $('.MainMenuButton').unbind().click(function(){  MENU.click_MainMenuButton( $(this).attr('id').split('_')[1] ); });
    }
    this.click_chooseShipPresets = function(id){
        $('.chooseShipPresets').removeClass('choosenPreset');
        $('#chooseShipPresets_'+id).addClass('choosenPreset');
        this.ShipPresetChoosen = id;
    }
    this.click_MainMenuButton = function(id){
        $('#Menu').hide();
        if(typeof GAME != 'undefined')
            delete GAME;
        if(typeof CanvasManager != 'undefined')
            delete CanvasManager;
        CanvasManager = new CanvasManagerObject();
        CanvasManager.start();
        GAME = new GAMEobject();
        GAME.start(BOARDS[id],cloneObj(SHIPpresets[this.ShipPresetChoosen]));
    }
    this.toggleMenu = function(){
        if(this.showMenu=='Ship')    this.hideMenuShip();
                else                this.showMenuShip();
    }
    this.hideMenuShip = function(){
        this.showMenu = 'Boards';
        $('#MenuShip').animate({left:'100%'},500);
    }
    this.showMenuShip = function(){
        this.showMenu = 'Ship';
        $('#MenuShip').animate({left:'12%'},500);
    }


    this.makeMenuShip = function(){
        var html = '';
        html+='<div id="moneyTable">'+this.money+'</div>';
        html+='<div id="shipTable"></div>';
        html+='<div id="upgradesTable"></div>';
        html+='<div class="ToggleMenu"></div>';
        $('#Menu').append('<div id="MenuShip" style="left: 100%;">'+html+'</div>');
        this.showUpgrades();
        this.showShipTable();
    }

    this.money = 999000;
    this.upgrades=[
        {K:1,T:'shipHull',price:250,attr:[{lifeM:1,Weight:5}]},
        {K:1,T:'shipHull',price:550,attr:[{lifeM:1,Weight:5}]},
        {K:1,T:'shipHull',price:750,attr:[{lifeM:1,Weight:5}]},
        {K:1,T:'shipHull',price:1000,attr:[{lifeM:1,Weight:5}]},
        {K:1,T:'energyGen',price:600,attr:[{EnergyM:2,Weight:5}]},
        {K:1,T:'energyGen',price:1200,attr:[{EnergyM:2,Weight:5}]},
        {K:1,T:'energyGen',price:1800,attr:[{EnergyM:2,Weight:5}]},
        {K:1,T:'energyGen',price:2400,attr:[{EnergyM:2,Weight:5}]},
        {K:1,T:'engine',price:2000,attr:[{EnergyEng:6,SpeedProduced:6,Weight:5}]},
        {K:1,T:'engine',price:4000,attr:[{EnergyEng:8,SpeedProduced:10,Weight:5}]},
        {K:1,T:'engine',price:6000,attr:[{EnergyEng:10,SpeedProduced:12,Weight:5}]},

        {K:2,T:'ammoStorage',price:500,attr:[{AmmoStorage:10,Weight:5}]},
        {K:2,T:'ammoStorage',price:800,attr:[{AmmoStorage:10,Weight:5}]},
        {K:2,T:'ammoStorage',price:1200,attr:[{AmmoStorage:10,Weight:5}]},
    ];

    this.SHIPempty={
        Weight: 20,
        lifeM: 1,
        EnergyM: 0,
        SpeedM: 0,
        AmmoStorage: 0,
        Ammo: 0,
        MissleStorage: 0,
        Missles: 0,
        BombStorage: 0,
        Bombs: 0,
        ShowFireRange: true,
        ShowAmmoIndicator: false,
        GlueFireToEstimated: false,
        GlueFireToLaser: false,
        ShowRadar: false,
        KeysModules:{},
        FireType: 0,
        FireType2: false,
        MouseDown1: false,
        MouseDown2: false,
        EnergyFieldMax: 0,
        FireTypes:[],
        Modules:[],
    };

    this.SHIP={};
    this.addedUpgrades={};

    this.showUpgrades = function(){
        var html='',up=['','','',''];
        for(var u in this.upgrades){
            var U = this.upgrades[u];
            up[U.K]+='<div class="upgrade upgradeClick" id="upgradeClick_'+u+'">'+U.T+'</div>';
        }
        for(var i=0; i < up.length; ++i)
            if(up[i]!='')
                html+='<div class="upgradesType" id="upgradesType_'+i+'"><div class="upgradesTitle">Upgr: '+i+'</div><div class="upgradesContent">'+up[i]+'</div></div>';
        $('#upgradesTable').html(html);
        $('.upgradesType').click(function(){ MENU.clickUpgradeTitle( $(this).attr('id').split('_')[1] );    });
        $('.upgradeClick').click(function(){ MENU.clickUpgrade( $(this).attr('id').split('_')[1] ); });
    }
    this.clickUpgradeTitle = function(id){
        $('.upgradesType').removeClass('wybrany');
        $('#upgradesType_'+id).addClass('wybrany');
    }
    this.showShipTable = function(){
        var html='';
        this.SHIP={};
        for(var e in this.SHIPempty){
            if(typeof this.SHIPempty[e] == 'array')    this.SHIP[e]=[];
            else if(typeof this.SHIPempty[e] == 'object')    this.SHIP[e]={};
            else this.SHIP[e] = this.SHIPempty[e];
        }
        var totPrice = 0;
        for(var u in this.addedUpgrades){
            var U = this.upgrades[u];
            totPrice -=- U.price;
            for(var a in U.attr){
                for(var e in U.attr[a]){
                    this.SHIP[ e ] -=- U.attr[a][e];
                }
            }
        }
        html+='Weight: '+this.SHIP.Weight+'<br/>';
        html+='Life: '+this.SHIP.lifeM+'<br/>';
        html+='Energy: '+this.SHIP.EnergyM+'<br/>';
        $('#moneyTable').html(this.money-totPrice);
        $('#shipTable').html(html);
    }
    this.clickUpgrade = function(id){
        if(typeof this.addedUpgrades[id] == 'undefined')  this.addUpgrade(id);
                        else                              this.removeUpgrade(id);
        this.showShipTable();
    }
    this.addUpgrade = function(id){
        this.addedUpgrades[id] = 1;
        $('#upgradeClick_'+id).addClass('on_ship');
    }
    this.removeUpgrade = function(id){
        delete this.addedUpgrades[id];
        $('#upgradeClick_'+id).removeClass('on_ship');
    }
}

function CanvasManagerObject(){
    this.C = {};

    this.start = function(){
        $('#CanvasPreviews').html('');

        this.renderNeeded();
        this.prepareDirectRenders();
    }

    this.canvasId = function(O){
        var ID = '';
        ID+=O.T+'_';
        if(O.viewLetter)         ID+=O.viewLetter+'_';
        // if(O.viewShape)         ID+=O.viewShape+'_';
        if(O.viewColor)         ID+=O.viewColor+'_';
        // if(O.viewXY)             ID+=O.viewXY+'_';
        if(O.viewLetterSize)    ID+=O.viewLetterSize+'_';
        if(O.viewGlobalAlpha)    ID+=O.viewGlobalAlpha+'_';
        if(O.viewAngle)         ID+=O.viewAngle+'_';
        if(typeof O.timeTick !='undefined')
                                ID+='frame_'+O.timeTick+'_';
        if(O.viewHitPattern && O.life < O.lifeM)
                                ID+='life_'+O.life+'_';
        return ID;
    }

    this.getCanvas = function(O){
        var ID = this.canvasId(O);
        return this.C[ID];
    }

    this.requestCanvas = function(o){
        var O = GAME.O[o];
        var ID = this.canvasId(O);

        var Canvas={Id:false,X:0,Y:0};
        if(typeof this.C[ID] != 'undefined'){
            Canvas = this.C[ID];
        } else {
            Canvas = this.addCanvas(ID,O);
        }

        GAME.O[o].canvasId = Canvas.Id;
        GAME.O[o].canvasX = Canvas.X;
        GAME.O[o].canvasY = Canvas.Y;
    }

    this.addCanvas = function(ID,O){
        var Canvas={Id:false,X:0,Y:0};
        var X2=100,Y2=100;

        if(O.viewXY)
            X2 = Y2 = O.viewXY;

        var X = Canvas.X = parseInt(X2/2);
        var Y = Canvas.Y = parseInt(Y2/2);


        if(O.viewLetterSizeYoffset)
            Y -=- O.viewLetterSizeYoffset;

        $('#CanvasPreviews').append('<canvas id="CanvasManager_'+ID+'" width="'+X2+'" height="'+Y2+'"></canvas>');
        Canvas.Id = document.getElementById('CanvasManager_'+ID);
        var CanCon = Canvas.Id.getContext('2d');

        if(O.viewGlobalAlpha){
            CanCon.globalAlpha = O.viewGlobalAlpha / 10;
        }

        var State = {};
        if(O.viewHitPattern && O.life < O.lifeM)
            State = this.getHitPattern(O.viewHitPattern, parseInt((O.life/O.lifeM)*100));

        if(typeof O.backgroundCircle != 'undefined'){
            CanCon.fillStyle = 'yellow';
            if(O.colorCircle) CanCon.fillStyle = 'rgba('+O.colorCircle[0]+','+O.colorCircle[1]+','+O.colorCircle[2]+','+O.colorCircle[3]+')';
            if(State.colorCircle) CanCon.fillStyle = 'rgba('+State.colorCircle[0]+','+State.colorCircle[1]+','+State.colorCircle[2]+','+State.colorCircle[3]+')';
            CanCon.beginPath();
            CanCon.arc(X, Y, O.backgroundCircle, 0, Math.PI*2, true);
            CanCon.fill();

        }

        if(typeof O.viewLetter != 'undefined'){
            CanCon.font = "bold "+O.viewLetterSize+"px Arial";
            CanCon.textAlign = 'center';
            CanCon.textBaseline = 'middle';
            CanCon.fillStyle = O.viewColor;
            CanCon.translate(X,Y);
            if(O.colorFill) CanCon.fillStyle = 'rgba('+O.colorFill[0]+','+O.colorFill[1]+','+O.colorFill[2]+','+O.colorFill[3]+')';
            if(State.colorFill) CanCon.fillStyle = 'rgba('+State.colorFill[0]+','+State.colorFill[1]+','+State.colorFill[2]+','+State.colorFill[3]+')';

            if(!isNaN(O.viewLetter)){
                CanCon.fillText(String.fromCharCode(O.viewLetter), 0, 0);
            }else{
                CanCon.fillText(O.viewLetter, 0, 0);
            }
        }

                    // 100:{letterAdd:'A',colorLetterAdd:[255,0,0,1],SizeLetterAdd:10,YOffsetLetterAdd:10},

        if(typeof State.letterAdd != 'undefined'){
            CanCon.font = "bold "+State.SizeLetterAdd+"px Arial";
            CanCon.textAlign = 'center';
            CanCon.textBaseline = 'middle';
            if(O.viewAngle)
                CanCon.rotate(-O.viewAngle*(Math.PI/180));
            if(State.colorLetterAdd) CanCon.fillStyle = 'rgba('+State.colorLetterAdd[0]+','+State.colorLetterAdd[1]+','+State.colorLetterAdd[2]+','+State.colorLetterAdd[3]+')';
            var Y7 = 0;
            if(State.YOffsetLetterAdd)
                Y7-=-State.YOffsetLetterAdd;

            if(!isNaN(State.letterAdd)){
                CanCon.fillText(String.fromCharCode(State.letterAdd), 0, Y7);
            }else{
                CanCon.fillText(State.letterAdd, 0, Y7);
            }
        }

        if(typeof O.viewLIBpath != 'undefined'){
            CanCon.fillStyle = O.viewColor;
            if(State.colorFill) CanCon.fillStyle = 'rgba('+State.colorFill[0]+','+State.colorFill[1]+','+State.colorFill[2]+','+State.colorFill[3]+')';

            var svgD='';
            var pathSize=O.viewPathSize/1000;
            var XYoffset = parseInt((X2 - O.viewPathSize)/2);
            var PATH = this.LIB[ O.viewLIBpath ];
            for(var s=0; s<PATH.length;++s)
                if(isNaN(PATH[s]))    svgD+=PATH[s]+' ';
                        else         svgD+=((PATH[s]*pathSize).toFixed(2))+' ';
            var svgObj = new Path2D(svgD);

            CanCon.translate(XYoffset,XYoffset);
            CanCon.fill(svgObj);
        }

        /*
        if(typeof O.viewShape != 'undefined'){
            CanCon.fillStyle = O.viewColor;
            var XYoffset = parseInt(X2/2);
            CanCon.beginPath();
            CanCon.arc(XYoffset,XYoffset, O.radius, 0, Math.PI*2, true);
            CanCon.fill();
        }
        */
        if(O.T=='bullet'){
            CanCon.font = "bold 10px Arial";
            CanCon.fillStyle = 'yellow';
            CanCon.textAlign = 'center';
            CanCon.textBaseline = 'middle';
            CanCon.fillText('i', 50, 50);
        }



        this.C[ID]=Canvas;
        return Canvas;
    }

    this.LIB={
        StarPath:['M',94,',',832,'C',163,',',755,234,',',681,309,',',611,'C',338,',',582,357,',',564,364,',',556,'C',340,',',553,272,',',537,160,',',509,'C',79,',',489,25,',',474,0,',',467,'L',84,',',213,'C',209,',',264,320,',',319,419,',',380,'C',396,',',225,384,',',98,384,',',0,'L',638,',',0,'C',638,',',69,626,',',197,600,',',383,'C',619,',',376,660,',',357,723,',',328,'C',809,',',288,888,',',255,961,',',227,'L',1036,',',485,'C',931,',',508,808,',',532,669,',',555,'L',840,',',748,'C',874,',',787,901,',',819,921,',',843,'L',703,',',990,'L',510,',',671,'C',452,',',774,385,',',884,310,',',1000,'z'],
    };

    this.neededRenders={
        hit:{
            viewLIBpath: 'StarPath', // *
            frames: 25,
            sizeX: 60,
            sizeY: 60,
            states:{
                0:{pathSize: 5, color: [255,255,255,1]},
                10:{pathSize: 15, color: [255,255,0,1]},
                24:{pathSize: 30, color: [255,0,0,1]},
            }
        },
        hit_blue:{
            viewLIBpath: 'StarPath', // *
            frames: 25,
            sizeX: 60,
            sizeY: 60,
            states:{
                0:{pathSize: 5, color: [255,255,255,1]},
                10:{pathSize: 15, color: [173,216,230,1]},
                24:{pathSize: 30, color: [0,0,255,1]},
            }
        },
        hit_energyField:{
            viewLIBpath: 'StarPath', // *
            frames: 25,
            sizeX: 60,
            sizeY: 60,
            states:{
                0:{pathSize: 5, color: [0,255,0,1]},
                10:{pathSize: 15, color: [128,255,128,1]},
                24:{pathSize: 30, color: [255,255,255,1]},
            }
        },
        hitBig:{
            viewLIBpath: 'StarPath', // *
            frames: 21,
            sizeX: 140,
            sizeY: 140,
            states:{
                0:{pathSize: 5, color: [255,255,255,1]},
                10:{pathSize: 80, color: [255,255,0,1]},
                20:{pathSize: 120, color: [255,0,0,1]},
            }
        },
        hit_healing:{
            viewLIBpath: 'StarPath', // *
            frames: 25,
            sizeX: 30,
            sizeY: 30,
            states:{
                0:{pathSize: 5, color: [128,255,128,1]},
                12:{pathSize: 12, color: [0,255,0,1]},
                24:{pathSize: 20, color: [0,128,0,1]},
            }
        },
        explosion_35:{
            viewLIBpath: 'StarPath', // *
            frames: 25,
            sizeX: 80,
            sizeY: 80,
            smallStars: 6,
            states:{
                0:{pathSize: 10, circleRadius: 5, color: [255,255,255,1], color2: [255,255,255,1], smallStarSize: 5, color3: [255,255,255,1]},
                3:{pathSize: 27, circleRadius: 13, color: [255,255,128,1], color2: [255,255,128,1], smallStarSize: 15, color3: [255,255,0,1]},
                7:{pathSize: 45, circleRadius: 20, color: [255,255,0,1], color2: [255,255,0,0.5], smallStarSize: 25, color3: [255,0,0,1]},
                14:{pathSize: 78, circleRadius: 35, color: [255,0,0,1], color2: [255,0,0,1]},
                24:{pathSize: 78, circleRadius: 35, color: [128,0,0,0.3], color2: [128,0,0,0]},
            }
        },
        explosion_80:{
            viewLIBpath: 'StarPath', // *
            frames: 25,
            sizeX: 180,
            sizeY: 180,
            smallStars: 6,
            states:{
                0:{pathSize: 10, circleRadius: 5, color: [255,255,255,1], color2: [255,255,255,1], smallStarSize: 10, color3: [255,255,255,1]},
                3:{pathSize: 50, circleRadius: 25, color: [255,255,128,1], color2: [255,255,128,1], smallStarSize: 25, color3: [255,255,0,1]},
                7:{pathSize: 90, circleRadius: 40, color: [255,255,0,1], color2: [255,255,0,0.5], smallStarSize: 40, color3: [255,0,0,1]},
                14:{pathSize: 176, circleRadius: 80, color: [255,0,0,1], color2: [255,0,0,1]},
                24:{pathSize: 176, circleRadius: 80, color: [128,0,0,0.3], color2: [128,0,0,0]},
            }
        },
        explosion_120:{
            viewLIBpath: 'StarPath', // *
            frames: 25,
            sizeX: 260,
            sizeY: 260,
            smallStars: 6,
            states:{
                0:{pathSize: 10, circleRadius: 5, color: [255,255,255,1], color2: [255,255,255,1], smallStarSize: 10, color3: [255,255,255,1]},
                3:{pathSize: 65, circleRadius: 30, color: [255,255,128,1], color2: [255,255,128,1], smallStarSize: 45, color3: [255,255,0,1]},
                7:{pathSize: 120, circleRadius: 50, color: [255,255,0,1], color2: [255,255,0,0.5], smallStarSize: 80, color3: [255,0,0,1]},
                14:{pathSize: 250, circleRadius: 120, color: [255,0,0,1], color2: [255,0,0,1]},
                24:{pathSize: 250, circleRadius: 120, color: [128,0,0,0.3], color2: [128,0,0,0]},
            }
        },
        explosion_210:{
            viewLIBpath: 'StarPath', // *
            frames: 25,
            sizeX: 460,
            sizeY: 460,
            smallStars: 6,
            states:{
                0:{pathSize: 10, circleRadius: 5, color: [255,255,255,1], color2: [255,255,255,1], smallStarSize: 10, color3: [255,255,255,1]},
                3:{pathSize: 115, circleRadius: 65, color: [255,255,128,1], color2: [255,255,128,1], smallStarSize: 65, color3: [255,255,0,1]},
                7:{pathSize: 220, circleRadius: 125, color: [255,255,0,1], color2: [255,255,0,0.5], smallStarSize: 120, color3: [255,0,0,1]},
                14:{pathSize: 450, circleRadius: 210, color: [255,0,0,1], color2: [255,0,0,1]},
                24:{pathSize: 450, circleRadius: 210, color: [128,0,0,0.3], color2: [128,0,0,0]},
            }
        },
        des_field:{
            viewLIBpath: 'StarPath', // *
            frames: 60,
            sizeX: 70,
            sizeY: 70,
            states:{
                0:{pathSize: 5, color: [255,0,0,0.8]},
                20:{pathSize: 30, color: [255,0,0,0.4]},
                60:{pathSize: 70, color: [255,0,0,0]},
            }
        },
        grav_field:{
            viewLetter: 'G',
            frames: 20,
            sizeX: 50,
            sizeY: 50,
            states:{
                0:{fontSize: 50, color: [30,30,30,0.8]},
                10:{fontSize: 15, color: [30,30,30,0.8]},
                20:{fontSize: 10, color: [100,100,100,0.8]},
            }
        },
        wind_field:{
            viewLetter: 'W',
            frames: 40,
            sizeX: 30,
            sizeY: 30,
            states:{
                0:{fontSize: 5, color: [30,30,30,0.2]},
                20:{fontSize: 25, color: [100,100,100,0.4]},
                40:{fontSize: 5, color: [30,30,30,0.2]},
            }
        },
        ele_field:{
            viewLetter: 8623,    // pr�d
            frames: 40,
            sizeX: 40,
            sizeY: 40,
            states:{
                0:{fontSize: 5, color: [0,120,255,0.2]},
                20:{fontSize: 35, color: [0,120,255,0.7]},
                40:{fontSize: 5, color: [0,120,255,0,0.2]},
            }
        },
        heal_field:{
            viewLetter: '+',
            frames: 40,
            sizeX: 50,
            sizeY: 50,
            states:{
                0:{fontSize: 5, color: [0,255,0,0.2]},
                20:{fontSize: 50, color: [0,255,0,0.7]},
                40:{fontSize: 10, color: [0,255,0,1]},
            }
        },
    };

    this.renderNeeded = function(){
        var R;
        for(var nR in this.neededRenders){
            R = this.neededRenders[nR];
            var X2 = R.sizeX, Y2 = R.sizeY;
            var X1 = parseInt(X2/2), Y1 = parseInt(Y2/2);
            var X = X1, Y = Y1;

            // prepare full states array
            var LastSeen = false;
            var T = [];
            for(var i in R.states)
                T[ T.length ]=i;
            for(var i=0; i<T.length-1; ++i){
                var t1 = T[i];
                var t2 = T[i- -1];
                for(var j=t1- -1; j<t2; ++j){
                    var State = {};
                    for(var si in R.states[t1]){
                        if(typeof R.states[t2][si] == 'undefined'){
                            State[si]=R.states[t1][si];
                        }else if(si.substr(0,5)=='color'){
                            State[si]=[];
                            for(var k=0; k<3; ++k)
                                State[si][k] = R.states[t1][si][k]- -parseInt((R.states[t2][si][k]-R.states[t1][si][k]) * ((j-t1) / (t2-t1)));
                            State[si][3] = R.states[t1][si][3]- -((R.states[t2][si][3]-R.states[t1][si][3]) * ((j-t1) / (t2-t1)));
                        }else{
                            State[si] = R.states[t1][si]- -parseInt((R.states[t2][si]-R.states[t1][si]) * ((j-t1) / (t2-t1)));
                        }
                    }
                    R.states[j]=State;
                }
            }

            if(typeof R.smallStars !='undefined'){
                var SS=[];
                for(var i=0; i<R.smallStars; ++i){
                    var Radi = Math.random()*(R.sizeX/5)- -(R.sizeX/8);
                    var Angle = Math.random()*2*Math.PI;
                    SS[i]={};
                    SS[i].x = parseInt(Math.cos(Angle)*Radi);
                    SS[i].y = parseInt(Math.sin(Angle)*Radi);
                }
                R.smallStars = SS;
            }


            // make renders of states
            for(var i=0; i<R.frames; ++i){
                var ID = nR+'_frame_'+i+'_';
                var Canvas={Id:false,X:X1,Y:Y1};
                $('#CanvasPreviews').append('<canvas id="CanvasManager_'+ID+'" width="'+X2+'" height="'+Y2+'"></canvas>');
                Canvas.Id = document.getElementById('CanvasManager_'+ID);
                var CanCon = Canvas.Id.getContext('2d');

                if(R.states[i].Yoffset)
                    Y = parseInt(Y2/2)- R.states[i].Yoffset;

                if(GET['DEBUG']){ CanCon.strokeStyle='white'; CanCon.beginPath();    CanCon.moveTo(0,Y1); CanCon.lineTo(X2,Y1); CanCon.stroke(); CanCon.beginPath();    CanCon.moveTo(X1,0); CanCon.lineTo(X1,Y2); CanCon.stroke(); }



                if(typeof R.states[i].circleRadius != 'undefined'){
                    CanCon.save();
                    CanCon.fillStyle = "rgba("+R.states[i].color2[0]+","+R.states[i].color2[1]+","+R.states[i].color2[2]+","+R.states[i].color2[3]+")";
                    CanCon.beginPath();
                    CanCon.arc(X1,Y,R.states[i].circleRadius,0,Math.PI*2,true);
                    CanCon.fill();
                    CanCon.restore();
                }

                if(typeof R.viewLetter != 'undefined'){
                    CanCon.save();
                    CanCon.font = "bold "+R.states[i].fontSize+"px Arial";
                    CanCon.textAlign = 'center';
                    CanCon.textBaseline = 'middle';
                    CanCon.fillStyle = "rgba("+R.states[i].color[0]+","+R.states[i].color[1]+","+R.states[i].color[2]+","+R.states[i].color[3]+")";
                    if(!isNaN(R.viewLetter)){
                        CanCon.fillText(String.fromCharCode(R.viewLetter), X1, Y);
                    }else{
                        CanCon.fillText(R.viewLetter, X1, Y);
                    }
                    CanCon.restore();
                }
                if(typeof R.viewLIBpath != 'undefined'){
                    var svgD='';
                    var pathSize=R.states[i].pathSize/1000;
                    var XYoffset = parseInt((X2 - R.states[i].pathSize)/2);
                    var PATH = this.LIB[ R.viewLIBpath ];
                    for(var s=0; s<PATH.length;++s)
                        if(isNaN(PATH[s]))    svgD+=PATH[s]+' ';
                                else         svgD+=((PATH[s]*pathSize).toFixed(2))+' ';
                    var svgObj = new Path2D(svgD);
                    CanCon.save();
                    CanCon.translate(XYoffset,XYoffset);
                    CanCon.fillStyle = "rgba("+R.states[i].color[0]+","+R.states[i].color[1]+","+R.states[i].color[2]+","+R.states[i].color[3]+")";
                    CanCon.fill(svgObj);
                    CanCon.restore();
                }

                if(typeof R.smallStars != 'undefined'){
                    for(var mi=0; mi<R.smallStars.length; ++mi){
                        var svgD='';
                        var pathSize=R.states[i].smallStarSize/1000;
                        var XYoffset = parseInt((X2 - R.states[i].pathSize)/2);
                        var PATH = this.LIB['StarPath'];
                        for(var s=0; s<PATH.length;++s)
                            if(isNaN(PATH[s]))    svgD+=PATH[s]+' ';
                                    else         svgD+=((PATH[s]*pathSize).toFixed(2))+' ';
                        CanCon.save();
                        CanCon.translate(((X2 - R.states[i].smallStarSize)/2)- -R.smallStars[mi].x, ((Y2 - R.states[i].smallStarSize)/2)- -R.smallStars[mi].y);
                        var svgObj = new Path2D(svgD);
                        CanCon.fillStyle = "rgba("+R.states[i].color[0]+","+R.states[i].color[1]+","+R.states[i].color[2]+","+R.states[i].color[3]+")";
                        CanCon.fill(svgObj);
                        CanCon.restore();
                    }
                }


                this.C[ID]=Canvas;
            }
        }

        // delete(this.neededRenders);
    }

    this.directRenders={
        TP_track:{
            frames: 18,
            states:{
                0:{ width: 1, color: [0,0,255,1]},
                8:{ width: 4, color: [128,128,255,1]},
                17:{ width: 2, color: [255,255,255,1]}
            },
        },
        laserShoot:{
            frames: 12,
            states:{
                0:{ width2: 2, color2: [0,0,255,1], color: [0,0,0,0], width: 4},
                5:{ width2: 8, color2: [128,128,255,1], color: [255,255,255,0.5], width: 10},
                11:{ width2: 4, color2: [255,255,255,1], color: [255,255,255,0.1], width: 12}
            },
        },
        DestrFieldStart:{
            frames: 15,
            states:{
                0:{color:[255,0,0,0]},
                15:{color:[255,0,0,0.3]},
            },
            onEnd:'DestrFieldGoing',
            makeParticles:7,
            particleId:'des_field',
            particleTime:59,
            particleXY: 35,
            particleAnim:'randomMove',
        },
        DestrFieldGoing:{
            color:[255,0,0,0.3],
            makeParticles:60,
            particleId:'des_field',
            particleTime:59,
            particleXY: 35,
            particleAnim:'randomMove',
            onExpire:'DestrFieldEnd',
            toExpire:50,
        },
        DestrFieldEnd:{
            frames: 50,
            states:{
                0:{color:[255,0,0,0.3]},
                37:{color:[255,0,0,0.1]},
                50:{color:[255,0,0,0]},
            },
        },
        GravFieldStart:{
            frames: 15,
            gradientStops: 4,
            states:{
                0:{color0:[180,180,255,0],        color1:[180,180,180,0],        color2:[180,180,180,0],        color3:[0,0,0,0],    stop0:0,stop1:0.1,stop2:0.2,stop3:1},
                15:{color0:[180,180,255,0.2],    color1:[180,180,180,0.1],    color2:[180,180,180,0.1],    color3:[0,0,0,0],    stop0:0.15,stop1:0.85,stop2:1,stop3:1},
            },
            onEnd:'GravFieldGoing',
            makeParticles:30,
            particleId:'grav_field',
            particleTime:19,
            particleXY: 25,
            particleAnim:'toCenter',
        },
        GravFieldGoing:{
            gradientStops: 4,
            color0:[180,180,255,0.2],    color1:[180,180,180,0.1],    color2:[180,180,180,0.1],    color3:[0,0,0,0],    stop0:0.15,stop1:0.85,stop2:1,stop3:1,
            makeParticles:40,
            particleId:'grav_field',
            particleTime:19,
            particleXY: 25,
            particleAnim:'toCenter',
            onExpire:'GravFieldEnd',
            toExpire:50,
        },
        GravFieldEnd:{
            frames: 50,
            gradientStops: 4,
            states:{
                0:{color0:[180,180,255,0.2],    color1:[180,180,180,0.1],    color2:[180,180,180,0.1],    color3:[0,0,0,0],    stop0:0.15,stop1:0.85,stop2:1,stop3:1},
                40:{color0:[180,180,255,0.2],    color1:[180,180,180,0.1],    color2:[180,180,180,0.1],    color3:[0,0,0,0],    stop0:0.7,stop1:1,stop2:1,stop3:1},
                50:{color0:[180,180,255,0],        color1:[180,180,180,0],        color2:[180,180,180,0],        color3:[0,0,0,0],    stop0:1,stop1:1,stop2:1,stop3:1},
            },
        },
        OrbFieldStart:{
            frames: 15,
            gradientStops: 4,
            states:{
                0:{color0:[180,180,255,0],        color1:[180,180,180,0],        color2:[180,180,180,0],        color3:[0,0,0,0],    stop0:0,stop1:0.1,stop2:0.2,stop3:1},
                15:{color0:[180,180,255,0.2],    color1:[180,180,180,0.1],    color2:[180,180,180,0.1],    color3:[0,0,0,0],    stop0:0.15,stop1:0.85,stop2:1,stop3:1},
            },
            onEnd:'OrbFieldGoing',
            makeParticles:30,
            particleId:'wind_field',
            particleTime:30,
            particleXY: 15,
            particleAnim:'onOrbit',
        },
        OrbFieldGoing:{
            gradientStops: 4,
            color0:[180,180,255,0.2],    color1:[180,180,180,0.1],    color2:[180,180,180,0.1],    color3:[0,0,0,0],    stop0:0.15,stop1:0.85,stop2:1,stop3:1,
            makeParticles:40,
            particleId:'wind_field',
            particleTime:30,
            particleXY: 15,
            particleAnim:'onOrbit',
            onExpire:'OrbFieldEnd',
            toExpire:50,
        },
        OrbFieldEnd:{
            frames: 50,
            gradientStops: 4,
            states:{
                0:{color0:[180,180,255,0.2],    color1:[180,180,180,0.1],    color2:[180,180,180,0.1],    color3:[0,0,0,0],    stop0:0.15,stop1:0.85,stop2:1,stop3:1},
                40:{color0:[180,180,255,0.2],    color1:[180,180,180,0.1],    color2:[180,180,180,0.1],    color3:[0,0,0,0],    stop0:0.7,stop1:1,stop2:1,stop3:1},
                50:{color0:[180,180,255,0],        color1:[180,180,180,0],        color2:[180,180,180,0],        color3:[0,0,0,0],    stop0:1,stop1:1,stop2:1,stop3:1},
            },
        },
        WindFieldStart:{
            frames: 15,
            states:{
                0:{color:[80,80,80,0]},
                15:{color:[80,80,80,0.2]},
            },
            onEnd:'WindFieldGoing',
            makeParticles:30,
            particleId:'wind_field',
            particleTime:30,
            particleXY: 15,
            particleAnim:'withWind',
        },
        WindFieldGoing:{
            color:[80,80,80,0.2],
            makeParticles:80,
            particleId:'wind_field',
            particleTime:30,
            particleXY: 15,
            particleAnim:'withWind',
            onExpire:'WindFieldEnd',
            toExpire:20,
        },
        WindFieldEnd:{
            frames: 20,
            states:{
                0:{color:[80,80,80,0.2]},
                20:{color:[80,80,80,0]},
            },
        },
        ShellFieldStart:{
            frames: 15,
            gradientStops: 3,
            states:{
                0:{color0:[255,255,0,0],    color1:[255,255,0,0.4],    color2:[255,255,0,0],    stop0:0.1,stop1:0.3,stop2:1},
                15:{color0:[255,255,0,0.1],    color1:[255,255,0,0.8],    color2:[255,255,0,0.2],    stop0:0.60,stop1:1,stop2:1},
            },
            onEnd:'ShellFieldGoing',
        },
        ShellFieldGoing:{
            gradientStops: 3,
            color0:[255,255,0,0.05],    color1:[255,255,0,0.3],    color2:[255,255,0,0.2],    stop0:0.60,stop1:1,stop2:1,
            onExpire:'ShellFieldEnd',
            toExpire:20,
        },
        ShellFieldEnd:{
            frames: 20,
            gradientStops: 3,
            states:{
                0:{color0:[255,255,0,0.1],    color1:[255,255,0,0.8],    color2:[255,255,0,0.2],    stop0:0.75,stop1:1,stop2:1},
                40:{color0:[255,255,0,0.2],    color1:[255,255,0,0.1],    color2:[255,255,0,0.1],    stop0:0.7,stop1:1,stop2:1},
                50:{color0:[255,255,0,0],    color1:[255,255,0,0],    color2:[255,255,0,0],    stop0:1,stop1:1,stop2:1},
            },
        },
        EleFieldStart:{
            frames: 15,
            gradientStops: 3,
            states:{
                0:{color0:[0,120,255,0],    color1:[0,120,255,0.4],    color2:[0,120,255,0],    stop0:0.1,stop1:0.3,stop2:1},
                15:{color0:[0,120,255,0.1],    color1:[0,120,255,0.6],    color2:[0,120,255,0.2],    stop0:0.3,stop1:1,stop2:1},
            },
            makeParticles:80,
            particleId:'ele_field',
            particleTime:30,
            particleXY: 20,
            particleAnim:'randomMove',
            particleAnimAngle: 'withDirection',
            onEnd:'EleFieldGoing',
        },
        EleFieldGoing:{
            gradientStops: 3,
            color0:[0,120,255,0.05],    color1:[0,120,255,0.6],    color2:[0,120,255,0.2],    stop0:0.3,stop1:1,stop2:1,
            makeParticles:80,
            particleId:'ele_field',
            particleTime:30,
            particleXY: 20,
            particleAnim:'randomMove',
            particleAnimAngle: 'withDirection',
            onExpire:'EleFieldEnd',
            toExpire:20,
        },
        EleFieldEnd:{
            frames: 25,
            gradientStops: 4,
            states:{
                0:{color0:[0,120,255,0.1],    color1:[0,120,255,0.6],    color2:[0,120,255,0.2],    color3:[0,0,0,0], stop0:0.3,stop1:1,stop2:1,stop3:1},
                12:{color0:[0,120,255,0.2],    color1:[0,120,255,0.1],    color2:[0,120,255,0.1],    color3:[0,0,0,0], stop0:0.2,stop1:0.4,stop2:0.6,stop3:0.6},
                25:{color0:[0,120,255,0],    color1:[0,120,255,0],    color2:[0,120,255,0],    color3:[0,0,0,0], stop0:0.1,stop1:0.1,stop2:0.2,stop3:0.2},
            },
        },
        HealFieldStart:{
            frames: 15,
            gradientStops: 3,
            states:{
                0:{color0:[0,255,0,0],    color1:[0,0,0,0], color2:[0,0,0,0],    stop0:0.1,stop1:0.1,stop2:0.2},
                15:{color0:[100,255,100,0.4], color1:[100,255,100,0.1], color2:[0,0,0,0], stop0: 0, stop1: 0.8, stop2: 1},
            },
            makeParticles:80,
            particleId:'heal_field',
            particleTime:30,
            particleXY: 25,
            particleAnim:'randomMove',
            particleAnimAngle: 'noRotation',
            onEnd:'HealFieldGoing',
        },
        HealFieldGoing:{
            gradientStops: 2,
            color0:[100,255,100,0.4], color1:[100,255,100,0.1], stop0: 0, stop1: 0.8,
            makeParticles:80,
            particleId:'heal_field',
            particleTime:30,
            particleXY: 25,
            particleAnim:'randomMove',
            particleAnimAngle: 'noRotation',
            onExpire:'HealFieldEnd',
            toExpire:20,
        },
        HealFieldEnd:{
            frames: 25,
            gradientStops: 3,
            states:{
                0:{color0:[100,255,100,0.4], color1:[100,255,100,0.1], color2:[0,0,0,0], stop0: 0, stop1: 0.8, stop2: 1},
                25:{color0:[0,255,0,0],    color1:[0,0,0,0], color2:[0,0,0,0],    stop0:0.1,stop1:0.1,stop2:0.2},
            },
        },
    };
    this.prepareDirectRenders = function(){
        var nR,R,i,j,k,T,t1,t2,si,State;
        for(nR in this.directRenders){
            R = this.directRenders[nR];
            T = [];
            for(i in R.states){
                T[ T.length ]=i;
            }
            for(i=0; i<T.length-1; ++i){
                t1 = T[i];
                t2 = T[i- -1];
                for(j=t1- -1; j<t2; ++j){
                    State = {};
                    for(si in R.states[t1]){
                        if(si.substr(0,5)!='color')
                            State[si] = R.states[t1][si]- -((R.states[t2][si]-R.states[t1][si]) * ((j-t1) / (t2-t1)));
                        else{
                            State[si]=[];
                            for(k=0; k<3; ++k)
                                State[si][k] = R.states[t1][si][k]- -parseInt((R.states[t2][si][k]-R.states[t1][si][k]) * ((j-t1) / (t2-t1)));
                                State[si][3] = R.states[t1][si][3]- -(R.states[t2][si][3]-R.states[t1][si][3]) * ((j-t1) / (t2-t1));
                        }
                    }
                    R.states[j]=State;
                }
            }
        }
    }

    this.directRender = function(CanCon,O){
        var P = GAME.O[0];
        var AnimData = O.Data;
        var Frame = O.timeTick;
        if(Frame < 0) return 1;
        var Type = O.T;
        var StyleData = this.directRenders[Type];

        if(Type=='TP_track' || Type=='laserShoot'){
            CanCon.save();
            CanCon.lineCap = 'round';
            CanCon.strokeStyle = 'rgba('+StyleData.states[Frame].color[0]+','+StyleData.states[Frame].color[1]+','+StyleData.states[Frame].color[2]+','+StyleData.states[Frame].color[3]+')';
            CanCon.lineWidth = StyleData.states[Frame].width;
            if(O.pathD){
                var pe = new Path2D( this.build_path2D(O.pathD) );
                CanCon.stroke(pe);
            } else{
                CanCon.beginPath();
                CanCon.moveTo(AnimData.X1 -P.x- -(GAME.Dx/2).toFixed(0), AnimData.Y1 -P.y- -(GAME.Dy/2).toFixed(0));
                CanCon.lineTo(AnimData.X2 -P.x- -(GAME.Dx/2).toFixed(0), AnimData.Y2 -P.y- -(GAME.Dy/2).toFixed(0));
                CanCon.stroke();
            }
            CanCon.restore();
        }

        if(Type=='laserShoot'){
            CanCon.save();
            CanCon.lineCap = 'round';
            CanCon.strokeStyle = 'rgba('+StyleData.states[Frame].color2[0]+','+StyleData.states[Frame].color2[1]+','+StyleData.states[Frame].color2[2]+','+StyleData.states[Frame].color2[3]+')';
            CanCon.lineWidth = StyleData.states[Frame].width2;
            if(O.pathD){
                var pe = new Path2D( this.build_path2D(O.pathD) );
                CanCon.stroke(pe);
            } else{
                CanCon.beginPath();
                CanCon.moveTo(AnimData.X1 -P.x- -(GAME.Dx/2).toFixed(0), AnimData.Y1 -P.y- -(GAME.Dy/2).toFixed(0));
                CanCon.lineTo(AnimData.X2 -P.x- -(GAME.Dx/2).toFixed(0), AnimData.Y2 -P.y- -(GAME.Dy/2).toFixed(0));
                CanCon.stroke();
            }
            CanCon.restore();
        }
    }

    this.build_path2D = function(path){
        var P = GAME.O[0];
        var string = '';

        for(var i=0; i<path.length; ++i){
            if(typeof (path[i])== 'string'){
                string+=path[i]+' ';
            } else {
                string+=(path[i].x -P.x- -(GAME.Dx/2).toFixed(0))+' '+(path[i].y -P.y- -(GAME.Dy/2).toFixed(0))+' ';
            }
        }
        return string;
    }

    this.HitPatterns ={
        HullFire_20:{
            100:{},
            99:{letterAdd:'A',colorLetterAdd:[255,40,0,1],SizeLetterAdd:5,YOffsetLetterAdd:10},
            1:{letterAdd:'A',colorLetterAdd:[255,40,0,1],SizeLetterAdd:25,YOffsetLetterAdd:20},
            0:{colorFill:[68,68,68,1]},
        },
        HullFire_40:{
            100:{},
            99:{letterAdd:'A',colorLetterAdd:[255,40,0,1],SizeLetterAdd:5,YOffsetLetterAdd:10},
            1:{letterAdd:'A',colorLetterAdd:[255,40,0,1],SizeLetterAdd:40,YOffsetLetterAdd:20},
            0:{colorFill:[68,68,68,1]},
        },
        HullFire_80:{
            100:{},
            99:{letterAdd:'A',colorLetterAdd:[255,40,0,1],SizeLetterAdd:10,YOffsetLetterAdd:35},
            1:{letterAdd:'A',colorLetterAdd:[255,40,0,1],SizeLetterAdd:65,YOffsetLetterAdd:35},
            0:{colorFill:[68,68,68,1]},
        },
        StarHit:{
            100:{colorFill:[255,255,255,1]},
            60:{colorFill:[255,255,0,1]},
            1:{colorFill:[255,0,0,1]},
            0:{colorFill:[68,68,68,1]}
        },
        ShieldBlobHit:{
            100:{colorCircle:[0,200,100,1],colorFill:[0,255,200,1]},
            1:{colorCircle:[0,200,100,0.2],colorFill:[0,255,200,0.1]},
            0:{colorCircle:[0,200,100,0.2],colorFill:[0,255,200,0.1]}
        },
    };
    this.getHitPattern = function(HitPat,percent){
        var R = this.HitPatterns[HitPat];
        var LastSeen = false;
        var t1 = 0;
        var t2 = 100;
        percent = parseInt(percent);
        for(var I in R){
            if(parseInt(I) <= percent && parseInt(I) >= t1) t1 = parseInt(I);
            if(parseInt(I) >= percent && parseInt(I) <= t2) t2 = parseInt(I);
        }
        if(t1==t2) return R[t1];

        var State = {};
        for(var si in R[t1]){
            if(si.substr(0,5)=='color'){
                State[si]=[];
                for(var k=0; k<3; ++k)
                    State[si][k] = R[t1][si][k]- -parseInt((R[t2][si][k]-R[t1][si][k]) * ((percent-t1) / (t2-t1)));
                State[si][3] = R[t1][si][3]- -(R[t2][si][3]-R[t1][si][3]) * ((percent-t1) / (t2-t1));
            }else if(si.substr(0,6)=='letter'){
                State[si] = R[t1][si];
            }else{
                State[si] = R[t1][si]- -((R[t2][si]-R[t1][si]) * ((percent-t1) / (t2-t1)));
            }
        }
        return State;
    }

    this.regionAnim = function(CanCon,O){
        var P = GAME.O[0];
        var Px = (-P.x- -(GAME.Dx/2));
        var Py = (-P.y- -(GAME.Dy/2));
        var AD = O.animData;
        var DR = this.directRenders[ O.animType ];
        var Radi = Math.PI*2/360;

        if(O.TT=='regionAnim'){
            // Kolor koka
            var BU = DR;
            if(DR.frames) BU = DR.states[ O.animTick ];
            CanCon.save();
            if(DR.gradientStops){
                var Gradient = CanCon.createRadialGradient(O.x- -Px, O.y- -Py, 0, O.x- -Px, O.y- -Py, O.radius);
                for(var i=0; i<DR.gradientStops; ++i)
                    Gradient.addColorStop(BU['stop'+i],'rgba('+BU['color'+i][0]+','+BU['color'+i][1]+','+BU['color'+i][2]+','+BU['color'+i][3]+')');
                CanCon.fillStyle = Gradient;
            }else{
                CanCon.fillStyle = 'rgba('+BU.color[0]+','+BU.color[1]+','+BU.color[2]+','+BU.color[3]+')';
            }
            CanCon.beginPath();

            if(O.squareCorners){
                CanCon.moveTo( (O.squareCorners.A.x- -Px).toFixed(1), (O.squareCorners.A.y- -Py).toFixed(1) );
                CanCon.lineTo( (O.squareCorners.B.x- -Px).toFixed(1), (O.squareCorners.B.y- -Py).toFixed(1) );
                CanCon.lineTo( (O.squareCorners.C.x- -Px).toFixed(1), (O.squareCorners.C.y- -Py).toFixed(1) );
                CanCon.lineTo( (O.squareCorners.D.x- -Px).toFixed(1), (O.squareCorners.D.y- -Py).toFixed(1) );
                CanCon.lineTo( (O.squareCorners.A.x- -Px).toFixed(1), (O.squareCorners.A.y- -Py).toFixed(1) );
            }else if(O.coneAngle){
                var Angle1 = (O.angle- -O.coneAngle-90)*Radi;
                var Angle2 = (O.angle - O.coneAngle-90)*Radi;
                CanCon.arc(O.x- -Px,O.y- -Py,O.radius,Angle1,Angle2,true);
                CanCon.arc(O.x- -Px,O.y- -Py,O.coneRad2,Angle2,Angle1,false);
                CanCon.closePath();
            }else{
                CanCon.arc(O.x- -Px, O.y- -Py, O.radius, 0, Math.PI*2, true);
            }

            CanCon.fill();
            CanCon.restore();

            ++O.animTick;
            if(AD.state=='start' && O.animTick >= DR.frames){
                AD.state='norm';
                O.animType = DR.onEnd;
                AD.Next = 0;
            }
            if(AD.state=='norm' && DR.toExpire- -GAME.tick >= O.DieTime){
                AD.state='end';
                O.animType = DR.onExpire;
                AD.Next=0;
                O.animTick=0;
            }

            if(DR.makeParticles){
                AD.Next -=- O.animPole/DR.makeParticles;
                while(AD.Next > 1){
                    var PX = this.regionAnim_findParticlePlace(O);

                    if(DR.particleAnim=='randomMove'){
                        var angle = parseInt(Math.random()*360);
                        var rotation = parseInt(Math.random()*360);
                        var rotate = -1;
                        if(angle > 180) rotate=1;
                        if(DR.particleAnimAngle && DR.particleAnimAngle=='withDirection'){
                            rotation = angle -180;
                            rotate = 0;
                        }
                        if(DR.particleAnimAngle && DR.particleAnimAngle=='noRotation'){
                            rotation = 0;
                            rotate = 0;
                        }
                        AD.P[ ++AD.Plen ]={time:0,x:PX.x,y:PX.y,angle: angle, rotation: rotation, rotate:rotate, speed: 1, particleId: DR.particleId, particleTime: DR.particleTime, particleXY: DR.particleXY};
                    }
                    if(DR.particleAnim=='toCenter'){
                        var angle =  parseInt(- (Math.atan2(PX.x,PX.y)*180/Math.PI))%360;
                        AD.P[ ++AD.Plen ]={time:0,x:PX.x,y:PX.y,angle: angle, rotation: angle, rotate:0, speed: 6, particleId: DR.particleId, particleTime: DR.particleTime, particleXY: DR.particleXY};
                    }
                    if(DR.particleAnim=='onOrbit'){
                        var angle =  parseInt(- (Math.atan2(PX.x,PX.y)*180/Math.PI))%360;
                        var obwod = Math.sqrt(PX.x*PX.x- -PX.y*PX.y)*2*Math.PI;
                        var angleChange = 360/(obwod/3);
                        if(Math.random() <= 0.5){
                            angle-=90;
                        }else{
                            angle-=-90;
                            angleChange=-angleChange;
                        }
                        AD.P[ ++AD.Plen ]={time:0,x:PX.x,y:PX.y,angle: angle, angleChange: angleChange, rotation: angle, rotate: angleChange, speed: 3, particleId: DR.particleId, particleTime: DR.particleTime, particleXY: DR.particleXY};
                    }
                    if(DR.particleAnim=='withWind'){
                        var angle =  O.windAngle;
                        AD.P[ ++AD.Plen ]={time:0,x:PX.x,y:PX.y,angle: angle, rotation: angle- -270, rotate:0, speed: 2, particleId: DR.particleId, particleTime: DR.particleTime, particleXY: DR.particleXY};
                    }
                    AD.Next-=1;
                }
            }
            for(var p in AD.P){
                var T = AD.P[p];
                if(++T.time > T.particleTime){
                    delete AD.P[p];
                    continue;
                }
                T.x-=- T.speed * Math.sin( (-parseInt(T.angle)-180)*(Math.PI/180));
                T.y-=- T.speed * Math.cos( (-parseInt(T.angle)-180)*(Math.PI/180));
                T.rotation-=-T.rotate;

                CanCon.save();
                CanCon.translate((O.x- -Px- -T.x).toFixed(0), (O.y- -Py- -T.y).toFixed(0));
                CanCon.rotate(Radi*T.rotation);
                var IMG =document.getElementById('CanvasManager_'+T.particleId+'_frame_'+T.time+'_');
                CanCon.drawImage(IMG,-T.particleXY,-T.particleXY);
                CanCon.restore();

                if(T.angleChange) T.angle-=-T.angleChange;
            }
        }

    }
    this.regionAnim_findParticlePlace = function(O){
        var DR = this.directRenders[ O.animType ];
        var x=0,y=0,dist=0,angle=0;
        var Radi = Math.PI*2/360;


        if(O.squareCorners){
            var Width = O.squareWidth;
            var xA = Math.random()*O.squareLen;
            if(DR.particleAnim=='randomMove'){
                var xA = Width*0.2- -Math.random()*(O.squareLen - Width*0.4);
                Width*=0.8;
            }
            var yA = Math.random()*Width*2 - Width;

            var aA = -(O.squareAngle- -180)*Radi;

            x = xA*Math.sin(aA) - yA*Math.cos(aA);
            y = xA*Math.cos(aA) - yA*Math.sin(aA);

        }
        else if(O.coneAngle){
            var R2=O.coneRad2;
            var R1=O.radius-R2;
            var udaloSie=true;

            if(DR.particleAnim=='randomMove'){    R2-=-R1*0.20; R1*=0.6; }
            var rad = R2- -(Math.random()*R1);
            var angle = O.angle- -(Math.random()*O.coneAngle*2 - O.coneAngle)-180;

            x = rad*Math.sin(-angle*Radi);
            y = rad*Math.cos(-angle*Radi);
        }
        else{
            var R2=0;
            var R1=O.radius;
            if(DR.particleAnim=='randomMove'){    R1*=0.75; }
            if(DR.particleAnim=='toCenter'){    R2=R1*0.4; R1*=1.2; }
            if(DR.particleAnim=='onOrbit'){        R2=R1*0.2; }
            do{
                x = parseInt(Math.random()*R1*2-R1);
                y = parseInt(Math.random()*R1*2-R1);
                dist = Math.sqrt(x*x- -y*y);
            }while(!(dist > R2 && dist < R1));
        }

        if(DR.particleAnim=='withWind'){
            x-=-30*Math.sin((O.windAngle-90)*Radi);
            y-=-30*Math.cos((O.windAngle-90)*Radi);
        }

        return {x:x,y:y};
    }
    this.simpleFilling = function(CanCon,O){
        var P = GAME.O[0];
        var Px = (-P.x- -(GAME.Dx/2));
        var Py = (-P.y- -(GAME.Dy/2));
        var Radi = Math.PI*2/360;


        CanCon.save();
        CanCon.fillStyle = O.simpleFilling;
        CanCon.beginPath();

        if(O.squareCorners){
            CanCon.moveTo( (O.squareCorners.A.x- -Px).toFixed(1), (O.squareCorners.A.y- -Py).toFixed(1) );
            CanCon.lineTo( (O.squareCorners.B.x- -Px).toFixed(1), (O.squareCorners.B.y- -Py).toFixed(1) );
            CanCon.lineTo( (O.squareCorners.C.x- -Px).toFixed(1), (O.squareCorners.C.y- -Py).toFixed(1) );
            CanCon.lineTo( (O.squareCorners.D.x- -Px).toFixed(1), (O.squareCorners.D.y- -Py).toFixed(1) );
            CanCon.lineTo( (O.squareCorners.A.x- -Px).toFixed(1), (O.squareCorners.A.y- -Py).toFixed(1) );
        }else if(O.coneAngle){
            var Angle1 = (O.angle- -O.coneAngle-90)*Radi;
            var Angle2 = (O.angle - O.coneAngle-90)*Radi;
            CanCon.arc(O.x- -Px,O.y- -Py,O.radius,Angle1,Angle2,true);
            CanCon.arc(O.x- -Px,O.y- -Py,O.coneRad2,Angle2,Angle1,false);
            CanCon.closePath();
        }else{
            CanCon.arc(O.x- -Px, O.y- -Py, O.radius, 0, Math.PI*2, true);
        }

        CanCon.fill();
        CanCon.restore();

    }

}

function GAMEobject(){
    {
    this.Dx=1300;
    this.Dy=550;
    this.MapTileSize = 250;
    this.Frames=30;
    this.tick=0;
    this.tickD=0;
    this.IntervalIndex=-1;
    this.pause=false;
    this.doEndGame=false;

    this.EnemiesC=0;
    this.Enemies={};            // Tablica Enemies

    this.MapRadius=2700;
    this.MapRadius2=3200;

    this.O={};            // Object's - all of them
    this.Olen=0;
    this.Omap={};        // map of Maps
    // No map for: B-Bullets, BE-BulletsE, T-TeleportsRoutes
    this.Omap['P']={elems:1};    //    Player
    this.Omap['M']={elems:0};    //    Missles
    this.Omap['E']={elems:0};    //    Enemies
    this.Omap['ME']={elems:0};    //    MisslesE
    this.Omap['A']={elems:0};    //    Asteroids - only for Player Ship
    this.Omap['R']={elems:0};    //    Regions
    this.Omap['D']={elems:0};    //     Dead objects (for spotting)
    this.Odead={};


    this.Omoving={};    // moving
    this.Ocomp={};        // sterowane statki / missle
    this.Obullet={};    // tablica kul
    this.Oanim={};        // animations
    this.Oregion={};    // regions

    this.Squads={};        // moving in Squads
    this.SquadLen=0;

    this.keyLeftRight=0;
    this.keyUpDown=0;

    this.keyLeftLC = 0;
    this.keyRightLC = 0;
    this.keyUpLC = 0;
    this.keyDownLC = 0;
    this.specialMove = -1;
    this.specialMoveT = -1;

    this.showLaserInd = true;
    this.RadarOld = {};    for(var i=0; i<360;++i) this.RadarOld[i]=[];
    this.mouse_x = 0;
    this.mouse_y = 0;
    this.mouseX = 0;
    this.mouseY = 0;

    this.FPSx=0;
    this.FPSy=0;
    this.FPSz=0;
    this.MSmove=0;
    this.MSdecide=0;
    this.MSdraw=0;
    this.MSship=0;

    this.SHIP={};
    this.SHIPold={};
    }


    this.resize = function(){
        this.Dy = $(window).height();
        this.Dx = $(window).width();
        $('#Game').css({width: this.Dx+'px',height: this.Dy+'px'});
        $('#MainCanvas').css({width: this.Dx+'px',height: this.Dy+'px'}).attr('width',this.Dx).attr('height',this.Dy);

        if($('#MainCanvas').length)
            this.CanvasHandle = document.getElementById('MainCanvas').getContext('2d');
    }
    this.setBoard = function(){
        var html='',html2='';

        html2+='<div id="countEnemies"></div>';
        html2+='<div id="countHealth"></div>';
        html2+='<div id="countSpeed"></div>';
        html2+='<div id="countRadar"></div>';
        html2+='<div id="gamearea">';
            html2+='<div id="pause"><span>P</span></div>';
            html2+='<div id="gameboard"></div>';
            html2+='<canvas id="MainCanvas" style="width:'+this.Dx+'px; height: '+this.Dy+'px;" width="'+this.Dx+'" height="'+this.Dy+'"></div>';
            html2+='<div id="gameboard2">'+html+'<div id="gameboardMarkers"></div></div>';
        html2+='</div>';
        html2+='<div id="gameOverlay" class="cursorCross"><div id="bulletRadius"><div id="bullRadX"></div></div></div>';

        $('#Game').unbind('click').show().html(html2);

        $(window)
            .unbind()
            .mousedown(function(e){ GAME.mouse_down(e); })
            .mouseup(function(e){ GAME.mouse_up(e); })
            .mousemove(function(e){ GAME.mousemove(e); })
            .keydown(function(e){ GAME.keydown(e); })
            .keyup(function(e){ GAME.keyup(e); })
            .blur(function(e){ if(!GAME.doEndGame){ GAME.pause=true;    clearInterval(GAME.intervalIndex);    $('#pause').show();    }    })
            .resize(function(e){ GAME.resize(); });

      //  document.addEventListener('mousedown',function(e){     GAME.mouse_down(e); },false);
      //  document.addEventListener('mouseup',function(e){     GAME.mouse_up(e); },false);
      //  document.addEventListener('mousemove',function(e){     GAME.mousemove(e); },false);
    }
    this.start = function(Setting,Ship){
        this.MapRadius=Setting.MapRadius;
        this.MapRadius2=Setting.MapRadius2;
        this.SHIP = Ship;
        this.resize();
        this.setBoard();
        this.CanvasHandle = document.getElementById('MainCanvas').getContext('2d');

        if(GET.CANVAS > 0){
            $('#CanvasPreviews').css({display: 'block'});
        }

        this.O[0]={
            x:0,
            y:0,
            speed:7,
            speedA: 3,
            speedD: 6,
            speedM: 10,
            speedT:3.5,
            lastSpeedT: 0,
            angle: 0,
            radius: 7,
            S: 2,
            life: this.SHIP.life,
            lifeM: this.SHIP.lifeM,
            energyField: 0,
            T: 'ship',
            ammo: 0,
            M: 'moving',
            viewLetter: 'A',
            viewLetterSize: 16,
            viewColor: 'blue',
            viewAngle: 0,
            viewHitPattern: 'HullFire_20',
            mapType: 'P',
            mapCollide: ['A','ME'],
            periodDMG: {},
        };
        this.putOnXY(0);


        CanvasManager.requestCanvas( 0 );

        this.Omoving={0:1};
        this.Olen=1;

        this.makeShipControlPanel();
        this.shipFunc_showHealth();

        this.putObj('Gstar','static',0,0,0);

        // RANDOMLY PLACED ITEMS
        for(var OPS in Setting.O){
            if(OPS=='Star')    for(var i=0; i<Setting.O[OPS]; ++i)    var L = this.putObj('star','static',1);
            else            for(var i=0; i<Setting.O[OPS]; ++i){
                var L = this.putObj(NAMES.Ships[OPS],'comp',1);
                if(Setting.GiveEnergyFields > 0){
                    this.addEnergyField(L,3,150);
                    --Setting.GiveEnergyFields;
                }
            }
        }

        if(typeof Setting.Place != 'undefined')
            for(var i=0; i<Setting.Place.length; ++i)
                this.mapPlaceObj(Setting, Setting.Place[i]);



        if(GET.CANVAS==0){
            this.FRAME_TIME = new Date().getTime();
            this.frame();
            this.intervalIndex = window.requestAnimationFrame(function(){ GAME.frame(); });
        }
    }
    this.mapPlaceObj = function(Setting,SET,defX,defY){
        if( typeof defX == 'undefined' ){
            defX = 0;
            defY = 0;
        }
        for(var placeWhat in SET.What){
            for(var j=0; j < SET.What[placeWhat]; ++j){

                var x = defX;
                var y = defY;
                if(SET.Random){
                    do{
                        x = Math.random()*SET.Random.Radius*2-SET.Random.Radius;
                        y = Math.random()*SET.Random.Radius*2-SET.Random.Radius;
                    }while( (x*x- -y*y) > SET.Random.Radius*SET.Random.Radius );
                    x-=-SET.Random.X;
                    y-=-SET.Random.Y;
                }

                if(placeWhat=='Star'){
                    var L = this.putObj('star','static',1,x,y);
                }else if(placeWhat=='Gstar'){
                    var L = this.putObj('Gstar','static',1,x,y);
                }else if(placeWhat=='RoundField'){
                    var L = this.putObj('RoundField','region',1,x,y);
                }else if(placeWhat=='SquareField'){
                    var L = this.putObj('SquareField','region',1,x,y);
                }else if(placeWhat=='ConeField'){
                    var L = this.putObj('ConeField','region',1,x,y);
                }else if(placeWhat=='LineOfMines'){
                    var x = SET.objData.x;
                    var y = SET.objData.y;
                    var dist = 0;
                    var Radi = Math.PI/180;
                    while(dist < SET.objData.radius){
                        this.putObj('space_mine','comp',1,x,y);
                        x-=-SET.objData.distance*Math.sin( (-parseInt(SET.objData.angle)-180)*Radi);
                        y-=-SET.objData.distance*Math.cos( (-parseInt(SET.objData.angle)-180)*Radi);
                        dist-=-SET.objData.distance;
                    }
                    L = -1;

                } else {
                    var L = this.putObj(NAMES.Ships[placeWhat],'comp',1,x,y);
                    if(typeof Setting.BoardMods !='undefined')
                        for(var k in Setting.BoardMods)
                            this.addBoardMod(L,Setting.BoardMods[k]);
                    if(typeof SET.BoardMods !='undefined')
                        for(var k in SET.BoardMods)
                            this.addBoardMod(L,SET.BoardMods[k]);
                }

                if(typeof SET.objData !='undefined' && L!=-1)
                    this.addBoardMod(L,SET.objData);
            }
        }

    }

    this.addBoardMod = function(o,MODname){
        var MOD,O = this.O[o];

        if(typeof MODname == 'string')    MOD = BoardMODS[MODname];
                else                    MOD = MODname;

        if(typeof MOD.who != 'undefined'){
            var jest=false;
            for(var i=0; i<MOD.who.length; ++i)
                if(MOD.who[i]==O.viewLetter){
                    jest=true;
                    break;
                }
            if(!jest) return false;
        }

        for(var KI in MOD){
            if(KI=='toDo'){
                for(var i in MOD.toDo)
                    this.addToToDoList(o,MOD.toDo[i]);
            }else if(KI=='x'){
                var oldX = O.x;
                var oldY = O.y;
                O.x = MOD.x;
                O.y = MOD.y;
                this.putOnXY(o,oldX,oldY);
            }else if(KI=='y'){
            }else{
                O[KI] = MOD[KI];
            }
        }

        if(typeof MOD.fieldAnim != 'undefined')
            this.setRegionAnimation(o, MOD.fieldAnim);

        if(typeof MOD.simpleFilling != 'undefined')
            O.TT='simpleFilling';

        if(typeof MOD.squareAngle != 'undefined'){
            O.squareCorners = this.countSquareCorners(O.x,O.y,O.squareAngle,O.squareLen,O.squareWidth);
        }

        CanvasManager.requestCanvas( o );
        this.putOnXY( o );
    }
    this.addToToDoList = function(o,toDo){
        if(typeof this.O[o].toDo == 'undefined'){
            return true;
        }

        var OtoDo = this.O[o].toDo;
        var NtoDo=[];
        var N = toDo.N;
        for(var i=0; i<OtoDo.length; ++i){
            if(N!=false && N > OtoDo[i].N){
                NtoDo[ NtoDo.length ] = toDo;
                N=false;
            }
            NtoDo[ NtoDo.length ] = OtoDo[i];
        }
        if(N!=false)
            NtoDo[ NtoDo.length ] = toDo;

        this.O[o].toDo = NtoDo;
    }
    this.putObj_fromArray = function(O){
        var isEnemyShip = false;
        for(var i in NAMES.Ships){
            if(O.T==NAMES.Ships[i]){
                isEnemyShip=true;
                break;
            }
        }

        if(isEnemyShip){
            for(var i in ObjectPutDatas.enemyShip){
                var X = ObjectPutDatas.enemyShip[i];
                if(typeof X == 'object')    O[i] = cloneObj(X);
                    else                     O[i] = X;
            }
        }
        if(typeof ObjectPutDatas[O.T]!= 'undefined'){
            for(var i in ObjectPutDatas[O.T]){
                var X = ObjectPutDatas[O.T][i];
                if(typeof X == 'object')    O[i] = cloneObj(X);
                    else                     O[i] = X;
            }
        }

        return O;
    }

    this.putObj_carras = function(O){
        O.speedLvl = 2;
        O.speed = 6.5- -Math.random();
        O.speedT    = 2.5; //- -Math.random();
        O.speedArr = [0,
            {S: O.speed-2, T:O.speedT- -2},
            {S: O.speed, T:O.speedT},
            {S: O.speed- -3, T:O.speedT}
        ];

        var spotRad1 = 80- -parseInt(Math.random()*80);
        var spotRad2 = 300- -parseInt(Math.random()*200);
        O.spotTick = 8;
        O.spotArr=[0,
            { T: 'single', Ref: 15, Rad: spotRad1},
            { T: 'double', Ref: 10, Rad: spotRad1, Rad2: spotRad2, Angle2: 30- -parseInt(Math.random()*30)},
            { T: 'single', Ref: 45, Rad: spotRad2}
        ];
        return O;
    }
    this.putObj_muerto = function(O){
        O.speedLvl = 2;
        O.speed = 3;
        O.speedT = 2; //- -Math.random();
        O.speedArr = [0,
            {S: O.speed-2, T:O.speedT- -1},
            {S: O.speed, T:O.speedT},
            {S: O.speed- -3, T:O.speedT}
        ];

        var spotRad1 = 80- -parseInt(Math.random()*80);
        var spotRad2 = 300- -parseInt(Math.random()*200);
        O.spotTick = 8;
        O.spotArr=[0,
            { T: 'single', Ref: 15, Rad: spotRad1},
            { T: 'double', Ref: 10, Rad: spotRad1, Rad2: spotRad2, Angle2: 30- -parseInt(Math.random()*30)},
            { T: 'single', Ref: 45, Rad: spotRad2}
        ];

        O.weapon=[
            {t:'rose', Power:1, Dec: 50, Speed: 10, gunSpeed: 50, lastShot: 100, AtOnce: 9, RoseAngle: 4, maxSpeed: 2, minAlarm: 5, minDistToEnemy: spotRad2}
        ];
        return O;
    }
    this.putObj_iskariot = function(O){
        O.speedLvl = 2;
        O.speed = 8- -Math.random()*.15;
        O.speedT    = 2.5- -Math.random();
        O.speedArr = [0,
            {S: O.speed-4, T:O.speedT- -2},
            {S: O.speed, T:O.speedT},
            {S: O.speed- -4, T:O.speedT}
        ];

        var spotRad1 = 80- -parseInt(Math.random()*80);
        var spotRad2 = 300- -parseInt(Math.random()*200);
        O.spotTick = 8;
        O.spotArr=[0,
            { T: 'single', Ref: 15, Rad: spotRad1},
            { T: 'double', Ref: 10, Rad: spotRad1, Rad2: spotRad2, Angle2: 30- -parseInt(Math.random()*30)},
            { T: 'single', Ref: 45, Rad: spotRad2}
        ];
        return O;
    }
    this.putObj_dandares = function(O){
        O.speedLvl    = 2;
        O.speed     = 4;
        O.speedT    = 2;
        O.speedArr = [0,
            {S: O.speed - 3, T:O.speedT- -1.5},
            {S: O.speed, T:O.speedT},
            {S: O.speed- -4, T:O.speedT}
        ];

        var spotRad1 = 100- -parseInt(Math.random()*60);
        var spotRad2 = 160 -parseInt(Math.random()*60);
        O.spotTick = 8;
        O.spotArr=[0,
            { T: 'single', Ref: 35, Rad: spotRad1},
            { T: 'double', Ref: 20, Rad: spotRad1, Rad2: spotRad2, Angle2: 100- -parseInt(Math.random()*20)},
            { T: 'single', Ref: 45, Rad: spotRad2}
        ];
        return O;

    }

    this.putObj = function(Type,Mode,Side,x,y){
        if(typeof x === "undefined"){
            do{
                x = Math.random()*this.MapRadius*2-this.MapRadius;
                y = Math.random()*this.MapRadius*2-this.MapRadius;
            }while( Math.sqrt(x*x- -y*y) > this.MapRadius );
        }
        var L = this.Olen++;
        var Enemy='';


        var O={};
        O.x = x;
        O.y = y;
        O.S = Side;
        O.T = Type;
        O.M = Mode;
        O.periodDMG={};
        O.radius = 15;
        O.TT = 'dust';

        if(Type!='bullet')
            O = this.putObj_fromArray(O,Type);

        if(Type=='carras')         O = this.putObj_carras(O);
        if(Type=='muerto')         O = this.putObj_muerto(O);
        if(Type=='iskariot')    O = this.putObj_iskariot(O);
        if(Type=='dandares')    O = this.putObj_dandares(O);

        if(O.TT=='enemy'){
            Enemy=' enemy';
            ++this.EnemiesC;
            this.Enemies[ L ] = 1;
            O.angle        = parseInt(Math.random()*360);
            O.mapType = 'E';
            O.mapCollide = ['M'];
        }

        if(Type=='healing_missle' || Type=='missle' || Type=='bullet_bomb' || Type=='space_mine' || Type=='shieldBlob'){
            if(Side==2){
                O.mapType = 'M';
                O.mapCollide = ['E','ME','A'];
            } else{
                O.mapType = 'ME';
                O.mapCollide = ['P','M'];
            }
        }
        if(Type=='star' || Type=='Gstar'){
            O.mapType = 'A';
            // O.mapCollide = ['P','M','ME'];
        }
        if(Type=='bullet'){
            if(Side==3){
                O.mapType = 'B';
                O.mapCollide = ['P','M','E','ME','A','R'];
            }else if(Side==2){
                O.mapType = 'B';
                O.mapCollide = ['E','ME','A','R'];
            }else{
                O.mapType = 'BE';
                O.mapCollide = ['P','M','R'];
            }
        }

        if(Mode=='region'){
            O.mapType = 'R';
            O.mapCollide = ['P','E','M','ME','A'];
        }

        O.life = O.lifeM;

        // Map Objs: B-Bullets, BE-BulletsE, P-Player, M-Missles, E-Enemies, ME-MisslesE, R-Regions, D-Dead


        if(Type=='tartaros'){
            O.speedM    = O.speed    = 5;
            O.speedT    = 6;
        }
        if(Type=='edison'){
            O.speedM    = O.speed    = 3;
            O.speedT    = 6;
            O.FieldPower    = 3;
        }
        if(Type=='belzebub'){
            O.speedM    = O.speed    = 5;
            O.speedT    = 3;
        }
        if(Type=='nemezis'){
            O.speedM    = O.speed    = 3;
            O.speedT    = 2;
        }
        if(Type=='royale'){
            O.speedM    = O.speed    = 3;
            O.speedT    = 2;
        }
        if(Type=='warastein'){
            O.speedM    = O.speed    = 7;
            O.speedT    = 4;
        }
        if(Type=='hiacynt'){
            O.speedM    = O.speed    = 5;
            O.speedT    = 2;
        }

        if(Type=='orhenes'){
            O.speedM    = O.speed    = 1;
            O.speedT    = 1;
        }
        if(Type=='juggernaut'){
            O.speedM    = O.speed    = 1;
            O.speedT    = 1;
        }
        if(Type=='koriaz'){
            O.speedM    = O.speed    = 4;
            O.speedT    = 1;
        }
        if(Type=='fariax'){
            O.speedM    = O.speed    = 4;
            O.speedT    = 1;
        }
        if(Type=='cloacker'){
            O.speedM    = O.speed    = 6;
            O.speedT    = 4;
        }
        if(Type=='hajaher'){
            O.speedM    = O.speed    = 5- -4*Math.random();
            O.speedT    = 2- -2*Math.random();
        }
        if(Type=='dregos'){
            O.speedM    = O.speed    = 7- -Math.random()*1.5;
            O.speedT    = 2.5- -Math.random();
        }
        if(Type=='gargamon'){
            O.speedM    = O.speed = 2;
            O.speedT    = 1.5;
        }
        if(Type=='vitotas'){
            O.speedM    = O.speed    = 7.5- -Math.random()*1.5;
            O.speedT    = 2- -Math.random()*2;
            O.Distance = 650;
            O.Damage  = 5;
            O.LaserAim = 20;
        }

        if(Type=='bullet'){
            O.speed    = 12;
            O.angle    = 0;
            O.radius= 4;
            O.dec    = 30;
            O.Power    = 1;
        }
        if(Type=='space_mine'){
            O.life    = 1;
            O.speed    = 0;
            O.angle    = 0;
            O.radius= 6;
            O.dec    = 0;
            O.ammo    = 0;
            O.toDo    = 0;
            O.Power    = 4;
            O.Dist    = 35;
        }

        if(Type=='hiacynt_shield'){
            O.life    = O.lifeM = 5;
            O.speed    = 10;
            O.angle    = 0;
            O.radius= 21;
            O.dec    = 0;
            O.ammo    = 0;
            O.toDo    = 0;
        }


        if(Mode!='static' && Mode!='region')
            this.Omoving[ L ] = 1;
        if(Mode=='region')
            this.Oregion[ L ] = 1;

        if(Mode=='comp')
            if(Type!='bullet')    this.Ocomp[ L ] = Side;
                    else        this.Obullet[ L ] = Side;



        this.O[ L ]= O;


        if(O.squadSchemeType)
            this.prepareSquadScheme(O);

        if(O.squadScheme)
            this.checkSquadSchemeMakes(O);


        if(Type!='shieldBlob')
            CanvasManager.requestCanvas( L );

        if(Type!='bullet')
            this.putOnXY( L );
        if(Type=='juggernaut') this.addEnergyField(L,20,60);
        if(Type=='gargamon') this.addEnergyField(L,10,120);
        return L;
    }

    this.putObj_animation = function(Type,X,Y){
        var O = {};
        var o = this.Olen++;

        O.T = Type;
        O.TT = 'anim';
        O.M = 'anim';
        O.x = X;
        O.y = Y;
        O.radius = 15;
        O.angle = 0;
        O.timeTick = 0;

        if(Type=='hit_healing'){
            O.timeDeath = 25;
            O.radius = 15;
        }
        if(Type=='hit' || Type=='hit_energyField' || Type=='hit_blue'){
            O.timeDeath = 25;
            O.radius = 30;
        }
        if(Type=='hitBig'){
            O.timeDeath = 21;
            O.radius = 60;
        }
        if(Type=='explosion_35'){
            O.timeDeath = 25;
            O.radius = 35;
            O.angle = parseInt(Math.random()*360);
        }
        if(Type=='explosion_80'){
            O.timeDeath = 25;
            O.radius = 80;
            O.angle = parseInt(Math.random()*360);
        }
        if(Type=='explosion_120'){
            O.timeDeath = 25;
            O.radius = 120;
            O.angle = parseInt(Math.random()*360);
        }
        if(Type=='explosion_210'){
            O.timeDeath = 25;
            O.radius = 210;
            O.angle = parseInt(Math.random()*360);
        }

        this.Oanim[o] = 1;
        this.O[o] = O;
    }
    this.putObj_directAnim = function(Type,Data){
        var O = {};
        var o = this.Olen++;

        O.T = Type;
        O.TT = 'dirAnim';
        O.M = 'dirAnim';
        O.Data = Data;
        O.x = 0;
        O.y = 0;
        O.timeTick = -1;
        O.timeDeath = Data.timeDeath;

        this.Oanim[o] = 1;
        this.O[o] = O;

        return o;
    }
    this.setRegionAnimation = function(o,animType){
        var O = this.O[o];
        O.TT = 'regionAnim';
        O.animTick = 0;
        O.animData = { state: 'start', Next:0, Plen:0, P:{}};

        if(typeof O.squareCorners !='undefined'){
            O.animPole = O.squareLen * O.squareWidth * 2;
        } else
            O.animPole = parseInt(Math.PI*O.radius*O.radius/1000);
        if(typeof O.coneAngle != 'undefined'){
            if(O.coneRad2 != 0)
                O.animPole -= parseInt(Math.PI*O.coneRad2*O.coneRad2/1000);
            if(O.coneAngle < 180)
                O.animPole = parseInt(O.animPole*(O.coneAngle/180));
        }


        if(animType=='DestructionField') O.animType = 'DestrFieldStart';
        if(animType=='ElectricityField') O.animType = 'EleFieldStart';
        if(animType=='HealingField')     O.animType = 'HealFieldStart';
        if(animType=='GravityField')     O.animType = 'GravFieldStart';
        if(animType=='OrbitalField')     O.animType = 'OrbFieldStart';
        if(animType=='ShellField')       O.animType = 'ShellFieldStart';
        if(animType=='WindField')        O.animType = 'WindFieldStart';
    }

    this.removeObj = function(o,saveDiv){
        if(o==0) return false;
        if(typeof this.O[o] =='undefined') return false;
        // if(!saveDiv) $('#O_'+o).remove();

        if(this.O[o].T!='bullet' && this.O[o].T!='star' && this.O[o].TT!='anim' && this.O[o].TT!='dirAnim'){    // Czyli co?

            if(this.O[o].TT=='enemy')    this.removeFromXY(o,true);
                    else                this.removeFromXY(o);
            delete this.Enemies[o];

            if(typeof this.O[o].squadId !='undefined'){
                var S = this.Squads[ this.O[o].squadId ];
                if(o == S.Leader)
                    this.disbandSquad( this.O[o].squadId );
                else
                    delete S.Members[o];
            }
        }
        if(this.O[o].T=='star')    this.removeFromXY(o,true);

        if(this.O[o].TT == 'anim' || this.O[o].TT == 'dirAnim')
            delete this.Oanim[o];

        if(this.O[o].TT == 'enemy')
            this.Odead[ o ]={T:this.O[o].T,x:this.O[o].x,y:this.O[o].y};

        delete this.Omoving[o];
        delete this.Ocomp[o];
        delete this.Obullet[o];
        delete this.Oregion[o];
        if(this.O[o].TT!='enemy' && this.O[o].T!='star')
            delete this.O[o];
    }

    this.mouse_down = function(e){
        var P = $('#Game').offset();
        this.mouse_x = e.clientX-P.left;
        this.mouse_y = e.clientY-P.top;

        if(e.clientX > 50 && e.clientX < 121){
            var u = parseInt((e.clientY-this.Dy)/-32)-1;
            if(u>-1 && u< this.SHIP.Modules.length){
                if( this.SHIP.Modules[u].Disabled == 1) this.SHIP.Modules[u].Disabled = 0;
                            else                        this.SHIP.Modules[u].Disabled = 1;
                return true;
            }
        }
        if(e.clientY - this.Dy > -32){
            var u = parseInt((e.clientX-105)/33);
            if(u>-1 && u < this.SHIP.FireTypes.length){
                if(this.SHIP.FireType2!==false && e.which==3)
                    this.shipFunc_changeWeapon(2, u);
                else
                    this.shipFunc_changeWeapon(1, u);
                return true;
            }
        }
        if(this.SHIP.FireType2!==false && e.which==3)
            this.SHIP.MouseDown2=true;
        else
            this.SHIP.MouseDown1=true;
    }
    this.mouse_up = function(e){
        this.SHIP.MouseDown1=false;
        this.SHIP.MouseDown2=false;
    }
    this.mousemove = function(e){
        var P = $('#Game').offset();
        this.mouse_x = e.clientX-P.left;
        this.mouse_y = e.clientY-P.top;
    }
    this.keydown = function(e){
        if(e.keyCode==37 || e.keyCode==65){
            if(this.keyLeftRight == 0 && this.keyLeftLC- -7 > this.tick)    this.specialMove = 1;
            this.keyLeftRight = 1;
            if(this.keyLeftLC!=-1) this.keyLeftLC = this.tick;
        }
        if(e.keyCode==39 || e.keyCode==68){
            if(this.keyLeftRight == 0 && this.keyRightLC- -7 > this.tick)    this.specialMove = 2;
            this.keyLeftRight = -1;
            if(this.keyRightLC!=-1) this.keyRightLC = this.tick;
        }
        if(e.keyCode==38 || e.keyCode==87){
            if(this.keyUpDown == 0 && this.keyDownLC- -7 > this.tick)    this.specialMove = 3;
            this.keyUpDown = 1;
            if(this.keyDownLC!=-1) this.keyDownLC = this.tick;
        }
        if(e.keyCode==40 || e.keyCode==83){
            if(this.keyUpDown == 0 && this.keyUpLC- -7 > this.tick)    this.specialMove = 4;
            this.keyUpDown = -1;
            if(this.keyUpLC!=-1) this.keyUpLC = this.tick;
        }
    }
    this.keyup = function(e){
        if(e.keyCode==37 || e.keyCode==65)    this.keyLeftRight=0;
        if(e.keyCode==39 || e.keyCode==68)    this.keyLeftRight=0;
        if(e.keyCode==38 || e.keyCode==87)    this.keyUpDown=0;
        if(e.keyCode==40 || e.keyCode==83)    this.keyUpDown=0;


        if(e.keyCode > 48 && e.keyCode < 58){    // Numeric 1-9
            if(e.keyCode-49 < this.SHIP.FireTypes.length)
                this.shipFunc_changeWeapon(1, e.keyCode-49);
        }

        if(typeof this.SHIP.KeysModules[ e.keyCode ] !='undefined'){
            var M = this.SHIP.KeysModules[ e.keyCode ];
            for(var m=0; m < M.length; ++m){
                if(this.SHIP.Modules[ M[m] ].Disabled == 1)    this.SHIP.Modules[ M[m] ].Disabled = 0;
                                else                        this.SHIP.Modules[ M[m] ].Disabled = 1;
            }
        }

        if(e.keyCode==69){        // E - estimateMoves
            if(this.estimateMoves)    this.estimateMoves=false;
                    else            this.estimateMoves=true;
        }
        if(e.keyCode==80 && this.doEndGame==false){    // P - pause
            if(this.pause==false){
                this.pause=true;
                window.cancelAnimationFrame(this.intervalIndex);
                $('#pause').show();
            } else {
                this.pause=false;
                this.FRAME_TIME = new Date().getTime();
                this.intervalIndex = window.requestAnimationFrame(function(){ GAME.frame(); });
                $('#pause').hide();
            }
        }
        if(e.keyCode==27){    // ESC - escape
            this.endGame();
        }
    }


    this.putOnXY = function(o,ox,oy){    //!!
        var X1,Y1,X2,Y2,xi,yi,s,oldS={},newS={}, O = this.O[o];
        var M = this.MapTileSize;

        if(typeof oy!='undefined'){

            if(typeof O.squareCorners !='undefined'){
                X1 = O.squareCorners.E.x1;
                Y1 = O.squareCorners.E.y1;
                X2 = O.squareCorners.E.x2;
                Y2 = O.squareCorners.E.y2;
            }else{
                X1 = ox - O.radius;
                Y1 = oy - O.radius;
                X2 = ox- -O.radius;
                Y2 = oy- -O.radius;
            }
            xi=X1;
            while(true){
                if(xi>X2) xi=X2;
                yi=Y1;
                while(true){
                    if(yi>Y2) yi=Y2;
                    oldS[ parseInt(xi/M)+'_'+parseInt(yi/M) ]=1;
                    if(yi==Y2) break;
                    yi-=-M;
                }
                if(xi==X2) break;
                xi-=-M;
            }
        } else {
            this.Omap[O.mapType].elems++;
        }

        if(typeof O.squareCorners !='undefined'){
            X1 = O.squareCorners.E.x1;
            Y1 = O.squareCorners.E.y1;
            X2 = O.squareCorners.E.x2;
            Y2 = O.squareCorners.E.y2;
        }else{
            X1 = O.x - O.radius;
            Y1 = O.y - O.radius;
            X2 = O.x- -O.radius;
            Y2 = O.y- -O.radius;
        }
        xi=X1;
        while(true){
            if(xi>X2) xi=X2;
            yi=Y1;
            while(true){
                if(yi>Y2) yi=Y2;
                newS[ parseInt(xi/M)+'_'+parseInt(yi/M) ]=1;
                if(yi==Y2) break;
                yi-=-M;
            }
            if(xi==X2) break;
            xi-=-M;
        }

        for(s in oldS)
            if(newS[s]!=1)
                if(typeof this.Omap[O.mapType][s] !='undefined' && typeof this.Omap[O.mapType][s][o] !='undefined')
                    delete this.Omap[O.mapType][s][o];

        for(s in newS)
            if(oldS[s]!=1){
                if(typeof this.Omap[O.mapType][s] == 'undefined')
                    this.Omap[O.mapType][s]={};
                this.Omap[O.mapType][s][o]=1;
            }
    }
    this.removeFromXY = function(o,addToDead){    //!!
        var X1,Y1,X2,Y2,xi,yi,s,oldS={}, O = this.O[o];
        var M = this.MapTileSize;

        X1 = O.x - O.radius;
        Y1 = O.y - O.radius;
        X2 = O.x- -O.radius;
        Y2 = O.y- -O.radius;
        xi=X1;
        while(true){
            if(xi>X2) xi=X2;
            yi=Y1;
            while(true){
                if(yi>Y2) yi=Y2;
                oldS[ parseInt(xi/M)+'_'+parseInt(yi/M) ]=1;
                if(yi==Y2) break;
                yi-=-M;
            }
            if(xi==X2) break;
            xi-=-M;
        }
        this.Omap[O.mapType].elems--;

        for(s in oldS)
            if(typeof this.Omap[O.mapType][s] !='undefined' && typeof this.Omap[O.mapType][s][o] !='undefined')
                delete this.Omap[O.mapType][s][o];

        if(addToDead)
            for(s in oldS){
                if(typeof this.Omap['D'][s]=='undefined')
                    this.Omap['D'][s]={};
                this.Omap['D'][s][o]=1;
            }
    }
    this.getCollidingWithCircle = function(x,y,radius,collisionTab){
        var yi,oX,oY,oR,F,Map,Found={},FoundR={};
        var X1 = x - radius;
        var Y1 = y - radius;
        var X2 = x- -radius;
        var Y2 = y- -radius;
        var M = this.MapTileSize;
        var xi = X1;

        var jestCokolwiek = false;
        for(var ColT in collisionTab)
            if(this.Omap[ collisionTab[ColT] ].elems > 0){ jestCokolwiek=true; break; }
        if(!jestCokolwiek) return {};

        while(true){
            if(xi>X2) xi=X2;
            yi=Y1;
            while(true){
                if(yi>Y2) yi=Y2;
                for(var ColT in collisionTab)
                    if(typeof this.Omap[ collisionTab[ColT] ][ parseInt(xi/M)+'_'+parseInt(yi/M) ] !='undefined'){
                        Map = this.Omap[ collisionTab[ColT] ][ parseInt(xi/M)+'_'+parseInt(yi/M) ];
                        for(F in Map)
                            Found[F]=1;
                    }
                if(yi==Y2) break;
                yi-=-M;
            }
            if(xi==X2) break;
            xi-=-M;
        }

        for(F in Found) if(typeof this.O[F] != 'undefined'){
            if(typeof this.O[F].squareCorners != 'undefined'){
                if(this.checkSquareAndCircle(this.O[F],x,y,radius)){
                    FoundR[F]=1;
                }
            }else if(typeof this.O[F].coneAngle != 'undefined'){
                if(this.checkConeAndCircle(this.O[F],x,y,radius)){
                    FoundR[F]=1;
                }
            } else {
                oX = this.O[F].x-x;
                oY = this.O[F].y-y;
                oR = this.O[F].radius- -radius;
                if(oR*oR > oX*oX- -oY*oY){
                    FoundR[F]=1;
                }
            }
        }
        return FoundR;
    }
    this.getCollidingWithSquare = function(O,collisionTab){
        var yi,oX,oY,oR,F,Map,Found={},FoundR={};
        var X1 = O.squareCorners.E.x1;
        var Y1 = O.squareCorners.E.y1;
        var X2 = O.squareCorners.E.x2;
        var Y2 = O.squareCorners.E.y2;
        var M = this.MapTileSize;
        var xi = X1;

        var jestCokolwiek = false;
        for(var ColT in collisionTab)
            if(this.Omap[ collisionTab[ColT] ].elems > 0){ jestCokolwiek=true; break; }
        if(!jestCokolwiek) return {};

        while(true){
            if(xi>X2) xi=X2;
            yi=Y1;
            while(true){
                if(yi>Y2) yi=Y2;
                for(var ColT in collisionTab)
                    if(typeof this.Omap[ collisionTab[ColT] ][ parseInt(xi/M)+'_'+parseInt(yi/M) ] !='undefined'){
                        Map = this.Omap[ collisionTab[ColT] ][ parseInt(xi/M)+'_'+parseInt(yi/M) ];
                        for(F in Map)
                            Found[F]=1;
                    }
                if(yi==Y2) break;
                yi-=-M;
            }
            if(xi==X2) break;
            xi-=-M;
        }

        for(F in Found) if(typeof this.O[F] !='undefined'){
            if(this.checkSquareAndCircle(O,this.O[F].x,this.O[F].y,this.O[F].radius)){
                FoundR[F]=1;
            }
        }
        return FoundR;
    }
    this.getCollidingWithCone = function(O,collisionTab){
        var IDs={},yi,F,Map,Found={},FoundR={};
        var X1 = O.x - O.radius;
        var Y1 = O.y - O.radius;
        var X2 = O.x- -O.radius;
        var Y2 = O.y- -O.radius;
        var M = this.MapTileSize;
        var xi = X1;

        var jestCokolwiek = false;
        for(var ColT in collisionTab)
            if(this.Omap[ collisionTab[ColT] ].elems > 0){ jestCokolwiek=true; break; }
        if(!jestCokolwiek) return {};

        while(true){
            if(xi>X2) xi=X2;
            yi=Y1;
            while(true){
                if(yi>Y2) yi=Y2;
                IDs[ parseInt(xi/M)+'_'+parseInt(yi/M) ]=1;
                if(yi==Y2) break;
                yi-=-M;
            }
            if(xi==X2) break;
            xi-=-M;
        }

        for(var ID in IDs)
            for(var ColT in collisionTab)
                if(typeof this.Omap[ collisionTab[ColT] ][ ID ] !='undefined'){
                    Map = this.Omap[ collisionTab[ColT] ][ ID ];
                    for(F in Map)
                            Found[F]=1;
                }

        for(F in Found) if(typeof this.O[F] !='undefined'){
            if(this.checkConeAndCircle(O,this.O[F].x,this.O[F].y,this.O[F].radius)){
                FoundR[F]=1;
            }
        }

        return FoundR;
    }
    this.checkSquareAndCircle = function(O,Qx,Qy,Qradius){
        var Radi=Math.PI/180;
        var x2 = O.x- -O.squareLen*Math.sin( (-parseInt(O.squareAngle)-180)*Radi);
        var y2 = O.y- -O.squareLen*Math.cos( (-parseInt(O.squareAngle)-180)*Radi);

        var A = Qx - O.x- -Qradius*Math.sin((-parseInt(O.squareAngle)-180)*Radi);
        var B = Qy - O.y- -Qradius*Math.cos((-parseInt(O.squareAngle)-180)*Radi);
        var C = x2 - O.x- -2*Qradius*Math.sin((-parseInt(O.squareAngle)-180)*Radi);
        var D = y2 - O.y- -2*Qradius*Math.cos((-parseInt(O.squareAngle)-180)*Radi);

        var dot = A*C- -B*D;
        var len_sq = C*C- -D*D;
        var param = -1;
        if (len_sq != 0)
            param = dot / len_sq;

        if(param >=0 && param <= 1){
            var oX = Qx - O.x - param*C;
            var oY = Qy - O.y - param*D;
            var oR = Qradius- -O.squareWidth;
            if(oR*oR > oX*oX- -oY*oY){
                return true;
            }
        }
        return false;
    }
    this.checkConeAndCircle = function(O,Qx,Qy,Qradius){
        var oX = O.x-Qx;
        var oY = O.y-Qy;
        var oR = O.radius- -Qradius;
        if(oR*oR < oX*oX- -oY*oY)
            return false;

        if(O.coneRad2 != 0){
            oR = O.coneRad2 - Qradius;
            if(oR*oR > oX*oX- -oY*oY)
                return false;
        }

        if(O.coneAngle < 180){
            var oA = parseInt(-Math.atan2(oX,oY)*(180/Math.PI)- -360)%360;
            var qA1 = (O.angle - O.coneAngle- -360)%360;
            var qA2 = (O.angle- -O.coneAngle- -360)%360;
            if(qA1 > qA2){
                if(!(oA > qA1 || oA < qA2)) return false;
            }else{
                if(!(oA > qA1 && oA < qA2)) return false;
            }
        }
        return true;
    }
    this.countSquareCorners = function(x,y,angle,len,width){
        var sC={A:{},B:{},C:{},D:{},E:{}};
        var Radi=Math.PI/180;

        sC.A.x = x - width * Math.sin( (-parseInt(angle) - 90)*Radi);
        sC.A.y = y - width * Math.cos( (-parseInt(angle) - 90)*Radi);
        sC.D.x = x - width * Math.sin( (-parseInt(angle)- -90)*Radi);
        sC.D.y = y - width * Math.cos( (-parseInt(angle)- -90)*Radi);

        x -=- len * Math.sin( (-parseInt(angle)-180)*Radi);
        y -=- len * Math.cos( (-parseInt(angle)-180)*Radi);

        sC.B.x = x - width * Math.sin( (-parseInt(angle) - 90)*Radi);
        sC.B.y = y - width * Math.cos( (-parseInt(angle) - 90)*Radi);
        sC.C.x = x - width * Math.sin( (-parseInt(angle)- -90)*Radi);
        sC.C.y = y - width * Math.cos( (-parseInt(angle)- -90)*Radi);

        sC.E.x1 = sC.A.x;
        sC.E.x2 = sC.A.x;
        sC.E.y1 = sC.A.y;
        sC.E.y2 = sC.A.y;

        for(var j in {'B':1,'C':1,'D':1}){
            if(sC.E.x1 > sC[j].x) sC.E.x1 = sC[j].x;
            if(sC.E.x2 < sC[j].x) sC.E.x2 = sC[j].x;
            if(sC.E.y1 > sC[j].y) sC.E.y1 = sC[j].y;
            if(sC.E.y2 < sC[j].y) sC.E.y2 = sC[j].y;
        }

        return sC;
    }

    this.checkHits = function(o){
        var F,O = this.O[o];
        if(typeof O.squareCorners !='undefined'){
            var Found = this.getCollidingWithSquare(O,O.mapCollide);
        }else if(typeof O.coneAngle !='undefined'){
            var Found = this.getCollidingWithCone(O,O.mapCollide);
        }else
            var Found = this.getCollidingWithCircle(O.x,O.y,O.radius,O.mapCollide);
        for(F in Found)
            this.hit(o,F,O.Power);
    }

    this.hit = function(o,q,DMG){
        if(o==q) return 1;
        var O = this.O[o];
        var Q = this.O[q];
        if(typeof O=='undefined') return 1;

        if(O.T=='star'){            var U=Q; Q=O; O=U; }
        if(O.T=='Gstar'){            var U=Q; Q=O; O=U; }
        if(Q.T=='bullet'){            var U=Q; Q=O; O=U; }

        if(O.dontHit){ for(var i=0; i<O.dontHit.length; ++i) if(O.dontHit[i]==Q.mapType) return 1; }
        if(Q.dontHit){ for(var i=0; i<Q.dontHit.length; ++i) if(Q.dontHit[i]==O.mapType) return 1; }

        if(typeof O.SlowDownTo !='undefined'){ this.regionSpeedChange(O,Q); return 1; }
        if(typeof Q.SlowDownTo !='undefined'){ this.regionSpeedChange(Q,O); return 1; }

        if(O.bounceType){    this.regionAngleChange(O,Q); return 1; }
        if(Q.bounceType){    this.regionAngleChange(Q,O); return 1; }

        if(O.vectorType){    this.regionVectorChange(O,Q); return 1; }
        if(Q.vectorType){    this.regionVectorChange(Q,O); return 1; }

        if(O.teleportOnHit){ this.region_teleportOnHit(O,q); return 1; }
        if(Q.teleportOnHit){ this.region_teleportOnHit(Q,o); return 1; }

        if((Q.T=='star' || Q.T=='shieldBlob') && O.T=='ship')
            if(O.speed > 3) O.speed=3;

        if(O.onHit && O.onHit.Do=='explode' && Q.S!=O.S && Q.M!='region'){    this.explodeBomb(o,O.onHit);    return true; }

        if(O.PeriodTime)    this.makePeriodEffect(o,q);
        if(Q.PeriodTime)    this.makePeriodEffect(q,o);

        if(O.OneTimeEffect)    this.makeOneTimeEffect(o,q);
        if(Q.OneTimeEffect)    this.makeOneTimeEffect(q,o);

        DMG=O.Power;

        if(O.T=='missle' || O.T=='bullet'){
            if(O.S==Q.S) return 1;

            if(Q.T=='ship'){
                this.makeDMG(q,DMG,o);
                this.shipFunc_showHealth();
            }
            if(Q.TT=='enemy' || Q.T=='star' || Q.T=='missle' || Q.T=='bullet_bomb' || Q.T=='shieldBlob')
                this.makeDMG(q,DMG,o);
            if(Q.T=='space_mine'){
                this.explodeBomb(q,Q.onDie);
                this.removeObj(o);
            }
            if(Q.T=='healing_missle')
                this.removeObj(q);
        }
    }
    this.makePeriodEffect = function(o,q){
        var O = this.O[o];
        var Q = this.O[q];

        if(Q.T=='bullet_bomb' && (typeof O.dontHurtOwnMissle != 'undefined' && O.dontHurtOwnMissle==true) && O.S==Q.S) return 1;

        var makeAction = false;
        for(var P in Q.periodDMG)
            if(Q.periodDMG[P] < this.tick-1)
                delete Q.periodDMG[P];

        if(typeof Q.periodDMG[o] == 'undefined'){
            if(O.PeriodOffset)
                Q.periodDMG[o] = this.tick- -O.PeriodOffset;
            else
                makeAction = true;

        } else {
            if(Q.periodDMG[o] < this.tick)
                makeAction = true;
        }

        if(makeAction){
            if(O.PeriodDamage){
                if(this.makeDMG(q,O.PeriodDamage))
                    Q.periodDMG[o] = this.tick- -O.PeriodTime;
            }
            if(O.PeriodHeal){
                this.healObj(q,O.PeriodHeal);
                Q.periodDMG[o] = this.tick- -O.PeriodTime;
            }
        }

    }
    this.makeOneTimeEffect = function(o,q){
        var O = this.O[o];
        var Q = this.O[q];

        var makeAction = false;
        if(typeof Q.periodDMG[o] == 'undefined'){
            if(O.OneTimeOffset){
                Q.periodDMG[o] = this.tick- -O.OneTimeOffset;
            } else {
                makeAction = true;
            }
        } else {
            if(Q.periodDMG[o] == this.tick){
                makeAction = true;
                delete Q.periodDMG[o];
            }
            if(Q.periodDMG[o] < this.tick){
                Q.periodDMG[o] = this.tick- -O.OneTimeOffset;
            }
        }

        if(makeAction){
            if(O.OneTimeDamage){
                this.makeDMG(q,O.OneTimeDamage);
                delete(O.OneTimeDamage);
            }
            delete(O.OneTimeEffect);
            if(O.fieldAnim=='ElectricityField'){
                O.animType='EleFieldEnd';
                O.animTick = 0;
                O.DieTime = this.tick- -25;
            }
        }
    }
    this.makeDMG = function(o,DMG,q){
        var O = this.O[o];
        if(O.life < 1) return false;
        if(O.shieldD > 0){
            if(q) this.removeObj(q);
            return false;
        }
        if(O.undestructible){
            if(q) this.removeObj(q);
            return false;
        }
        if(O.energyField > 0){
            if(!q) q=-1;
            this.hitEnergyField(o,q,DMG);
            if(q) this.removeObj(q);
            return true;
        }
        if(O.jump > 0){
            if(this.teleportJump(o,170,Math.random()*360)){
                --O.jump;
                this.checkHits(o);
                this.removeObj(q);
            }
            return false;
        }

        if(q){
            var Q = this.O[q];
            this.putObj_animation('hit', Q.x, Q.y);
            this.removeObj(q);
        } else {
            this.putObj_animation('hit', O.x, O.y);
        }
        for(var Daga=1; Daga < DMG; ++Daga){
            if(Daga >= O.life) break;
            var U = 20;
            DagaDagaX = parseInt(Math.random()*U*2-U);
            DagaDagaY = parseInt(Math.random()*U*2-U);
            this.putObj_animation('hit', (O.x-DagaDagaX), (O.y-DagaDagaY));
        }

        O.life-=DMG;
        if(O.T=='ship') this.shipFunc_showHealth();
        CanvasManager.requestCanvas( o );
        O.gotHitFlag = true;

        if(O.life <= 0){
            this.dieObj(O,o);
        }
        return true;
    }
    this.dieObj = function(O,o){
        if(O.TT=='enemy') --this.EnemiesC;
        if(O.T!='missle' && O.T!='bullet_bomb' && O.T!='space_mine')
            this.putObj_animation('hitBig', O.x, O.y);

        if(O.squadDirectPlace){
            var U = this.O[ O.squadDirectPlace.o ];
            U.squadScheme[ O.squadDirectPlace.i ].Oid=-1;
        }
        if(O.squadScheme)
            this.disbandSquad(O);

        if(O.T=='space_mine') {
            O.toDo=[{T:'explode'}];
            O.gotHitFlag = false;
            O.doingTime = 3;
        }
        else if(O.onDie){
            this.explodeBomb(o,O.onDie);
        }
        else
            this.removeObj(o,true);


        return true;
    }
    this.healObj = function(q,DMG,o){
        var Q = this.O[q];
        if(Q.life == Q.lifeM) return false;
        if(o){
            this.putObj_animation('hit_blue', this.O[o].x, this.O[o].y);
            this.removeObj(o);
        } else{
            this.putObj_animation('hit_healing', Q.x, Q.y);
        }
        Q.life-=-DMG;
        if(Q.life > Q.lifeM) Q.life = Q.lifeM;
        if(q == 0)
            this.shipFunc_showHealth();
        CanvasManager.requestCanvas( q );
    }
    this.hitEnergyField = function(o,q,DMG){
        var O = this.O[o];
        if(q > 0)
            this.putObj_animation('hit_energyField', this.O[q].x, this.O[q].y);
        else {
            this.putObj_animation('hit_energyField', O.x, O.y);
            if(DMG >1)     this.putObj_animation('hit_energyField', (O.x-10), (O.y- -5));
            if(DMG >2)     this.putObj_animation('hit_energyField', (O.x- -5), (O.y- -10));
            if(DMG >3)     this.putObj_animation('hit_energyField',  (O.x- -10), (O.y-5));
        }
        O.energyField-=DMG;
        if(O.energyField < 0) O.energyField = 0;
        if(O.T=='ship') this.shipFunc_showHealth();

    }
    this.regionAngleChange = function(Q,O){
        if(Q.bounceType=='wind'){
            var kat = Q.windAngle;
            var kat2 = (O.angle - kat- -720)%360;
            var BF=1;
            if(Q.bounceForce) BF = Q.bounceForce;
            if(kat2 < 180-BF)    O.angle = (O.angle - BF)%360;
            if(kat2 > 180- -BF)    O.angle = (O.angle- -BF)%360;
            return O;
        }

        if(Q.coneAngle)    return this.regionAngleChange_fieldCone(Q,O);
        if(Q.squareCorners)    return this.regionAngleChange_fieldSquare(Q,O);

        if(Q.bounceType=='straight'){
            var kat = (-Math.atan2(Q.x-O.x,Q.y-O.y)*(180/Math.PI))%360;
            O.angle = kat;
            return O;
        }
        if(Q.bounceType=='diagonal'){
            var kat = (-Math.atan2(Q.x-O.x,Q.y-O.y)*(180/Math.PI)- -360)%360;
            var kat2 = (O.angle - kat - -720)%360;
            if(kat2 > 90 && kat2 < 270)
                O.angle = (kat- -180 - kat2)%360;
            return O;
        }
        if(Q.bounceType=='gentle'){
            var kat = (-Math.atan2(Q.x-O.x,Q.y-O.y)*(180/Math.PI)- -360)%360;
            var dist = Math.sqrt(Math.pow(Q.x-O.x,2),Math.pow(Q.y-O.y,2));
            var kat2 = (O.angle - kat- -720)%360;
            var BF=1;
            if(Q.bounceForce) BF = Q.bounceForce;
            if(O.speed) BF = BF*(O.speed/10) / (dist/100);
            if(BF > 90) BF = 90;
            if(kat2 <= 180)    O.angle = (O.angle - BF)%360;
            if(kat2 > 180)    O.angle = (O.angle- -BF)%360;
            return O;
        }
        if(Q.bounceType=='orbital'){
            var kat = (-Math.atan2(Q.x-O.x,Q.y-O.y)*(180/Math.PI)- -360)%360;
            var kat2 = (O.angle - kat- -720)%360;
            var BF1 = 2, BF2 = 2;
            if(Q.bounceForce1) BF1 = Q.bounceForce1;
            if(Q.bounceForce2) BF2 = Q.bounceForce2;
            if(kat2 <= 90)                    O.angle = (O.angle- -BF2)%360;
            if(kat2 > 90 && kat2 <= 180)    O.angle = (O.angle - BF1)%360;
            if(kat2 > 180 && kat2 <= 270)    O.angle = (O.angle- -BF1)%360;
            if(kat2 > 270)                    O.angle = (O.angle - BF2)%360;
            return O;
        }
        if(Q.bounceType=='gravity'){
            var kat = (-Math.atan2(Q.x-O.x,Q.y-O.y)*(180/Math.PI)- -360)%360;
            var dist = Math.sqrt(Math.pow(Q.x-O.x,2),Math.pow(Q.y-O.y,2));
            var kat2 = (O.angle - kat- -720)%360;
            var BF=1;
            if(Q.bounceForce) BF = Q.bounceForce;
            if(O.speed) BF = BF*(O.speed/10) / (dist/130);
            if(BF > 20) BF = 20;
            if(kat2 < 180-BF)    O.angle = (O.angle- -BF)%360;
            if(kat2 > 180- -BF)    O.angle = (O.angle - BF)%360;
            return O;
        }

        return O;
    }
    this.regionAngleChange_fieldCone = function(Q,O){
        var hitAngle='outside';
        var aX = Q.x-O.x;
        var aY = Q.y-O.y;
        var Radi = Math.PI/180;


        var dist = Math.sqrt(aX*aX- -aY*aY);
        if(Q.radius-dist > dist-Q.coneRad2) hitAngle='inside';

        var oldX = O.x- -20*Math.sin((-parseInt(O.angle))*Radi);    // stare po�o�enie
        var oldY = O.y- -20*Math.cos((-parseInt(O.angle))*Radi);
        var uX = Q.x-oldX;    // odleg�o�� od �rodka ro�ka
        var uY = Q.y-oldY;
        var oAngle = (-Math.atan2(aX,aY)/Radi- -720)%360;
        var oldAngle = -Math.atan2(uX,uY)/Radi;
        var coneAngle1 = (Q.angle - Q.coneAngle- -720)%360;
        var coneAngle2 = (Q.angle- -Q.coneAngle- -720)%360;

        var beenOut = 'nop';
        if(!betweenAngles(oldAngle,coneAngle1,coneAngle2)) beenOut='yes';

        if(beenOut=='yes'){
            var varA1 = Math.abs(oAngle - coneAngle1);
            var varA2 = Math.abs(oAngle - coneAngle2);
            if(varA1 < varA2)    beenOut='tryLeft';
                    else        beenOut='tryRight';


            if(beenOut=='tryLeft'){
                uX = Q.x- -Q.coneRad2 * Math.sin((-coneAngle1-180)*Radi);
                uY = Q.y- -Q.coneRad2 * Math.cos((-coneAngle1-180)*Radi);
                varA1 = (-Math.atan2(O.x-uX,O.y-uY)/Radi- -180)%360;

                uX = Q.x- -Q.radius * Math.sin((-coneAngle1-180)*Radi);
                uY = Q.y- -Q.radius * Math.cos((-coneAngle1-180)*Radi);
                varA2 = (-Math.atan2(O.x-uX,O.y-uY)/Radi- -180)%360;

                if(betweenAngles(O.angle,varA1,varA2)) hitAngle='left';
            }
            if(beenOut=='tryRight'){
                uX = Q.x- -Q.radius * Math.sin((-coneAngle2-180)*Radi);
                uY = Q.y- -Q.radius * Math.cos((-coneAngle2-180)*Radi);
                varA1 = (-Math.atan2(O.x-uX,O.y-uY)/Radi- -180)%360;

                uX = Q.x- -Q.coneRad2 * Math.sin((-coneAngle2-180)*Radi);
                uY = Q.y- -Q.coneRad2 * Math.cos((-coneAngle2-180)*Radi);
                varA2 = (-Math.atan2(O.x-uX,O.y-uY)/Radi- -180)%360;

                if(betweenAngles(O.angle,varA1,varA2)) hitAngle='right';
            }
        }


        if(hitAngle=='left'){
            if(Q.bounceType=='straight'){
                var kat = (coneAngle1-90 - -360)%360;
                O.angle = kat;
                return O;
            }
            if(Q.bounceType=='diagonal'){
                var kat = (coneAngle1-90 - -360)%360;
                var kat2 = (O.angle - kat - -720)%360;
                if(kat2 > 90 && kat2 < 270)
                    O.angle = (kat- -180 - kat2)%360;
                return O;
            }
        }
        if(hitAngle=='right'){
            if(Q.bounceType=='straight'){
                var kat = (coneAngle2- -90 - -360)%360;
                O.angle = kat;
                return O;
            }
            if(Q.bounceType=='diagonal'){
                var kat = (coneAngle2- -90 - -360)%360;
                var kat2 = (O.angle - kat - -720)%360;
                if(kat2 > 90 && kat2 < 270)
                    O.angle = (kat- -180 - kat2)%360;
                return O;
            }
        }
        if(hitAngle=='outside'){
            if(Q.bounceType=='straight'){
                var kat = (-Math.atan2(aX,aY)*(180/Math.PI))%360;
                O.angle = kat;
                return O;
            }
            if(Q.bounceType=='diagonal'){
                var kat = (-Math.atan2(aX,aY)*(180/Math.PI)- -360)%360;
                var kat2 = (O.angle - kat - -720)%360;
                if(kat2 > 90 && kat2 < 270)
                    O.angle = (kat- -180 - kat2)%360;
                return O;
            }
        }
        if(hitAngle=='inside'){
            if(Q.bounceType=='straight'){
                var kat = (-Math.atan2(aX,aY)*(180/Math.PI)- -180)%360;
                O.angle = kat;
                return O;
            }
            if(Q.bounceType=='diagonal'){
                var kat2 = (O.angle - oAngle - -720)%360;
                if(kat2 < 90 || kat2 > 270)
                    O.angle = (oAngle- -180 - kat2)%360;
                return O;
            }
        }

      //  return O;
    }
    this.regionAngleChange_fieldSquare = function(Q,O){
        var A1,A2,M,N,Mar = ['A','B','C','D','A'];
        var Radi = Math.PI/180;

        for(var i=0; i<4; ++i){
            M = Q.squareCorners[Mar[i]];
            N = Q.squareCorners[Mar[i- -1]];

            A1 = (-Math.atan2(O.x-N.x,O.y-N.y)/Radi- -180)%360;
            A2 = (-Math.atan2(O.x-M.x,O.y-M.y)/Radi- -180)%360;

            if(betweenAngles(O.angle,A1,A2)){
                //  this.putObj_animation('hit', M.x, M.y);
                //  this.putObj_animation('hit', N.x, N.y);

                if(Q.bounceType=='straight'){
                    var kat = (-Math.atan2(M.x-N.x,M.y-N.y)*(180/Math.PI)- -90)%360;
                    O.angle = kat;
                    return O;
                }
                if(Q.bounceType=='diagonal'){
                    var kat = (-Math.atan2(M.x-N.x,M.y-N.y)*(180/Math.PI)- -90)%360;
                    var kat2 = (O.angle - kat - -720)%360;
                    if(kat2 > 90 && kat2 < 270)
                        O.angle = (kat- -180 - kat2)%360;
                    return O;
                }
                return O;
            }
        }
        return O;
    }
    this.regionVectorChange = function(Q,O){
        if(Q.vectorType=='wind'){
            if( typeof O.vector == 'undefined') O.vector = [];
            O.vector[ O.vector.length ] = {angle: Q.windAngle, speed: Q.vectorForce};
            return O;
        }
        if(Q.vectorType=='gentle'){
            var dist = Math.sqrt(Math.pow(Q.x-O.x,2),Math.pow(Q.y-O.y,2));
            var angleToCenter = (-Math.atan2(Q.x-O.x,Q.y-O.y)*(180/Math.PI)- -180)%360;
            var force = Q.vectorForce * ((Q.radius - dist)/Q.radius);
            if( typeof O.vector == 'undefined') O.vector = [];
            O.vector[ O.vector.length ] = {angle: angleToCenter, speed: force};
            return O;
        }
        if(Q.vectorType=='orbital'){
            var dist = Math.sqrt(Math.pow(Q.x-O.x,2),Math.pow(Q.y-O.y,2));
            var angleToCenter = (-Math.atan2(Q.x-O.x,Q.y-O.y)*(180/Math.PI)- -90)%360;
            var force = Q.vectorForce- -Q.vectorForceAdd * ((Q.radius - dist)/Q.radius);
            if( typeof O.vector == 'undefined') O.vector = [];
            O.vector[ O.vector.length ] = {angle: angleToCenter, speed: force};
            return O;
        }
        if(Q.vectorType=='gravity'){
            var angleToCenter = (-Math.atan2(Q.x-O.x,Q.y-O.y)*(180/Math.PI)- -180)%360;
            if( typeof O.vector == 'undefined') O.vector = [];
            O.vector[ O.vector.length ] = {angle: angleToCenter, speed: Q.vectorForce};
            return O;
        }

        return O;
    }
    this.region_teleportOnHit = function(TP,o){
        var Angle=0,Dist=100,O = this.O[o];


          //  {What:{RoundField:1},objData:{x:-700,y:-67, radius:10, simpleFilling: 'rgba(155,155,255,0.8)', teleportOnHit: 'random', teleportOnHitDist: 500}},
          //  {What:{RoundField:1},objData:{x:-600,y:0, radius:10, simpleFilling: 'rgba(155,155,255,0.8)', teleportOnHit: 120,  teleportOnHitDist: 300, teleportOnHitDistPlus: 300}},
          //  {What:{RoundField:1},objData:{x:-700,y:67, radius:10, simpleFilling: 'rgba(155,155,255,0.8)', teleportOnHit: 'aligned', teleportOnHitDist: 1000}},

        if(!isNaN(TP.teleportOnHit)){
            Angle = TP.teleportOnHit;
        } else if(TP.teleportOnHit=='random'){
            Angle = parseInt(Math.random()*360);
        } else if(TP.teleportOnHit=='aligned'){
            Angle = O.angle;
        }
        Dist = TP.teleportOnHitDist;
        if(TP.teleportOnHitDistPlus) Dist-=- parseInt(Math.random()*TP.teleportOnHitDistPlus);


        if(this.teleportJump(o,Dist,Angle)){
            this.checkHits(o);
        }
    }
    this.regionSpeedChange = function(Q,O){
        if(Q.SlowDownTo >= O.speed) return 1;
        if(Q.SlowDownBy){
            O.speed-=Q.SlowDownBy;
            if(O.speed < Q.SlowDownTo)
                O.speed = Q.SlowDownTo;
        }else{
            O.speed = Q.SlowDownTo;
        }
    }

    this.shootBullet = function(o,Angle,Speed,Dec,Power){
        var O = this.O[o];
        var L = this.putObj('bullet','comp',O.S,O.x,O.y);
        this.O[L].speed = Speed;
        this.O[L].dec = Dec;
        this.O[L].angle = Angle;
        this.O[L].Power = Power;
    }
    this.shootBulletOnSide = function(o,Enemy,Speed,Dec,SideAngle,SideDist,Power){
        var O = this.O[o];
        var Xp = O.x- -SideDist * Math.sin((-parseInt(O.angle- -SideAngle)-180)*(Math.PI/180));
        var Yp = O.y- -SideDist * Math.cos((-parseInt(O.angle- -SideAngle)-180)*(Math.PI/180));

        var X = Xp-this.O[Enemy].x;
        var Y = Yp-this.O[Enemy].y;
        var Angle = parseInt(- (Math.atan2(X,Y)*180/Math.PI))%360;

        var L = this.putObj('bullet','comp',O.S,Xp,Yp);
        this.O[L].speed = Speed;
        this.O[L].dec = Dec;
        this.O[L].angle = Angle;
        this.O[L].Power = Power;
    }
    this.shootBulletOnSide2 = function(o,Enemy,Speed,Dec,SideAngle,SideDist,Power){
        var O = this.O[o];

        var X = O.x-this.O[Enemy].x;
        var Y = O.y-this.O[Enemy].y;
        var Angle = parseInt(- (Math.atan2(X,Y)*180/Math.PI))%360;
        var Xp = O.x- -SideDist * Math.sin((-parseInt(O.angle- -SideAngle)-180)*(Math.PI/180));
        var Yp = O.y- -SideDist * Math.cos((-parseInt(O.angle- -SideAngle)-180)*(Math.PI/180));

        var L = this.putObj('bullet','comp',O.S,Xp,Yp);
        this.O[L].speed = Speed;
        this.O[L].dec = Dec;
        this.O[L].angle = Angle;
        this.O[L].Power = Power;
    }
    this.shootMissle = function(o,Angle,Speed,Dec,SpeedT){
        var O = this.O[o];
        var L = this.putObj('missle','comp',O.S,O.x,O.y);
        this.O[L].speed = Speed;
        this.O[L].doingTime = Dec;
        this.O[L].Manouver = 'followEnemy';
        this.O[L].angle = Angle;
        this.O[L].speedT = SpeedT || 3;
    }
    this.shootHealingMissle = function(o,Target,Angle){
        var O = this.O[o];
        var L = this.putObj('healing_missle','comp',O.S,O.x,O.y);
        this.O[L].angle = Angle;
        this.O[L].target = Target;
    }
    this.dropSpaceMine = function(o,Angle){
        var O = this.O[o];
        var L = this.putObj('space_mine','comp',O.S,O.x,O.y);
        if(Angle){
            this.O[L].angle=Angle;
            this.O[L].speed=20;
            this.O[L].dec=20;
            this.O[L].toDo='wait';
        } else {
            delete this.Omoving[L];
        }
    }
    this.shootBomb = function(o,Angle,Speed,Dec,Power,Radius){
        var O = this.O[o];
        var L = this.putObj('bullet_bomb','comp',O.S,O.x,O.y);
        this.O[L].speed = Speed;
        this.O[L].dec = Dec;
        this.O[L].angle = Angle;
        this.O[L].Power = Power;
        this.O[L].Dist = Radius;
    }
    this.explodeBomb = function(o,explodeObj){
        var i,L,O = this.O[o];

        if(explodeObj.explodeType=='nails'){
            for(i=0; i<360; i-=-explodeObj.NailsRad){
                if(explodeObj.NailsNeutral)
                    L = this.putObj('bullet','comp',3,O.x,O.y);
                else
                    L = this.putObj('bullet','comp',O.S,O.x,O.y);
                this.O[ L ].speed = explodeObj.NailsSpeed;
                if(explodeObj.NailsSpeedPlus)
                    this.O[ L ].speed-=-Math.random()*explodeObj.NailsSpeedPlus;
                this.O[ L ].dec = explodeObj.NailsDec;
                if(explodeObj.NailsDecPlus)
                    this.O[ L ].dec-=-parseInt(Math.random()*explodeObj.NailsDecPlus);
                this.O[ L ].angle = i;
                this.O[ L ].Power = 1;
                if(explodeObj.NailsAngleCenter){
                    if(explodeObj.NailsAngleBoth==1 && L%2==0)
                        this.O[ L ].speedT = - explodeObj.NailsAngleCenter;
                    else
                        this.O[ L ].speedT = explodeObj.NailsAngleCenter;
                }
            }
        }
        else if(explodeObj.explodeType=='nailsCone'){
            for(i=0; i<explodeObj.Nails; ++i){
                if(explodeObj.NailsNeutral)
                    L = this.putObj('bullet','comp',3,O.x,O.y);
                else
                    L = this.putObj('bullet','comp',O.S,O.x,O.y);
                this.O[ L ].angle = O.angle - explodeObj.NailsRad/2- -i*(explodeObj.NailsRad/explodeObj.Nails);
                this.O[ L ].speed = explodeObj.NailsSpeed;
                if(explodeObj.NailsSpeedPlus)
                    this.O[ L ].speed-=-Math.random()*explodeObj.NailsSpeedPlus;
                this.O[ L ].dec = explodeObj.NailsDec;
                if(explodeObj.NailsDecPlus)
                    this.O[ L ].dec-=-parseInt(Math.random()*explodeObj.NailsDecPlus);
                this.O[ L ].Power = 1;
                if(explodeObj.NailsAngleCenter)
                    this.O[ L ].speedT = -((i- -0.5)/(explodeObj.Nails/2)- 1) * explodeObj.NailsAngleCenter;


            }
        }
        else if(explodeObj.explodeType=='roundField'){
            L = this.putObj('RoundField','region',O.S,O.x,O.y);
            this.O[ L ].radius = explodeObj.radius;
            if(explodeObj.PeriodDamage){
                this.O[ L ].PeriodDamage = explodeObj.PeriodDamage;
                this.O[ L ].PeriodTime = explodeObj.PeriodTime;
                this.O[ L ].PeriodOffset = explodeObj.PeriodOffset;
            }
            if(explodeObj.dontHit){
                this.O[ L ].dontHit = cloneObj(explodeObj.dontHit);
            }
            if(explodeObj.BounceForce){
                this.O[ L ].bounceForce = explodeObj.BounceForce;
                this.O[ L ].bounceType = explodeObj.BounceAngle;
            }
            this.O[L].DieTime = this.tick- -explodeObj.ExpireTime;
            this.setRegionAnimation(L,explodeObj.fieldAnim);
        }
        else {
            L = this.putObj('destruction_field','region',O.S,O.x,O.y);
            this.O[L].radius = explodeObj.Dist;
            this.O[L].ActiveTime = this.tick- -2;
            this.O[L].DieTime = this.tick- -6;
            this.O[L].PeriodDamage = explodeObj.Power;
            this.O[L].PeriodTime = 10;
            this.O[L].dontHurtOwnMissle = true;
            this.O[L].dontHit=['B','BE'];
            this.O[L].undestructible=1;
            this.putObj_animation('explosion_'+explodeObj.Dist, O.x, O.y);
        }
        if(explodeObj.Shards)
            if(explodeObj.ShardsNum){
                var iRad = parseInt(Math.random()*360);
                for(i=0; i < explodeObj.ShardsNum; ++i){
                    L = this.putObj('bullet_bomb','comp',O.S,O.x,O.y);
                    this.O[L].angle = parseInt(iRad- -i*(360/explodeObj.ShardsNum)- -360)%360;
                    this.O[L].speed = explodeObj.Shards.Speed;
                    this.O[L].doingTime = explodeObj.Shards.Dec;
                    if(explodeObj.Shards.SpeedPlus)
                        this.O[ L ].speed-=-Math.random()*explodeObj.Shards.SpeedPlus;
                    if(explodeObj.Shards.DecPlus)
                        this.O[ L ].doingTime-=-parseInt(Math.random()*explodeObj.Shards.DecPlus);

                    if(explodeObj.Shards.onHit)        this.O[L].onHit = cloneObj( explodeObj.Shards.onHit );
                    if(explodeObj.Shards.onDie)        this.O[L].onDie = cloneObj( explodeObj.Shards.onDie );
                    if(explodeObj.Shards.onExpire)    this.O[L].onExpire = cloneObj( explodeObj.Shards.onExpire );
                }
            } else {
                for(i in explodeObj.Shards){
                    L = this.putObj('bullet_bomb','comp',O.S,O.x,O.y);
                    this.O[L].angle = (O.angle- -explodeObj.Shards[i].Angle- -360)%360;
                    this.O[L].speed = explodeObj.Shards[i].Speed;
                    this.O[L].doingTime = explodeObj.Shards[i].Dec;

                    this.O[L].onHit = cloneObj( explodeObj.Shards[i].onHit );
                    this.O[L].onExpire = cloneObj( explodeObj.Shards[i].onExpire );
                }
            }

        this.removeObj(o);

        /*
        this.O[L].onHit = {Do:'explode',Power: 4, Dist: 35};
        this.O[L].onExpire = {Do:'explode',Power: 4, Dist: 35, ShardsNum: 5, Shards:{
            onHit: {Do:'explode',Power: 4, Dist: 35},
            onDie: {Do:'explode',explodeType: 'nails', NailsRad: 12, NailsSpeed: 5, NailsSpeedPlus: 5, NailsDec: 2, NailsDecPlus: 6},
            Dec: 12,
            DecPlus: 10,
            Speed: 3,
            SpeedPlus: 3,
        }};

        {Do:'explode',Power: 4, Dist: 35, explodeType: 'nails', NailsRad: 8, NailsSpeed: 10, NailsSpeedPlus: 0, NailsDec: 36, NailsDecPlus: 10, NailsAngleCenter: 8, NailsAngleBoth: 1};

        this.O[L].onExpire = {Do:'explode',Power: 4, Dist: 35, explodeType: 'nails', NailsRad: 12, NailsSpeed: 5, NailsSpeedPlus: 5, NailsDec: 6, NailsDecPlus: 6};

        this.O[L].onExpire = {Do:'explode',Power: 4, Dist: 35, explodeType: 'nails', NailsRad: 8, NailsSpeed: 5, NailsSpeedPlus: 5, NailsDec: 36, NailsDecPlus: 6, NailsAngleCenter: 8};

        this.O[L].onExpire = {Do:'explode',Power: 4, Dist: 35, explodeType: 'nails', NailsRad: 8, NailsSpeed: 0, NailsSpeedPlus: 10, NailsDec: 36, NailsDecPlus: 6, NailsAngleCenter: 8, NailsAngleBoth: 1};

        this.O[L].onHit = this.O[L].onExpire = this.O[L].onDie = {Do:'explode',explodeType: 'nailsCone', Nails: 40, NailsRad: 220, NailsSpeed: 5, NailsSpeedPlus: 2, NailsDec: 28, NailsDecPlus: 6, NailsAngleCenter: 3};

        Bullet mine:
        onHit: {Do:'explode',Power: 4, Dist: 35, explodeType: 'nails', NailsRad: 24, NailsSpeed: 4, NailsSpeedPlus: 6, NailsDec: 16, NailsDecPlus: 6, NailsNeutral: true},
        onDie: {Do:'explode',Power: 4, Dist: 35, explodeType: 'nails', NailsRad: 24, NailsSpeed: 4, NailsSpeedPlus: 6, NailsDec: 16, NailsDecPlus: 6, NailsNeutral: true}


        this.O[L].onExpire = {Do:'explode',explodeType: 'nailsCone', Nails: 20, NailsRad: 30, NailsSpeed: 5, NailsSpeedPlus: 5, NailsDec: 6, NailsDecPlus: 6};

        this.O[L].onExpire = {Do:'explode',explodeType: 'nailsCone', Nails: 20, NailsRad: 120, NailsSpeed: 5, NailsSpeedPlus: 2, NailsDec: 28, NailsDecPlus: 6, NailsAngleCenter: 3};

        this.O[L].onExpire = {Do:'explode',explodeType: 'roundField', radius:200, fieldAnim: 'DestructionField', PeriodDamage: 1, PeriodTime: 40, PeriodOffset: 50, dontHit:['B','BE']};

        this.O[L].onHit = {Do:'explode',Power: Power || 4, Dist: Dist || 35};
        this.O[L].onExpire = {Do:'explode',explodeType: 'roundField', radius:80, fieldAnim: 'DestructionField', PeriodDamage: 1, PeriodTime: 10, PeriodOffset: 10, ExpireTime: 300};
        this.O[L].onDie = {Do:'explode',explodeType: 'roundField', radius:30, fieldAnim: 'DestructionField', PeriodDamage: 1, PeriodTime: 10, PeriodOffset: 10, ExpireTime: 300};


        this.O[L].onExpire = {Do:'explode',Power: 4, Dist: 35, Shards:[
            {    Dec: 8, Speed: 7, Angle: -30,
                onHit: {Do:'explode',Power: 4, Dist: 35},
                onDie: {Do:'explode',Power: 4, Dist: 35, Shards:[
                    {    Dec: 8, Speed: 7, Angle: -15,
                        onHit: {Do:'explode',Power: 4, Dist: 35},
                        onDie: {Do:'explode',Power: 4, Dist: 35, Shards:[
                            {    Dec: 12, Speed: 5, Angle: 0,
                                onHit: {Do:'explode',Power: 4, Dist: 80},
                                onDie: {Do:'explode',Power: 4, Dist: 80},
                            }]
                        },
                    }]
                }
            },{    Dec: 16, Speed: 7, Angle: 0,
                onHit: {Do:'explode',Power: 4, Dist: 80},
                onDie: {Do:'explode',Power: 4, Dist: 80, Shards:[
                    {    Dec: 12, Speed: 7, Angle: 0,
                        onHit: {Do:'explode',Power: 4, Dist: 120},
                        onDie: {Do:'explode',Power: 4, Dist: 120},
                    }]
                }
            },{    Dec: 8, Speed: 7, Angle: 30,
                onHit: {Do:'explode',Power: 4, Dist: 35},
                onDie: {Do:'explode',Power: 4, Dist: 35, Shards:[
                    {    Dec: 8, Speed: 7, Angle: 15,
                        onHit: {Do:'explode',Power: 4, Dist: 35},
                        onDie: {Do:'explode',Power: 4, Dist: 35, Shards:[
                            {    Dec: 12, Speed: 5, Angle: 0,
                                onHit: {Do:'explode',Power: 4, Dist: 80},
                                onDie: {Do:'explode',Power: 4, Dist: 80},
                            }]
                        },
                    }]
                }
            }]
        };
        */

    }
    this.addShield = function(o,Duration){
        var O = this.O[o];
        if(O.T=='koriaz' || O.T=='dandares' || O.T=='star' || O.T=='starG' || O.T=='missle') return false;
        //  if(typeof O.shieldD == 'undefined' || O.shieldD < 0)
        //      $('#O_'+o).append('<div class="shield"></div>');
        O.shieldD = Duration;
    }
    this.addEnergyField = function(o,Amount,ReliefTime){
        var O = this.O[o];
        O.energyField = Amount;
        O.energyFieldMax = Amount;
        O.enegryFieldRelief = 0;
        O.enegryFieldRefielTime = ReliefTime;
        //  $('#O_'+o).prepend('<div class="energyField"></div>');
    }
    this.shootLaser = function(o,Distance,Damage,angle){
        var X,Y,Ox,Oy,Found,D,F,shipShoot=false, O = this.O[o];

        var Angle = O.laserAngle;
        if(typeof angle != 'undefined')
            Angle = angle;

        var enemyArr=['P','M','E','R'];
        if(o==0) enemyArr=['E','ME','A','R'];

        var L = this.putObj_directAnim('laserShoot', {timeDeath: 12});
        Ox = O.x;
        Oy = O.y;

        var pathD =['M',{x: Ox, y: Oy}];
        var Damaged={};
        for(D=0; D<=Distance; D+=10){
            Ox = Ox- - 10 * Math.sin( (-parseInt(Angle)-180)*(Math.PI/180));
            Oy = Oy- - 10 * Math.cos( (-parseInt(Angle)-180)*(Math.PI/180));

            Found = this.getCollidingWithCircle(Ox, Oy, 10, enemyArr);

            for(F in Found){
                if(this.O[F].bounceType){
                    pathD=pathD.concat(['L',{x: Ox, y: Oy}]);
                    Angle = this.regionAngleChange(this.O[F],{x:Ox,y:Oy,angle:Angle,speed:20}).angle;
                } else {
                    Damaged[F]=1;
                }
            }
        }
        this.O[ L ].pathD=pathD.concat(['L',{x: Ox, y: Oy}]);


        delete(Damaged[o]);
        for(var d in Damaged)
            this.makeDMG(d,Damage);


    }
    this.teleportJump = function(o,Distance,angle){
        var L,Angle,F,Found,oldX,oldY,Ox,Oy,O = this.O[o];

        this.putObj_animation('hit_blue', O.x, O.y);
        L = this.putObj_directAnim('TP_track', {timeDeath: 18});
        oldX = Ox = O.x;
        oldY = Oy = O.y;
        Angle = angle;

        var pathD =['M',{x: Ox, y: Oy}];
        for(var D=0; D<=Distance; D+=10){
            Ox = Ox- - 10 * Math.sin( (-parseInt(Angle)-180)*(Math.PI/180));
            Oy = Oy- - 10 * Math.cos( (-parseInt(Angle)-180)*(Math.PI/180));

            Found = this.getCollidingWithCircle(Ox, Oy, O.radius, ['A','R']);
            for(F in Found)
                if(this.O[F].bounceTeleport){
                    pathD=pathD.concat(['L',{x: Ox, y: Oy}]);
                    Angle = this.regionAngleChange(this.O[F],{x:Ox,y:Oy,angle:Angle,speed:10}).angle;
                }
        }
        O.x = Ox;
        O.y = Oy;
        this.O[ L ].pathD=pathD.concat(['L',{x: Ox, y: Oy}]);
        if(O.T!='bullet')
            this.putOnXY(o,oldX,oldY);
        this.putObj_animation('hit_blue', Ox, Oy);

        return true;
    }
    this.showEnemySpotRegion = function(o){
        var html,O = this.O[o];
        O.showSpotRegion = true;

        if(typeof O.spotLvl =='undefined') return false;
        var ST = O.spotArr[ O.spotLvl ];
        if(ST.T=='double'){
            var X1 = ST.Rad * Math.sin((180-ST.Angle2)*(Math.PI/180));
            var Y1 = ST.Rad * Math.cos((180-ST.Angle2)*(Math.PI/180));
            var X2 = ST.Rad2 * Math.sin((180-ST.Angle2)*(Math.PI/180));
            var Y2 = ST.Rad2 * Math.cos((180-ST.Angle2)*(Math.PI/180));

            var X3 = ST.Rad * Math.sin((180- -ST.Angle2)*(Math.PI/180));
            var Y3 = ST.Rad * Math.cos((180- -ST.Angle2)*(Math.PI/180));
            var X4 = ST.Rad2 * Math.sin((180- -ST.Angle2)*(Math.PI/180));
            var Y4 = ST.Rad2 * Math.cos((180- -ST.Angle2)*(Math.PI/180));

            var Wump = 0;
            if(ST.Angle2*2 > 179) Wump=1;

            var d ='M0 '+(ST.Rad)+' A'+ST.Rad+' '+ST.Rad+' 0 0,0 '+X1+' '+Y1+' L'+X2+' '+Y2+' A'+ST.Rad2+' '+ST.Rad2+' 0 '+Wump+',0 '+X4+' '+Y4+' L'+X3+' '+Y3+' A'+ST.Rad+' '+ST.Rad+' 0 0,0 0 '+(ST.Rad)+' ';

            html='<svg class="spotRegion"><path  fill="yellow" fill-opacity="0.1" d="'+d+'"></svg>';
        }
        //  if(ST.T=='single'){
        //      var d ='M0 '+ST.Rad+' A'+ST.Rad+' '+ST.Rad+' 0 0,0 0 -'+ST.Rad+' A'+ST.Rad+' '+ST.Rad+' 0 0,0 0 '+ST.Rad+'';
        //      html='<svg class="spotRegion"><path  fill="yellow" fill-opacity="0.1" d="'+d+'"></svg>';
        //  }
        //  $('#O_'+o+' .spotRegion').remove();
        //  $('#O_'+o+'').append(html);

    }

    this.prepareSquadScheme = function(O){
        O.squadScheme = [];
        var SST = O.squadSchemeType;

        if(SST.t == 'round'){
            var u = parseInt(Math.random()*SST.count);
            for(var i= 0; i<SST.count; ++i){
                O.squadScheme[i] = {
                    angle: ((360/SST.count)*(i- -u))%360,
                    radius: SST.radius,
                    Oid: -1
                };
            }
        }
    }
    this.bindWithSquad = function(o,i,s){
        var O = this.O[o];
        var S = this.O[s];

        S.squadDirectPlace = {o:o, i:i};
        S.speed = 0;
        O.squadScheme[i].Oid = s;
    }
    this.disbandSquad = function(O){
        // Maybe we want to change squad chef?

        // If we disband then:
        for(var i=0; i<O.squadScheme.length; ++i)
            if(O.squadScheme[i].Oid != -1){
                var sO = this.O[ O.squadScheme[i].Oid ];
                if(sO.T=='shieldBlob'){
                    sO.speed = 8;
                    sO.angle = O.angle- -O.squadScheme[i].angle;
                    this.Ocomp[ O.squadScheme[i].Oid ]=1;
                    sO.M = 'comp';
                    sO.Manouver = 'decay';
                    sO.doingTime = 500;
                }

                delete sO.squadDirectPlace;
            }
    }
    this.checkSquadSchemeMakes = function(O){

        //  0:{ angle: 0, radius: 0, id: -1, make: {What:{RoundField:1},objData:{x:0,y:-1000, angle: 0, radius: 150, colorInactive: false, colorActive: 'rgba(255,0,0,0.4)', OneTimeEffect: 1, OneTimeOffset: 10, OneTimeDetect: 1, dontHit:['B','BE','E','M','ME','A']}}}

        for(var i in O.squadScheme)
            if(typeof O.squadScheme[i].make != 'undefined'){


            }

    }

    this.shipShoot = function(AngleMod,Speed,Dec,Power){
        var O = this.O[0];
        var Angle = parseInt(- (Math.atan2(this.mouseX-O.x,this.mouseY-O.y)*180/Math.PI)- -180)%360;
        if(AngleMod) Angle-=-AngleMod;
        this.shootBullet(0,Angle,(Speed || 15),(Dec || 30),Power);
    }
    this.shipShootOnSide = function(SideAngle,SideDist,Speed,Dec,Power){
        var O = this.O[0];
        var Xp = O.x- -SideDist * Math.sin((-parseInt(O.angle- -SideAngle)-180)*(Math.PI/180));
        var Yp = O.y- -SideDist * Math.cos((-parseInt(O.angle- -SideAngle)-180)*(Math.PI/180));

        var Angle = parseInt(- (Math.atan2(this.mouseX-O.x,this.mouseY-O.y)*180/Math.PI)- -180)%360;
        var L = this.putObj('bullet','comp',O.S,Xp,Yp);
        this.O[L].speed = Speed || 15;
        this.O[L].dec = Dec || 30;
        this.O[L].angle = Angle;
        this.O[L].Power = Power;
    }
    this.shipShootMissle = function(Enemy,Angle,Speed,Dec,SpeedT,Power){
        var O = this.O[0];
        var E = this.O[Enemy];

        var L = this.putObj('missle','comp',O.S,O.x,O.y);
        this.O[L].speed = Speed || 12;
        this.O[L].speedT = SpeedT || 3;
        this.O[L].doingTime = Dec || 30;
        this.O[L].FollowWho = Enemy;
        this.O[L].Power = Power;
        this.O[L].angle = Angle;
        this.O[L].onHit = {Do:'explode',Power: 3,Dist: 35};
        // this.O[L].onDie = {Do:'explode',Power: 3,Dist: 35};
        this.O[L].onExpire = {Do:'explode',Power: 3,Dist: 35};
    }
    this.shipShootBomb = function(Speed,Dec,Power,Dist){
        var O = this.O[0];
        var Angle = parseInt(- (Math.atan2(this.mouseX-O.x,this.mouseY-O.y)*180/Math.PI)- -180)%360;
        var L = this.putObj('bullet_bomb','comp',O.S,O.x,O.y);
        this.O[L].speed = Speed || 10;
        this.O[L].doingTime = Dec || 30;
        this.O[L].angle = Angle;

        this.O[L].onHit = this.O[L].onDie = this.O[L].onExpire = {Do:'explode',Power: 7, Dist: 80};

    }
    this.shipShootLaser = function(Distance,Damage){
        var O = this.O[0];
        var Angle = parseInt(- (Math.atan2(this.mouseX-O.x,this.mouseY-O.y)*180/Math.PI)- -180)%360;
        this.shootLaser(0,Distance,Damage,Angle);
    }


    this.shipFunc_glueFireToLaser = function(){
        var F,X,Y,R,dist=1000000,laserAim=false,radius = this.SHIP.GlueFireToLaser;
        var Found = this.getCollidingWithCircle(this.mouseX,this.mouseY,radius,['E','ME','A','R']);

        var laserAim = false;
        var dist = 1000000;
        for(F in Found){
            if(this.O[F].shieldD > 0) continue;
            if(this.O[F].undestructible > 0) continue;
            X = this.mouseX - this.O[F].x;
            Y = this.mouseY - this.O[F].y;
            R = X*X- -Y*Y;
            if(R < dist){
                laserAim = F;
                dist = R;
            }
        }

        if(laserAim != false){
            this.mouseX = this.O[laserAim].x;
            this.mouseY = this.O[laserAim].y;
            X = this.O[laserAim].x-this.O[0].x- -this.Dx/2;
            Y = this.O[laserAim].y-this.O[0].y- -this.Dy/2;
            $('#gameboardMarkers').append('<div class="estimationMarkers LaserAim" style="top: '+Y+'px; left: '+X+'px;"><span style="width: '+(2*radius)+'px; height: '+(2*radius)+'px; top: -'+(radius- -2)+'px; left: -'+(radius- -2)+'px;"></span></div>');
        }
    }
    this.shipFunc_glueFireToMissle = function(aimRadius){
        var F,X,Y,R,dist=1000000,laserAim=false;
        var Found = this.getCollidingWithCircle(this.mouseX,this.mouseY,aimRadius,['E','ME','A','R']);

        var missleAim = false;
        var dist = 1000000;
        for(F in Found){
            if(this.O[F].shieldD > 0) continue;
            if(this.O[F].undestructible > 0) continue;
            X = this.mouseX - this.O[F].x;
            Y = this.mouseY - this.O[F].y;
            R = X*X- -Y*Y;
            if(R < dist){
                missleAim = F;
                dist = R;
            }
        }

        if(missleAim != false){
            this.missleAim = missleAim;

            X = this.O[missleAim].x-this.O[0].x- -this.Dx/2;
            Y = this.O[missleAim].y-this.O[0].y- -this.Dy/2;
            $('#gameboardMarkers').append('<div class="estimationMarkers MissleAim" style="top: '+Y+'px; left: '+X+'px;"><span style="width: '+(2*aimRadius)+'px; height: '+(2*aimRadius)+'px; top: -'+(aimRadius- -2)+'px; left: -'+(aimRadius- -2)+'px;"></span></div>');

        } else {
            this.missleAim = false;
        }
    }
    this.shipFunc_esteemedPositions = function(O,F){
        EsteemedPos={};
        var WU;
        var Found = this.getCollidingWithCircle(this.O[0].x,this.O[0].y,800,['E']);
        for(var Fo in Found){
            if(this.O[Fo].shieldD > 0) continue;
            if(this.O[Fo].undestructible > 0) continue;
            if(this.O[Fo].life < 1) continue;
            WU = this.countFutureShoot(Fo,O.x,O.y,F.Speed,F.Dec);
            if(WU.r){
                EsteemedPos[Fo]={x:WU.x,y:WU.y};
                var X = WU.x - this.O[0].x- -this.Dx/2;
                var Y = WU.y - this.O[0].y- -this.Dy/2;
                $('#gameboardMarkers').append('<div class="estimationMarkers" style="top: '+Y+'px; left: '+X+'px;"></div>');
            }
        }
        return EsteemedPos;
    }
    this.shipFunc_glueFireToEstimated = function(EsteemedPos){

        var jest = false;
        var Rad = this.SHIP.GlueFireToEstimated;
        var Rad2 = Rad*Rad;
        var dist = 1000000;
        for(F in EsteemedPos){
            if(this.O[F].shieldD > 0) continue;
            if(this.O[F].undestructible > 0) continue;
            if(this.O[F].life < 1) continue;
            X = this.mouseX - EsteemedPos[F].x;
            Y = this.mouseY - EsteemedPos[F].y;
            R = X*X- -Y*Y;
            if(R < dist && R < Rad2){
                jest = F;
                dist = R;
            }
        }
        if(jest != false){
            this.mouseX = EsteemedPos[jest].x;
            this.mouseY = EsteemedPos[jest].y;
            var wX = this.mouseX - this.O[0].x- -this.Dx/2;
            var wY = this.mouseY - this.O[0].y- -this.Dy/2;

            $('#gameboardMarkers').append('<div class="estimationMarkers GluedOne" style="top: '+wY+'px; left: '+wX+'px;"><span style="width: '+(2*Rad)+'px; height: '+(2*Rad)+'px; top: -'+(Rad- -2)+'px; left: -'+(Rad- -2)+'px;"></span></div>');

            return true;
        }

        for(var F in this.O){
            if(!(this.O[F].T=='star' || this.O[F].T=='space_mine')) continue;
            if(this.O[F].shieldD > 0) continue;
            if(this.O[F].undestructible > 0) continue;
            if(this.O[F].life < 1) continue;
            X = this.mouseX - this.O[F].x;
            Y = this.mouseY - this.O[F].y;
            R = X*X- -Y*Y;
            if(R < dist && R < Rad2){
                jest = F;
                dist = R;
            }
        }
        if(jest != false){
            this.mouseX = this.O[jest].x;
            this.mouseY = this.O[jest].y;
            var wX = this.mouseX - this.O[0].x- -this.Dx/2;
            var wY = this.mouseY - this.O[0].y- -this.Dy/2;

            $('#gameboardMarkers').append('<div class="estimationMarkers GluedOne" style="top: '+wY+'px; left: '+wX+'px;"><span style="width: '+(2*Rad)+'px; height: '+(2*Rad)+'px; top: -'+(Rad- -2)+'px; left: -'+(Rad- -2)+'px;"></span></div>');
        }
    }
    this.shipFunc_teleport = function(Fx,TeleMod){
        --this.SHIP.Modules[TeleMod].TeleLoad;
        var O = this.O[0];
        var oldX = O.x;
        var oldY = O.y;
        var iX = O.x-this.mouseX;
        var iY = O.y-this.mouseY;
        var iDist = Math.sqrt(iX*iX- -iY*iY);
        var iRad = parseInt(- (Math.atan2(iX,iY)*180/Math.PI))%360;
        if(iDist > Fx.Speed)
            iDist = Fx.Speed;

        if(this.teleportJump(0,iDist,iRad))
            Fx.gunS=0;
    }
    this.shipFunc_workingRadar = function(U,Prod,Radius){
        var O = this.O[0];
        var Angle,Angle2,E,Ex,Ey,EradarX,EradarY,Edist,Eangle;
        htmlR='<div id="Radar"><div class="radarDial"><div class="radarCenter">';
        var RadarJump = parseInt(U);
        if(RadarJump < 1) RadarJump = 1;
        var RadarNow = parseInt(Prod);
        var RadarStart = (RadarNow - RadarJump- -360)%360;
        var RadarCleanFrom = RadarStart;
        if(RadarStart > RadarNow){
            for(var i = RadarStart; i<360; ++i){
                this.RadarOld[i] = [];
            }
            RadarCleanFrom = 0;
        }
        for(var i = RadarCleanFrom; i <= RadarNow; ++i){
            this.RadarOld[i] = [];
        }

        for(E in this.Enemies){
            Ex = O.x - this.O[ E ].x;
            Ey = O.y - this.O[ E ].y;
            Edist = Math.sqrt(Ex*Ex- -Ey*Ey);
            if(Edist > Radius) continue;
            Eangle = parseInt(- (Math.atan2(Ex,Ey)*180/Math.PI)- -360)%360;
            EradarX = 100 * (Edist/Radius) * Math.sin( (-parseInt(Eangle)-180)*(Math.PI/180));
            EradarY = 100 * (Edist/Radius) * Math.cos( (-parseInt(Eangle)-180)*(Math.PI/180));
            if( (RadarStart < RadarNow && (Eangle >= RadarStart && Eangle <= RadarNow))
             || (RadarStart > RadarNow && (Eangle >= RadarStart || Eangle <= RadarNow))){
                this.RadarOld[Eangle][ this.RadarOld[Eangle].length ]= {x:EradarX,y:EradarY};
            }
        }

        for(Angle=0; Angle < 360; ++Angle){
            Angle2=( RadarStart- -Angle - -360) % 360;
            for(var E=0; E < this.RadarOld[Angle2].length; ++E)
                htmlR+='<div class="radarPoint rP_'+Angle+'" style="top: '+this.RadarOld[Angle2][E].y.toFixed(0)+'px; left: '+this.RadarOld[Angle2][E].x.toFixed(0)+'px;"></div>';
        }
        htmlR+='<div class="radarStick" style="transform: rotate('+(RadarNow-180)+'deg);"></div>';
        htmlR+='</div></div></div>';

        $('#countRadar').html(htmlR);
    }
    this.shipFunc_speedChange = function(){
        var O = this.O[0];
        var S = this.SHIP;
        var Sx = this.SHIPold;
        var html='';
        if(O.speed < 0) O.speed=0.0;
        if(O.speed > S.speedM) O.speed=S.speedM;
        S.Espeed = (O.speed*O.speed/2)*(S.Weight/50);
        S.Energy = S.EnergyM - S.Espeed;

        $('#modulesEnergyIn').html(S.Energy.toFixed(2));

        html+='<div class="speedBoxEnergy">'+S.Espeed.toFixed(2)+'</div>';
        html+='<span class="speedBoxSpeed">'+O.speed.toFixed(1)+'</span>';
        for(var i=parseInt(O.speed- -0.97); i >0; --i)
            if(O.speed > i)    html+='<div class="speedOmeter speed_'+i+'"></div>';
                else        html+='<div class="speedOmeter speed_'+i+'"><span class="speedCap_'+(i-O.speed).toFixed(1)*10+'0"></span></div>';
        $('#speedOmeterBox').html(html);
        Sx.speed = O.speed;
    }
    this.shipFunc_changeWeapon = function(Fx,weaponId){
        var S = this.SHIP;
        $('.attackBox').removeClass('attackBoxActive');

        if(Fx==1){
            S.FireType = weaponId;
            var F = S.FireTypes[ S.FireType ];
            if(S.ShowFireRange){
                var RadX = F.Speed*F.Dec;
                $('#bullRadX').css({width: RadX*2+'px',height: RadX*2+'px',top: (-RadX)+'px',left: (-RadX)+'px'});
            }
        }else{
            S.FireType2 = weaponId;
        }
        $('#attackModule_'+S.FireType).addClass('attackBoxActive');
        if(S.FireType2 !==false)
            $('#attackModule_'+S.FireType2).addClass('attackBoxActive');
    }
    this.shipFunc_showSpotRegions = function(show){
        if(show==true){
            for(var o in this.Enemies)
                this.showEnemySpotRegion(o);
        } else {
            //  for(var o in this.Enemies){
            //      $('#O_'+o+' .spotRegion').remove();
            //  }
        }
    }
    this.shipFunc_showHealth = function(){
        var html='';
        for(var i=0; i<this.O[0].life; ++i)
            html+='A';
        html+='<span class="disabledHealth">';
        for(var i=0; i<this.SHIP.lifeM - this.O[0].life; ++i)
            html+='A';
        html+='</span>';
        if(typeof this.O[0].energyField !='undefined'){
            html+='<span class="XenergyField">';
            for(var i=0; i<this.O[0].energyField; ++i)
                html+='O';
            html+='</span><span class="XenergyFieldDisabled">';
            for(var i=0; i<this.SHIP.EnergyFieldMax - this.O[0].energyField; ++i)
                html+='O';
            html+='</span>';
        }
        $('#countHealth').html(html);
    }

    this.makeShipControlPanel = function(){
        var O = this.O[0];
        var S = this.SHIP;
        var Sx = this.SHIPold;
        var html='';
        S.speedM = (Math.sqrt(S.EnergyM))/(S.Weight/50);

        Sx.speed = -17;
        html+='<div class="speedBox" id="speedOmeterBox"></div>';
        this.shipFunc_speedChange();

        if(S.ShowFireRange==false) $('#bullRadX').remove();

        var letter,modHtml='';

        Sx.Mod={};
        for(var m in S.Modules){
            html=modHtml+html;
            modHtml='';
            Sx.Mod[m]='disabled';
            letter='';
            for(var pimk in S.KeysModules)
                for(var pomk=0; pomk < S.KeysModules[pimk].length; ++pomk)
                    if(m == S.KeysModules[pimk][pomk])
                        letter='<div class="letter">'+String.fromCharCode(pimk)+'</div>';

            modHtml+='<div class="cBox">'+letter+'<span id="moduleBox_'+m+'"><div class="energyBox min"><span class="smaller">Disabled</span><div class="infoBox">'+NAMES.ModName[S.Modules[m].T]+'</div></div></span></div>';

        }
        html ='<div class="cBox"><div class="energyBox energyCap_00" id="modulesEnergyOut">'+S.Energy.toFixed(2)+'</div></div>'+modHtml+html;

        html+='<div class="cBox"><div class="energyBox energyCap_00"><span id="modulesEnergyIn">'+S.Energy.toFixed(2)+'</span><div class="ammoBoxBox"><div class="ammoBoxes">';

        Sx.EnergyOut=-1;
        for(var fi in S.FireTypes){
            html+='<div id="attackModule_'+fi+'" class="attackBox attack_'+S.FireTypes[fi].T+'"><span></span><span></span><span></span><span></span><span></span><div class="attackBoxNum">'+(fi- -1)+'</div></div>';
        }

        if(S.MissleStorage > 0)
            html+='<div class="ammoBox" id="missleStorage"></div>';
        if(S.BombStorage > 0)
            html+='<div class="ammoBox" id="bombStorage"></div>';
        if(S.AmmoStorage > 0)
            html+='<div class="ammoBox" id="ammoStorage"></div>';

        html+='</div></div></div></div>';

        $('#countSpeed').html(html);
        this.shipFunc_speedChange();
        this.shipFunc_changeWeapon(1, S.FireType);

    }


    this.decide_ship = function(e){
        var O = this.O[0];
        var S = this.SHIP;
        var Sx = this.SHIPold;
        var F = S.FireTypes[ S.FireType ];
        if(S.FireType2!=false)
            var F2 = S.FireTypes[ S.FireType2 ];
        var LaserMod = false;
        var TeleMod = false;
        O.lastSpeedT = 0;
        this.mouseX = this.mouse_x- -(O.x -this.Dx/2);
        this.mouseY = this.mouse_y- -(O.y -this.Dy/2);
        var html='';

        if(this.specialMoveT==-1 && this.specialMove > 0){
            // Start special move
            if(this.specialMove==2) O.angle = (O.angle- -90- -360)%360;
            if(this.specialMove==1) O.angle = (O.angle - 90- -360)%360;
            if(this.specialMove==4) O.angle = (O.angle - 180- -360)%360;
            if(this.specialMove==3) O.speed-=-5;
            this.specialMoveT=10;
        }

        if(this.specialMoveT==-1){
            if(this.keyLeftRight==1){    O.angle=(O.angle- -360 -O.speedT)%360;    O.lastSpeedT =-O.speedT; }
            if(this.keyLeftRight==-1){    O.angle=(O.angle- -360- -O.speedT)%360;    O.lastSpeedT = O.speedT; }
            if(this.keyUpDown==1)        O.speed-=-O.speedA/this.Frames;
            if(this.keyUpDown==-1)        O.speed-=O.speedD/this.Frames;
        } else{
            // Do special move

            if(--this.specialMoveT == -1) this.specialMove = -1;
        }

        if(O.speed != Sx.speed)
            this.shipFunc_speedChange();

        S.Energy = S.EnergyM - S.Espeed;

        var EsteemedPos=false;

        var modHtml='';
        for(var m in S.Modules){
            var M = S.Modules[m];
            modHtml='';

            // Modu�y konfigurowane przy dezaktywacji:
            if(M.T=='laserProd' && M.Disabled == 1)
                M.LaserLoad=0;

            if(M.T=='teleProd' && M.Disabled == 1)
                M.TeleLoad=0;


            // Modu�y wy��czone:
            if(Sx.Mod[m] != 'disabled'){
                $('#moduleBox_'+m).html('<div class="energyBox min"><span class="smaller">Disabled</span><div class="infoBox">'+NAMES.ModName[M.T]+'</div></div>');
                Sx.Mod[m]='disabled';
                if(M.T=='spotRegion') this.shipFunc_showSpotRegions(false);
            }

            if(M.Disabled == 1)
                continue;


            // Modu�y niepotrzebne:
            if(    (M.T=='bulletProd' && S.AmmoStorage > 0 && S.Ammo >=S.AmmoStorage )
             ||    (M.T=='healerProd' && S.lifeM <= O.life)
             || (M.T=='missleProd' && S.MissleStorage > 0 && S.Missles >=S.MissleStorage )
             || (M.T=='bombProd' && S.BombStorage > 0 && S.Bombs >=S.BombStorage )
             || (M.T=='esteemProd' && (F.T=='missle' || F.T=='missleR' || F.T=='laser'))
             || (M.T=='shieldProd' && S.EnergyFieldMax <= O.energyField) ){
                if(Sx.Mod[m] != 'done'){
                    $('#moduleBox_'+m).html('<div class="energyBox min">Done<div class="infoBox">'+NAMES.ModName[M.T]+'</div></div>');
                    Sx.Mod[m]='done';
                }
                continue;
            }

            // Modu�y bez energii:
            if(M.Emin > S.Energy){
                M.E=0;
                if(M.T=='laserProd') M.LaserLoad = 0;
                if(M.T=='teleProd') M.TeleLoad = 0;
                if(Sx.Mod[m] != 0){
                    $('#moduleBox_'+m).html('<div class="energyBox min"><div class="min">min.</div>'+M.Emin.toFixed(2)+'<div class="infoBox">'+NAMES.ModName[M.T]+'</div></div>');
                    Sx.Mod[m]=0;
                    if(M.T=='spotRegion') this.shipFunc_showSpotRegions(false);
                }
                continue;
            }
            // Modu�y dzia�aj�ce:
            if(M.T=='laserProd' && M.LaserLoad == M.LaserLoadM){
                if(Sx.Mod[m] != 'active'){
                    modHtml+='<div class="energyBox active"><div class="active">active</div>'+M.Emin.toFixed(2)+'<div class="infoBox">';
                    Sx.Mod[m] = 'active';
                }
                S.Energy-=M.Emin;
                M.E = M.Emin;
            } else if(M.T=='teleProd' && M.TeleLoad == M.TeleLoadM){
                if(Sx.Mod[m] != 'active'){
                    modHtml+='<div class="energyBox active"><div class="active">active</div>'+M.Emin.toFixed(2)+'<div class="infoBox">';
                    Sx.Mod[m] = 'active';
                }
                S.Energy-=M.Emin;
                M.E = M.Emin;
            }else{
                if(S.Energy < M.Emax){
                    M.E = S.Energy;
                    if(Sx.Mod[m] != S.Energy){
                        modHtml+='<div class="energyBox energyCap_'+((M.E-M.Emin)/(M.Emax-M.Emin)).toFixed(1)*10+'0">'+M.E.toFixed(2)+'<div class="infoBox">';
                        Sx.Mod[m] = S.Energy;
                    }
                    S.Energy=0;
                } else{
                    M.E = M.Emax;
                    if(Sx.Mod[m] != M.E){
                        modHtml+='<div class="cBox"><div class="energyBox max"><div class="max">max.</div>'+M.E.toFixed(2)+'<div class="infoBox">';
                        Sx.Mod[m] = M.E;
                        if(M.T=='spotRegion') this.shipFunc_showSpotRegions(true);
                    }
                    S.Energy-=M.Emax;
                }
            }
            if(modHtml!='') modHtml+='<div class="titleBox">'+NAMES.ModName[M.T]+'</div>';
            var U = M.ProdX*(M.E/M.Emax);

            M.Prod-=-U;
            if(M.Prod > M.ifProd){
                if(M.T=='laserProd' && M.LaserLoad < M.LaserLoadM) ++M.LaserLoad;
                if(M.T=='teleProd' && M.TeleLoad < M.TeleLoadM) ++M.TeleLoad;
                if(M.T=='bulletProd') ++S.Ammo;
                if(M.T=='missleProd') ++S.Missles;
                if(M.T=='bombProd')   ++S.Bombs;
                if(M.T=='healerProd'){
                    this.healObj(0,1);
                }
                if(M.T=='shieldProd'){
                    if(++O.energyField == 1)
                        $('#O_0').prepend('<div class="energyField"></div>');
                    this.shipFunc_showHealth();
                }
                M.Prod-=M.ifProd;
                if(M.T=='laserProd' && M.LaserLoad == M.LaserLoadM) M.Prod=0;
                if(M.T=='teleProd' && M.TeleLoad == M.TeleLoadM) M.Prod=0;
            }

            if(M.T!='esteemProd' && M.T!='spotRegion' && M.T!='radar' && !(M.T=='laserProd' && M.LaserLoad==M.LaserLoadM ) && !(M.T=='teleProd' && M.TeleLoad==M.TeleLoadM )){
                if(30/(M.ifProd/U) > 1){
                    if(modHtml != '') modHtml+=(30/(M.ifProd/U)).toFixed(2)+'/sec';
                }else{
                    modHtml+='<div class="progresBar"><div class="progresBarOBar green" style="width: '+parseInt((M.Prod/M.ifProd)*100)+'px;"></div><div class="info">'+(((M.ifProd-M.Prod)/U)/30).toFixed(2)+'sec</div></div>';
                    Sx.Mod[m]=-23;
                }
            }
            if(M.T=='radar')
                if(modHtml!='') modHtml+=((M.ifProd/U)/30).toFixed(2)+'sec';
            if(M.T=='laserProd' && M.LaserLoad==M.LaserLoadM)
                if(modHtml!='') modHtml+='READY';
            if(M.T=='teleProd' && M.TeleLoad==M.TeleLoadM)
                if(modHtml!='') modHtml+='READY';


            if(M.T=='laserProd'){
                modHtml+='<div class="laserBoxBox"><div class="laserBox"><span>';
                for(var x=0; x<M.LaserLoad; ++x) modHtml+='L';
                modHtml+='</span>';
                for(var x=0; x<M.LaserLoadM - M.LaserLoad; ++x) modHtml+='L';
                modHtml+='</div></div>';
                if(M.LaserLoad > 0) LaserMod = m;
            }
            if(M.T=='teleProd'){
                modHtml+='<div class="laserBoxBox"><div class="laserBox"><span>';
                for(var x=0; x<M.TeleLoad; ++x) modHtml+='T';
                modHtml+='</span>';
                for(var x=0; x<M.TeleLoadM - M.TeleLoad; ++x) modHtml+='T';
                modHtml+='</div></div>';
                if(M.TeleLoad > 0) TeleMod = m;
            }

            if(M.T=='radar')
                this.shipFunc_workingRadar(U,M.Prod,M.Radius);

            if(M.T=='esteemProd' && M.E==M.Emax && (F.T=='single' || F.T=='double' || F.T=='rose' || F.T=='bomb'))
                EsteemedPos = this.shipFunc_esteemedPositions(O,F);

            if(modHtml != '')
                $('#moduleBox_'+m).html(modHtml);
        }
        if(Sx.EnergyOut != S.Energy){
            $('#modulesEnergyOut').html(S.Energy.toFixed(2));
            Sx.EnergyOut = S.Energy;
        }

        // ESTYMATORY
        if(S.GlueFireToLaser!=false && F.T=='laser')
            this.shipFunc_glueFireToLaser();

        if(S.ShowAmmoIndicator){
            if    (((F.T=='single' || F.T=='double' || F.T=='rose') && S.Ammo >= F.AmmoUse)
                    || ((F.T=='missle') && S.Missles >= F.MissleUse)
                    || ((F.T=='missleR') && S.Missles >= F.MissleUse)
                    || ((F.T=='bomb') && S.Bombs >= F.BombUse)
                    || ((F.T=='tele') && TeleMod!=false)
                    || ((F.T=='laser') && LaserMod!=false)
                )    $('#gameOverlay').attr('class','cursorCross');
            else    $('#gameOverlay').attr('class','cursorWait');
        }

        if(F.T=='missle' || F.T=='missleR')
            this.shipFunc_glueFireToMissle(F.AimRadius);

        if(F.T=='laser'){
            var Angle = parseInt(- (Math.atan2(this.mouseX-O.x,this.mouseY-O.y)*180/Math.PI)- -360)%360;
            $('#gameboardMarkers').append('<div class="object laserAiming" style="height: '+O.Speed+'px; top: '+(this.Dy/2)+'px; left: '+(this.Dx/2)+'px; transform: rotate('+Angle+'deg);"></div>');
        }

        if(S.GlueFireToEstimated!=false && EsteemedPos!=false)
            this.shipFunc_glueFireToEstimated(EsteemedPos);


        // STRZELAMY
        var aktywneDziala = {};
        if(S.MouseDown1) aktywneDziala[ S.FireType ]=1;
        if(S.FireType2!==false && S.MouseDown2) aktywneDziala[ S.FireType2 ]=1;
        for(var dzi in aktywneDziala) if(S.FireTypes[dzi].gunS > S.FireTypes[dzi].GunSpeed){
            var Fx = S.FireTypes[dzi];
            if(Fx.T=='single' && S.Ammo >= Fx.AmmoUse){
                this.shipShoot(0, Fx.Speed, Fx.Dec, Fx.Power);
                Fx.gunS=0;
                S.Ammo-=Fx.AmmoUse;
            }
            if(Fx.T=='double' && S.Ammo >= Fx.AmmoUse){
                this.shipShootOnSide(-90, 5, Fx.Speed, Fx.Dec, Fx.Power);
                this.shipShootOnSide(90, 5, Fx.Speed, Fx.Dec, Fx.Power);
                Fx.gunS=0;
                S.Ammo-=Fx.AmmoUse;
            }
            if(Fx.T=='rose' && S.Ammo >= Fx.AmmoUse){
                for(var i = -parseInt(Fx.AtOnce/2); i<= parseInt(Fx.AtOnce/2); ++i)
                    this.shipShoot(i*Fx.RoseAngle, Fx.Speed, Fx.Dec, Fx.Power);
                Fx.gunS=0;
                S.Ammo-=Fx.AmmoUse;
            }
            if(Fx.T=='missle' && S.Missles >= Fx.MissleUse && this.missleAim!=false){
                this.shipShootMissle(this.missleAim,O.angle,Fx.Speed,Fx.Dec,Fx.SpeedT,Fx.Power);
                Fx.gunS=0;
                S.Missles-=Fx.MissleUse;
            }
            if(Fx.T=='missleR' && S.Missles >= Fx.MissleUse && this.missleAim!=false){
                var Pe = [80,280,100,260,120,240,140,220,160,200,175,185];
                var Angle = parseInt(- (Math.atan2(this.mouseX-O.x,this.mouseY-O.y)*180/Math.PI)- -180)%360;


                for(var iki=0; iki<Fx.AtOnce; ++iki)
                    this.shipShootMissle(this.missleAim, (Angle- -Pe[iki])%360, (Fx.Speed-parseInt(iki/2)*2),(Fx.Dec- -parseInt(iki/2)*20),(Fx.SpeedT-parseInt(iki/2)),Fx.Power);
                Fx.gunS=0;
                S.Missles-=Fx.MissleUse;
            }
            if(Fx.T=='bomb' && S.Bombs >= Fx.BombUse){
                this.shipShootBomb(Fx.Speed,Fx.Dec,Fx.Power,Fx.Dist);
                Fx.gunS=0;
                S.Bombs-=Fx.BombUse;
            }
            if(Fx.T=='laser' && LaserMod!=false){
                --S.Modules[LaserMod].LaserLoad;
                this.shipShootLaser(Fx.Speed,Fx.Power);
                Fx.gunS=0;
            }
            if(Fx.T=='tele' && TeleMod!=false)
                this.shipFunc_teleport(Fx,TeleMod);
        }
        F.gunS++;
        if(F2) F2.gunS++;

        if(S.Ammo > S.AmmoStorage)      S.Ammo = S.AmmoStorage;
        if(S.Missles > S.MissleStorage) S.Missles = S.MissleStorage;
        if(S.Bombs > S.BombStorage)     S.Bombs = S.BombStorage;
        O.ammo++;

        if(S.Missles != Sx.missleStorage){
            html='<span>';
            for(var x=0; x<S.Missles; ++x) html+='Y';
            html+='</span>';
            for(var x=0; x<S.MissleStorage - S.Missles; ++x) html+='Y';
            $('#missleStorage').html(html);
            Sx.missleStorage = S.Missles;
        }
        if(S.Bombs != Sx.bombStorage){
            html='<span>';
            for(var x=0; x<S.Bombs; ++x) html+='P';
            html+='</span>';
            for(var x=0; x<S.BombStorage - S.Bombs; ++x) html+='P';
            $('#bombStorage').html(html);
            Sx.bombStorage = S.Bombs;
        }
        if(S.Ammo != Sx.ammoStorage){
            html='<span>';
            for(var x=0; x<S.Ammo; ++x) html+='i';
            html+='</span>';
            for(var x=0; x<S.AmmoStorage - S.Ammo; ++x) html+='i';
            $('#ammoStorage').html(html);
            Sx.ammoStorage = S.Ammo;

        }
    }

    this.countFutureShoot = function(o,Sx,Sy,Speed,Dec){
        var R=false,X=0,Y=0,A=0,O = this.O[o];
        var Ox=O.x;
        var Oy=O.y;
        var Oa=O.angle;
        var Rad=0;
        for(var d=0; d<Dec; ++d){
            Ox -=- O.speed * Math.sin( (-parseInt(Oa)-180)*(Math.PI/180));
            Oy -=- O.speed * Math.cos( (-parseInt(Oa)-180)*(Math.PI/180));
            Ox = Ox.toFixed(2);
            Oy = Oy.toFixed(2);
            Oa -=- O.lastSpeedT;
            Rad-=-Speed;
            if(Rad >= Math.sqrt(Math.pow(Sx-Ox,2)- -Math.pow(Sy-Oy,2))){
                X=Ox;
                Y=Oy;
                R=true;
                A=parseInt(- (Math.atan2(Sx-Ox,Sy-Oy)*180/Math.PI))%360;
                break;
            }
        }

        return {r:R,x:X,y:Y,a:A};
    }


    this.decide_squad = function(s){
        var SQ = this.Squads[s];
        if(typeof this.O[ SQ.Leader ] == 'undefined'){
            delete this.Squads[s];
            return false;
        }
        var S0 = this.O[ SQ.Leader ];

        S0.speed = SQ.SquadSpeed;

        var i=0;
        var Ki=[{x:50,y:0},{x:0,y:50},{x:50,y:50},{x:100,y:0},{x:0,y:100},{x:100,y:50},{x:50,y:100},{x:100,y:100}];
        var Ki=[{r:30,q:120},{r:30,q:240},{r:60,q:120},{r:60,q:240},{r:90,q:120},{r:90,q:240},{r:120,q:120},{r:120,q:240}];
        //  var Ki=[{r:30,q:90},{r:30,q:270},{r:60,q:90},{r:60,q:270},{r:90,q:90},{r:90,q:270},{r:120,q:90},{r:120,q:270}];

        for(var Si in SQ.Members) if(Si!=SQ.Leader){
            this.O[ Si ].squadX = S0.x- -Ki[i].r * Math.sin( (-parseInt(S0.angle- -Ki[i].q)-180)*(Math.PI/180));
            this.O[ Si ].squadY = S0.y- -Ki[i].r * Math.cos( (-parseInt(S0.angle- -Ki[i].q)-180)*(Math.PI/180));
            this.O[ Si ].toDo='goToSquad';
            this.O[ Si ].doSquad='goToSquad';
            this.O[ Si ].dec=100;
            ++i;
        }

    }

    // **********************************************
    // **********************************************
    // **********************************************
    // **********************************************
    // **********************************************

    this.alarmAround = function(o,DistAlert,AlarmFlag){
        var uO,X,Y,Dist,O = this.O[o];

        for(var uo in this.Enemies) if(uo!=o){
            uO = this.O[uo];
            X = O.x-uO.x;
            Y = O.y-uO.y;
            Dist = Math.sqrt(X*X- -Y*Y);
            if(Dist < DistAlert){
                this.O[uo][AlarmFlag] = true;
            }
        }
    }


    this.decide = function(o){
        var O = this.O[o];
        var P = this.O[0];
        O.lastSpeedT = 0;

        var X = O.x-P.x;
        var Y = O.y-P.y;
        var PlayerDist = Math.sqrt(X*X- -Y*Y);
        var PlayerAngle = parseInt(- (Math.atan2(X,Y)*180/Math.PI))%360;

        // Spotting
        if(O.spotLvl){
            if(this.tick % (O.spotArr[ O.spotLvl ].Ref) == 0){
                var SP = O.spotArr[ O.spotLvl ];
                if((SP.T=='single' || SP.T=='double') && PlayerDist < SP.Rad){
                    O.spotEnemyFlag = true;
                }
                if(SP.T=='double' && !O.spotEnemyFlag){
                    var A = (PlayerAngle -O.angle- -720- -SP.Angle2)%360;
                    if(PlayerDist < SP.Rad2 && A < SP.Angle2*2){
                        O.spotEnemyFlag = true;
                    }
                }
                // Szukamy grupy i pocisku
                if(!O.awareAboutEnemy){
                    for(var U in this.Odead){
                        var uX = O.x-this.Odead[U].x;
                        var uY = O.y-this.Odead[U].y;
                        var uDist = Math.sqrt(uX*uX- -uY*uY);
                        var uAngle = parseInt(- (Math.atan2(uX,uY)*180/Math.PI))%360;
                        if((SP.T=='single' || SP.T=='double') && uDist < SP.Rad){
                            O.awareAboutEnemy = true;
                            break;
                        }
                        if(SP.T=='double' && !O.spotEnemyFlag){
                            var uA = (uAngle -O.angle- -720- -SP.Angle2)%360;
                            if(uDist < SP.Rad2 && uA < SP.Angle2*2){
                                O.awareAboutEnemy = true;
                                break;
                            }
                        }
                    }
                }
            }
        }

        /*
        O.spotEnemyFlag = false;
        O.gotHitFlag = false;
        O.heardExplosionFlag = false;
        O.newOrderFlag = false;
        O.incomingFireFlag = false;
        O.awareAboutEnemy = false;
        O.lastSeenEnemy = -1;
        */
        // Sprawdzamy czy flagi mog� przerwa� obecne zadanie
        if(O.awareAboutEnemy && O.AlarmLvl < 3){
            O.AlarmLvl = 4;
            O.doingTime = -1;
        }
        if(O.spotEnemyFlag){
            if(O.AlarmLvl < 5){
                O.AlarmLvl = 5;
                O.doingTime = -1;
            }
            O.lastSeenEnemy = this.tick;
            O.awareAboutEnemy = true;
        }

        if(O.gotHitFlag==true && O.T!='avoidIncomingFire')
            O.doingTime = -1;
        if(O.incomingFireFlag==true && O.T!='avoidIncomingFire')
            O.doingTime = -1;


        // Jak si� sko�czy czas to szukamy kolejnego zadania
        if((--O.doingTime) < 0){

            for(var toDo in O.toDo){
                var TD = O.toDo[toDo];


                if(TD.minAlarm && TD.minAlarm > O.AlarmLvl) continue;
                if(TD.maxAlarm && TD.maxAlarm < O.AlarmLvl) continue;
                if(TD.gotHitFlag && O.gotHitFlag===false) continue;
                if(TD.incomingFireFlag && O.incomingFireFlag===false) continue;
                // Sprawdzamy Czy akcja si� nadaje
                if(TD.T=='stayInRegion'){
                    var uX = TD.X - O.x;
                    var uY = TD.Y - O.y;
                    if(Math.sqrt(uX*uX- -uY*uY) < TD.Radius) continue;
                }
                if(TD.T=='lowerAlarmLvl' && ((this.tick - O.lastSeenEnemy) < TD.minEnemyDontSeen)) continue;


                // Dodajemy Akcj�
                if(TD.T=='stayInRegion'){
                    O.Manouver = 'goToXY';
                    O.goToX = TD.X;
                    O.goToY = TD.Y;
                    O.doingTime = 160;
                }


                if(TD.T=='alarmAboutSpottedEnemy'){
                    this.alarmAround(o,TD.alarmRadius,'spotEnemyFlag');
                    continue;
                }
                if(TD.T=='alarmAboutIncomingFire'){
                    this.alarmAround(o,TD.alarmRadius,'incomingFireFlag');
                    continue;
                }

                if(TD.T=='changeManouver'){
                    var maxTurnTime = parseInt(180/O.speedT);
                    switch(parseInt(Math.random()*3)){
                        case 0: O.Manouver = 'goStraight'; O.doingTime = TD.straightMin- -parseInt(Math.random()*TD.straightPlus); break;
                        case 1: O.Manouver = 'turnRight';  O.doingTime = TD.turnMin- -parseInt(Math.random()*TD.turnPlus); if(O.doingTime > maxTurnTime) O.doingTime = maxTurnTime; break;
                        case 2: O.Manouver = 'turnLeft';  O.doingTime = TD.turnMin- -parseInt(Math.random()*TD.turnPlus); if(O.doingTime > maxTurnTime) O.doingTime = maxTurnTime; break;
                    }
                }

                if(TD.T=='changeManouver2'){
                    if(O.Manouver =='goStraight'){
                        var maxTurnTime = parseInt(180/O.speedT);
                        switch(parseInt(Math.random()*2)){
                            case 0: O.Manouver = 'turnRight';  O.doingTime = TD.turnMin- -parseInt(Math.random()*TD.turnPlus); if(O.doingTime > maxTurnTime) O.doingTime = maxTurnTime; break;
                            case 1: O.Manouver = 'turnLeft';  O.doingTime = TD.turnMin- -parseInt(Math.random()*TD.turnPlus); if(O.doingTime > maxTurnTime) O.doingTime = maxTurnTime; break;
                        }
                    }else{
                        O.Manouver = 'goStraight';
                        O.doingTime = TD.straightMin- -parseInt(Math.random()*TD.straightPlus);
                    }
                }

                if(TD.T=='avoidIncomingFire'){
                    switch(parseInt(Math.random()*2)){
                        case 0: O.Manouver = 'turnRight';  O.doingTime = TD.avoidTime; break;
                        case 1: O.Manouver = 'turnLeft';  O.doingTime = TD.avoidTime; break;
                    }
                }

                if(TD.T=='followEnemy'){
                    O.doingTime = 50;
                    O.Manouver = 'followEnemy';
                }

                if(TD.T=='die'){
                    if(O.onDie){
                        if(O.onDie.Do=='explode'){
                            this.explodeBomb(o,O.onDie);
                        }
                    } else
                        this.removeObj(o);
                    return true;
                }
                if(TD.T=='expire'){
                    if(O.onExpire){
                        if(O.onExpire.Do=='explode'){
                            this.explodeBomb(o,O.onExpire);
                        }
                    } else
                        this.removeObj(o);
                    return true;
                }

                if(TD.T=='explode'){
                    this.explodeBomb(o,O.onDie);
                    return true;
                }

                if(TD.T=='goStraight'){
                    O.Manouver = 'goStraight';
                    O.doingTime = TD.straightMin- -parseInt(Math.random()*TD.straightPlus);
                }

                // Dodatkowe wywo�ania akcji
                if(TD.goToAlarmLvl)    O.AlarmLvl = TD.goToAlarmLvl;
                if(TD.goToSpotLvl)    O.spotLvl = TD.goToSpotLvl;

                O.doingNow = TD.T;
                break;
            }
        }


        // Wykonujemy zadanie
        switch(O.Manouver){
            case 'followEntity':{
                if(typeof this.O[O.FollowWho] == 'undefined' || this.O[O.FollowWho].life <= 0){
                    O.Manouver = 'goStraight';
                    O.lastSpeedT = 0;
                }
                if(typeof this.O[O.FollowWho] !='undefined'){
                    var wiX = O.x-this.O[O.FollowWho].x;
                    var wiY = O.y-this.O[O.FollowWho].y;
                }
                if(typeof wiX!='undefined'){
                    var Angle = parseInt(- (Math.atan2(wiX,wiY)*180/Math.PI)- -360)%360;
                    var Tyk = (O.angle-Angle- -360)%360;
                    var Ei = 180 - Math.abs( Tyk - 180);
                    var speedT = O.speedT;
                    O.Tyk = Tyk;
                    if(Ei < speedT) speedT = Ei;
                    if(Tyk > 180){    O.angle = (O.angle- -speedT- -360)%360; O.lastSpeedT = speedT; }
                    if(Tyk <= 180){    O.angle = (O.angle-speedT- -360)%360;     O.lastSpeedT = -speedT; }
                }
            }break;
            case 'followEnemy':{
                var Tyk = (O.angle-PlayerAngle- -360)%360;
                var Ei = 180 - Math.abs( Tyk - 180);
                var speedT = O.speedT;
                O.Tyk = Tyk;
                if(Ei < speedT) speedT = Ei;
                if(Tyk > 180){    O.angle = (O.angle- -speedT- -360)%360; O.lastSpeedT = speedT; }
                if(Tyk <= 180){    O.angle = (O.angle-speedT- -360)%360;     O.lastSpeedT = -speedT; }
            }break;
            case 'goToXY':{
                var wiX = O.x-O.goToX;
                var wiY = O.y-O.goToY;
                var Angle = parseInt(- (Math.atan2(wiX,wiY)*180/Math.PI)- -360)%360;
                var Tyk = (O.angle-Angle- -360)%360;
                var Ei = 180 - Math.abs( Tyk - 180);
                var speedT = O.speedT;
                if(Ei < speedT) speedT = Ei;
                if(Tyk > 180){    O.angle = (O.angle- -speedT- -360)%360; O.lastSpeedT = speedT; }
                if(Tyk <= 180){    O.angle = (O.angle-speedT- -360)%360;     O.lastSpeedT = -speedT; }
            }break;
            case 'turnLeft':{
                O.angle = (O.angle- -360- -O.speedT) %360;
                O.lastSpeedT = O.speedT;
            }break;
            case 'turnRight':{
                O.angle = (O.angle- -360-O.speedT) %360;
                O.lastSpeedT =-O.speedT;
            }break;
            case 'goStraight':{
                O.lastSpeedT = 0;
            }break;
            case 'decay':{
                if(O.doingTime%10 == 0){
                    if(O.life > 1){
                        O.life--;
                        CanvasManager.requestCanvas(o);
                    } else this.removeObj(o);
                    return true;
                }
            }break;
        }


        /*
        OBJ.weapon=[{t:'single', Power:1, Dec: 30, Speed: 10, gunSpeed: 15, lastShot: 120}];
        OBJ.weapon=[{t:'double', Power:1, Dec: 30, Speed: 10, gunSpeed: 15, lastShot: 120}];
        OBJ.weapon=[{t:'double2', Power:1, Dec: 30, Speed: 10, gunSpeed: 15, lastShot: 120}];
        OBJ.weapon=[{t:'rose', Power:1, Dec: 50, Speed: 10, gunSpeed: 50, RoseAngle: 4, AtOnce: 9, lastShot: 120}];
        */
        // Strzelamy
        if(O.weapon){
            for(var wp in O.weapon){
                var WP = O.weapon[wp];
                if(WP.minAlarm && WP.minAlarm > O.AlarmLvl) continue;
                if(WP.maxAlarm && WP.maxAlarm < O.AlarmLvl) continue;
                if(WP.maxSpeed && WP.maxSpeed < O.speedLvl) continue;
                if(WP.minSpeed && WP.minSpeed > O.speedLvl) continue;    // Czy w og�le kiedy� u�yjemy tego?
                if(WP.minDistToEnemy && WP.minDistToEnemy < PlayerDist) continue;
                if(WP.gunSpeed > (this.tick-WP.lastShot)) continue;

                // Wykonujemy strza�
                if(WP.t == 'single'){
                    this.shootBullet(o,PlayerAngle,WP.Speed,WP.Dec,WP.Power);
                    WP.lastShot = this.tick;
                }
                if(WP.t == 'double'){
                    this.shootBulletOnSide(o,0,WP.Speed,WP.Dec,45,30,WP.Power);
                    this.shootBulletOnSide(o,0,WP.Speed,WP.Dec,-45,30,WP.Power);
                    WP.lastShot = this.tick;
                }
                if(WP.t == 'double2'){
                    this.shootBulletOnSide2(o,0,WP.Speed,WP.Dec,45,5,WP.Power);
                    this.shootBulletOnSide2(o,0,WP.Speed,WP.Dec,-45,5,WP.Power);
                    WP.lastShot = this.tick;
                }

                if(WP.t=='rose'){
                    for(var i = -parseInt(WP.AtOnce/2); i<= parseInt(WP.AtOnce/2); ++i)
                        this.shootBullet(o,PlayerAngle-i*WP.RoseAngle,WP.Speed,WP.Dec,WP.Power);
                    WP.lastShot = this.tick;
                }

                if(WP.t=='refilJumps'){
                    if(++O.jumpT >= WP.jumpA){
                        if(++O.jump > WP.jumpM)
                            O.jump = WP.jumpM;
                        O.jumpT=0;
                    }
                }

                if(WP.t=='makeShieldBlob'){
                    for(var i=0; i< O.squadScheme.length; ++i){
                        if( O.squadScheme[i].Oid == -1){
                            var iX = O.x- -O.squadScheme[i].radius * Math.sin( (-parseInt(O.squadScheme[i].angle- -O.angle)-180)*(Math.PI/180));
                            var iY = O.y- -O.squadScheme[i].radius * Math.cos( (-parseInt(O.squadScheme[i].angle- -O.angle)-180)*(Math.PI/180));
                            var Sid = this.putObj('shieldBlob','moving',O.S,iX,iY);
                            var oS = this.O[Sid];
                            oS.angle = O.angle;
                            this.bindWithSquad(o, i, Sid);

                            oS.life = 1;
                            oS.lifeM = WP.shieldBlobMaxHp;

                            CanvasManager.requestCanvas( Sid );
                            break;
                        }
                        var sO = this.O[ O.squadScheme[i].Oid ];
                        if( sO.life < sO.lifeM ){
                            sO.life -=-1;
                            CanvasManager.requestCanvas( O.squadScheme[i].Oid );
                            break;
                        }
                    }
                    WP.lastShot = this.tick;
                }

                /*
                if(Fx.T=='missle' && S.Missles >= Fx.MissleUse && this.missleAim!=false){
                    this.shipShootMissle(this.missleAim,O.angle,Fx.Speed,Fx.Dec,Fx.SpeedT,Fx.Power);
                    Fx.gunS=0;
                    S.Missles-=Fx.MissleUse;
                }
                */


                if(WP.doNextWeapon) continue;

                break;
            }
        }
        O.spotEnemyFlag = false;
        O.incomingFireFlag = false;
        O.gotHitFlag = false;
    }


    // ===============================================
    // ===============================================
    // ===============================================
    // ===============================================
    // ===============================================
    // ===============================================

    this.decideOLD = function(o){
        var O = this.O[o];
        var P = this.O[0];
        O.lastSpeedT = 0;

        if(O.T=='missle' && O.dec < 0)
            this.removeObj(o);

        if(O.T=='dregos' && O.dec < 0 && O.toDo=='follow'){
            O.toDo='rest';
            O.dec=500;
            O.speed=3;
            O.ammo=0;
        }
        if(O.T=='dregos' && O.dec < 0 && O.toDo=='rest')
            O.speed=8;
        if(O.T=='warastein' && O.dec < 0 && O.toDo=='rest')
            O.speed=7;

        if(O.dec < 0 && ( O.toDo=='turnLeft' || O.toDo=='turnRight')){
            O.toDo='goStraight';
            O.dec = parseInt(Math.random()*200)- -500;
        }

        if(O.T!='space_mine' && O.T!='bullet_bomb' && O.dec < 0){
            switch(parseInt(Math.random()*2)){
                case 1: O.toDo='turnLeft';         O.dec = parseInt(Math.random()*90); break;
                case 2: O.toDo='turnRight';        O.dec = parseInt(Math.random()*90); break;
            }
            if(O.T=='tartaros')
                O.dec=parseInt(O.dec/3);
        }

        var X = O.x-P.x;
        var Y = O.y-P.y;
        var Dist = Math.sqrt(X*X- -Y*Y);



        switch(O.T){
                case 'nemezis':
                if(Dist < 400 && O.ammo > 40){
                    var Angle = parseInt(- (Math.atan2(X,Y)*180/Math.PI))%360;
                    this.shootBomb(o,Angle,10,50,4,35);
                    O.ammo=0;
                }
            break; case 'royale':
                if(Dist < 400 && O.ammo > 120){
                    var Pe = [80,280,100,260,120,240,140,220];
                    var Angle = parseInt(- (Math.atan2(P.x-O.x,P.y-O.y)*180/Math.PI)- -180)%360;

                    for(var iki=0; iki<8; ++iki)
                        this.shootMissle(o, (Angle- -Pe[iki])%360, (12-parseInt(iki/2)*2),(95- -parseInt(iki/2)*20),(6-parseInt(iki/2)));
                    O.ammo=0;
                }
            break; case 'iskariot':
                if(++O.jumpT >= O.jumpA){
                    O.jumpT = 0;
                    ++O.jump;
                    if(O.jump > O.jumpM) O.jump = O.jumpM;
                }
                if(Dist < 400 && O.ammo > 20){
                    if(O.toDo!='follow' && O.doSquad==-1){
                        O.toDo='follow';
                        O.dec=300;
                    }
                    this.shootBulletOnSide2(o,0,12,35,45,5,1);
                    this.shootBulletOnSide2(o,0,12,35,-45,5,1);
                    O.ammo=0;
                }
            break; case 'warastein':
                if(Dist < 400 && O.ammo > 140){
                    O.toDo = 'rest';
                    O.dec = 30;
                    O.speed = 3;
                    var Angle = parseInt(- (Math.atan2(X,Y)*180/Math.PI))%360;
                    this.shootBomb(o,Angle        ,6,20,4,35);
                    this.shootBomb(o,Angle- -7    ,8,23,4,35);
                    this.shootBomb(o,Angle - 7    ,8,23,4,35);
                    this.shootBomb(o,Angle- -15    ,10,26,4,35);
                    this.shootBomb(o,Angle - 15    ,10,26,4,35);
                    this.shootBomb(o,Angle         ,10,26,7,80);
                    this.shootBomb(o,Angle- -15    ,12,29,7,80);
                    this.shootBomb(o,Angle - 15    ,12,29,7,80);
                    this.shootBomb(o,Angle         ,14,29,9,120);
                    O.ammo=0;
                }
            break; case 'edison':
                if(O.ammo==100)
                  //  $('#O_'+o).append('<div class="edisonField"></div>');
                if(Dist < 150 && O.ammo > 120){
                    this.makeDMG(0,O.FieldPower);
                    O.ammo=0;
                  //  $('#O_'+o+' .edisonField').addClass('edisonHit hit_'+parseInt(this.tick/100));
                }
            break; case 'tartaros':
                if(Dist < 400 && O.ammo > 100){
                    this.shootBulletOnSide(o,0,12,35,45,30,1);
                    this.shootBulletOnSide(o,0,12,35,-45,30,1);
                    O.ammo=0;
                }
                if(O.ammo < 10){
                    this.shootBulletOnSide(o,0,12,35,45,30,1);
                    this.shootBulletOnSide(o,0,12,35,-45,30,1);
                }
            break; case 'gargamon':    // how Squad?
                if(O.toDo!='goFollow' && O.toDo!='missleShoot' && Dist < 400 && O.ammo > 150){
                    O.toDo='goFollow';
                    O.dec = 31;
                }
                if(O.toDo=='goFollow'){
                    var X = O.x-P.x;
                    var Y = O.y-P.y;
                    var Angle = parseInt(- (Math.atan2(X,Y)*180/Math.PI)- -360)%360;
                    var Tyk = (O.angle-Angle- -360)%360;
                    if(Tyk > 180)        O.angle = (O.angle- -360- -4) %360;
                    else if(Tyk < 180)    O.angle = (O.angle- -360-4) %360;
                }
                if(O.toDo=='goFollow' && O.dec==1){
                    O.toDo='missleShoot';
                    O.dec=40;
                    O.ammo=0;
                }
                if(O.toDo=='missleShoot' && O.ammo==0)    this.shootMissle(o,O.angle- -30,15,150);
                if(O.toDo=='missleShoot' && O.ammo==8)    this.shootMissle(o,O.angle- -15,15,150);
                if(O.toDo=='missleShoot' && O.ammo==16)    this.shootMissle(o,O.angle       ,15,150);
                if(O.toDo=='missleShoot' && O.ammo==24)    this.shootMissle(o,O.angle    -15,15,150);
                if(O.toDo=='missleShoot' && O.ammo==32)    this.shootMissle(o,O.angle    -30,15,150);
            break; case 'juggernaut':
                if(O.toDo!='follow' && Dist < 400 && O.ammo > 50){
                    O.toDo='follow';
                    O.speedT=5;
                    O.dec = 18;
                }
                if(O.toDo=='follow' && O.dec==1){
                    O.toDo=0;
                    O.dec=100;
                    O.speedT=2;
                    O.ammo=0;
                    var Angle = parseInt(- (Math.atan2(X,Y)*180/Math.PI))%360;
                    var Ku = [35,80,120,210];
                    var Ka = [4,7,11,18];
                    var Ki = parseInt(Math.random()*4);
                    this.shootBomb(o,Angle,16,20,Ka[Ki],Ku[Ki]);
                }
            break; case 'belzebub':
                if(Dist < 400 && O.ammo > 120){
                    var Angle = parseInt(- (Math.atan2(X,Y)*180/Math.PI))%360;
                    this.dropSpaceMine(o,Angle);
                    O.ammo=0;
                }
                if(O.ammo > 1000){
                    this.dropSpaceMine(o);
                    O.ammo=0;
                }
            break; case 'space_mine':
                if(O.toDo=='doExplode' && O.dec < 1){
                    this.explodeBomb(o,O.onHit);
                    return true;
                }
                if(O.toDo=='wait' && O.dec > 0){
                    O.speed-=1;
                    if(O.speed < 1){
                        delete this.Omoving[o];
                        O.toDo=0;
                    }
                }
                if(O.dec < 0 && O.toDo!='doExplodeX' && Dist < 100){
                  //  $('#O_'+o).addClass('detecting');
                    O.toDo='doExplodeX';
                }
                else if(O.toDo=='doExplodeX' && Dist >=100){
                  //  $('#O_'+o).removeClass('detecting');
                }
                if(O.toDo!='wait' && Dist < 30){
                    this.explodeBomb(o);
                    return true;
                }
            break; case 'bullet_bomb':
                if(O.S == 1){
                    if((Dist < 15 || O.dec < 0))
                        this.explodeBomb(o);
                }else{
                    if(O.dec < 0)
                        this.explodeBomb(o);
                    else{
                        var bomI,bomJ,bomT,bomt,bomoX,bomoY,bomE;
                        var bomX = parseInt(O.x/this.MapTileSize)- -1;
                        var bomY = parseInt(O.y/this.MapTileSize)- -1;
                        for(bomI=0; bomI<2; ++bomI)
                            for(bomJ=0; bomJ<2; ++bomJ){
                                bomE=(bomX-bomI)+'_'+(bomY-bomJ);
                                if(typeof this.Omap[bomE] != 'undefined'){
                                    bomT = this.Omap[bomE];
                                    for(bomt in bomT)if(typeof this.O[bomt] !='undefined'){
                                        bomoX = this.O[bomt].x-O.x;
                                        bomoY = this.O[bomt].y-O.y;
                                        if((this.O[bomt].radius- -O.radius) > Math.sqrt(bomoX*bomoX- -bomoY*bomoY)){
                                            this.explodeBomb(o);
                                        }
                                    }
                                }
                            }
                    }
                }
            break; case 'orhenes':
                if(Dist < 400 && O.ammo > 2000){
                    for(var i=0; i<8; ++i){
                        var L = this.putObj('carras','comp',O.S,O.x,O.y);
                        this.O[L].dec=600;
                        this.O[L].toDo='follow';
                        this.O[L].ammo=-100;
                    }
                    O.ammo=0;
                }
            break; case 'koriaz':
                if(O.ammo % 13 == 0){
                    var Site='A';
                    if(O.S==2) Site='B';
                    for(var q in this['Osite'+Site]){
                        var mX = O.x-this.O[q].x;
                        var mY = O.y-this.O[q].y;
                        if(Math.sqrt(mX*mX- -mY*mY) < 500){
                            this.addShield(q,14);
                        }

                    }
                }
            break; case 'dregos':
                if(O.toDo!='rest' && Dist < 400 && O.ammo > 140){
                    var Angle = parseInt(- (Math.atan2(X,Y)*180/Math.PI))%360;
                    if(O.toDo!='follow' && O.doSquad==-1){
                        O.toDo='follow';
                        O.dec=400;
                    }
                    this.shootMissle(o,Angle-20,15,150);
                    this.shootMissle(o,Angle- -20,15,150);
                    O.ammo=0;
                }
            break; case 'vitotas':
                if(O.toDo!='follow' && O.toDo!='aimLaser' && O.doSquad==-1 && Dist < 400){
                    O.toDo='follow';
                    O.dec=600;
                }
                if(Dist < 400 && O.ammo > 220){
                    O.toDo='aimLaser';
                    var Angle = parseInt(- (Math.atan2(X,Y)*180/Math.PI))%360;
                    O.laserAngle = Angle;
                    Angle =(( Angle -O.angle)- -540)%360;
                    //  $('#O_'+o).append('<div class="object laserAiming hit_'+parseInt(this.tick/100)+'" style="height: '+O.Distance+'px; transform: rotate('+Angle+'deg);"></div>');
                    O.ammo=0;
                    O.dec = O.LaserAim;
                }
                if(O.toDo=='aimLaser' && O.dec == 1){
                    this.shootLaser(o,O.Distance,O.Damage);
                    if(O.doSquad==-1)
                        O.toDo='follow';
                }

            break; case 'hajaher':
                if(Dist < 400 && O.ammo > 15){
                    if(O.toDo!='follow' && O.doSquad==-1){
                        O.toDo='follow';
                        O.dec=400;
                    }
                    var WU = this.countFutureShoot(0,O.x,O.y,12,30);
                    if(WU.r){
                        this.shootBullet(o,WU.a,12,30,1);
                        O.ammo=0;
                    }
                }
            break; case 'cloacker':
                if(Dist < 500 && O.ammo > 300 && O.toDo!='follow'){
                  //  $('#gameboard').append('<div class="object hit hit_blue hit_'+parseInt(this.tick/100)+'" style="left: '+O.x+'px; top: '+O.y+'px;"></div>');
                  //  $('#O_'+o).addClass('cloacked');
                    if(O.doSquad==-1)
                        O.toDo='follow';
                    O.dec=400;
                    O.speed=12;
                }
                if(Dist < 50 && O.toDo=='follow' && O.ammo > 300){
                  //  $('#O_'+o).removeClass('cloacked');

                    var Angle = parseInt(- (Math.atan2(X,Y)*180/Math.PI))%360;
                    this.shootBullet(o,Angle,14,50,1);
                    O.ammo=0;
                }
                if(O.ammo < 4){
                    var Angle = parseInt(- (Math.atan2(X,Y)*180/Math.PI))%360;
                    this.shootBullet(o,Angle,14,50,1);
                }
                if(O.ammo==4){
                    O.speed = 6;
                    O.toDo=1;
                    O.dec=-1;
                }
            break; case 'fariax':
                if(O.ammo % 10 == 0){
                    var Site='A';
                    if(O.S==2) Site='B';
                    for(var q in this['Osite'+Site])
                        if(o!=q)
                        if(this.O[q].life < this.O[q].lifeM){
                            var mX = O.x-this.O[q].x;
                            var mY = O.y-this.O[q].y;
                            if(Math.sqrt(mX*mX- -mY*mY) < 300){
                                var Angle = parseInt(- (Math.atan2(mX,mY)*180/Math.PI))%360;
                                this.shootHealingMissle(o,q,Angle);
                                break;
                            }
                    }
                }
            break; case 'healing_missle':
                if(typeof this.O[O.target] == 'undefined'){
                    this.removeObj(o);
                    break;
                }
                var mX = O.x-this.O[O.target].x;
                var mY = O.y-this.O[O.target].y;
                O.angle = parseInt(- (Math.atan2(mX,mY)*180/Math.PI))%360;
                var DistE = Math.sqrt(mX*mX- -mY*mY);
                if(DistE < this.O[O.target].radius){
                    this.healObj(O.target,1,o);
                }
            break;
            break; case 'dandares':
                // add Shield
                if(O.ammo > O.shieldAmmo){
                    for(var q in O.shieldArr){
                        if(O.shieldArr[q].L < O.shieldMax){
                            if(++O.shieldArr[q].L == 1){
                                var OBJid = this.putObj('dandares_shield','moving',O.S,O.x,O.y);
                                this.O[ OBJid ].DandaresId = o;
                                this.O[ OBJid ].lifeM = O.shieldMax;
                                this.O[ OBJid ].DandaresNum = q;
                                O.shieldArr[q].id = OBJid;
                            } else{
                                var sO = this.O[ O.shieldArr[q].id ];
                              //  $('#O_'+O.shieldArr[q].id).removeClass('life'+((sO.life/sO.lifeM).toFixed(1)*100));
                                sO.life = O.shieldArr[q].L;
                              //  $('#O_'+O.shieldArr[q].id).addClass('life'+((sO.life/sO.lifeM).toFixed(1)*100));
                            }
                            O.ammo = 0;
                            break;
                        }
                    }
                }
                // move Shields
                for(var q in O.shieldArr)
                    if(O.shieldArr[q].id!=-1){
                        var sO = this.O[ O.shieldArr[q].id ];
                        sO.x = O.x- -O.shieldArr[q].eR * Math.sin( ((parseInt(-O.angle-O.shieldArr[q].eQ)- -720)%360)*(Math.PI/180));
                        sO.y = O.y- -O.shieldArr[q].eR * Math.cos( ((parseInt(-O.angle-O.shieldArr[q].eQ)- -720)%360)*(Math.PI/180));
                        sO.angle = O.angle;
                        sO.speed = O.speed;
                    }
            break; case 'dandares_shield':
                if(O.toDo=='decay')
                    if(O.dec==1){
                        O.speed-=1;

                        if(O.life > 0){
                          //  $('#O_'+o).removeClass('life'+((O.life/O.lifeM).toFixed(1)*100));
                            O.life-=1;
                            CanvasManager.requestCanvas( o );
                          //  $('#O_'+o).addClass('life'+((O.life/O.lifeM).toFixed(1)*100));
                        }
                        if(O.life<=0)    this.removeObj(o);
                            else        O.dec=10;
                    }
            break; case 'hiacynt':
                if(Dist < 500 && O.toDo!='follow' && O.toDo!='rest' && O.toDo!='attack' && O.doSquad==-1){
                    O.toDo = 'follow';
                    O.speed = 10;
                    O.dec = 400;
                }
                if(Dist < 100 && O.toDo=='follow'){
                    O.toDo = 'attack';
                    O.dec = 31;
                  //  if(O.ammo > 120) O.ammo = 120;
                }
                if(O.toDo=='attack' && (O.dec%3)==0){
                  //  O.ammo -= 11;
                    var Angle = parseInt(- (Math.atan2(X,Y)*180/Math.PI))%360;

                    var L = this.putObj('hiacynt_shield','comp',O.S,O.x,O.y);
                    this.O[L].angle = Angle - parseInt(Math.random()*40)- -20;
                    this.O[L].speed = 16;
                    this.O[L].dec = 70;
                }
                if(O.toDo=='attack' && O.dec==1){
                    O.toDo = 'rest';
                    O.dec = 200;
                    O.speed = 5;
                }
            break; case 'hiacynt_shield':
                if(O.dec==66 || O.dec==62 || O.dec==58 || O.dec==54 || O.dec==50 || O.dec==46 || O.dec==42 || O.dec==38)
                    O.speed-=2;

                if((O.dec==50 || O.dec==30 || O.dec==20 || O.dec==10) && O.life > 0){
                  //  $('#O_'+o).removeClass('life'+((O.life/O.lifeM).toFixed(1)*100));
                    O.life-=1;
                    CanvasManager.requestCanvas( o );
                  //  $('#O_'+o).addClass('life'+((O.life/O.lifeM).toFixed(1)*100));
                }
                if(O.dec==1)
                    this.removeObj(o);
            break;


        }






        if(typeof O.shieldD != 'undefined' && --O.shieldD < 1){
          //  $('#O_'+o+' .shield').remove();
            delete O.shieldD;
        }

        if(O.toDo=='goToSquad'){
            O.doSquad='goToSquad';
            var X = O.x - O.squadX;
            var Y = O.y - O.squadY;
            var Angle = parseInt(- (Math.atan2(X,Y)*180/Math.PI)- -360)%360;
            var Dist = Math.sqrt(X*X- -Y*Y);
            var Tyk = (O.angle-Angle- -360)%360;
            if(Dist < 15){
                O.x = O.squadX;
                O.y = O.squadY;
                O.speed = this.O[ this.Squads[ O.squadId ].Leader ].speed;
                O.angle = this.O[ this.Squads[ O.squadId ].Leader ].angle;
                O.lastSpeedT = this.O[ this.Squads[ O.squadId ].Leader ].lastSpeedT;
            } else {
                O.speed = O.speedM;
                if(Tyk > 180){    O.angle = (O.angle- -360- -O.speedT) %360;    O.lastSpeedT = O.speedT;}
                if(Tyk < 180){    O.angle = (O.angle- -360-O.speedT) %360;    O.lastSpeedT =-O.speedT;}
            }
        }

        if(O.toDo=='follow'){
            if(O.Follow > 0){
                if(typeof this.O[O.Follow] !='undefined'){
                    var wiX = O.x-this.O[O.Follow].x;
                    var wiY = O.y-this.O[O.Follow].y;
                }
            }else{
                var wiX = O.x-P.x;
                var wiY = O.y-P.y;
            }
            if(typeof wiX!='undefined'){
                var Angle = parseInt(- (Math.atan2(wiX,wiY)*180/Math.PI)- -360)%360;
                var Tyk = (O.angle-Angle- -360)%360;
                var Ei = 180 - Math.abs( Tyk - 180);
                var speedT = O.speedT;
                if(Ei < speedT) speedT = Ei;
                if(Tyk > 180){    O.angle = (O.angle- -360- -speedT) %360; O.lastSpeedT = speedT;    }
                if(Tyk < 180){    O.angle = (O.angle- -360-speedT) %360;     O.lastSpeedT =-speedT; }
            }
        }


        if(O.toDo=='turnLeft'){        O.angle = (O.angle- -360- -O.speedT) %360;    O.lastSpeedT = O.speedT; }
        if(O.toDo=='turnRight'){    O.angle = (O.angle- -360-O.speedT) %360;    O.lastSpeedT =-O.speedT; }

        O.ammo++;
        O.dec--;
        if( O.energyField < O.energyFieldMax){
            if(++O.enegryFieldRelief >=    O.enegryFieldRefielTime){
              //  if(++O.energyField == 1)
              //      $('#O_'+o).prepend('<div class="energyField"></div>');
                O.enegryFieldRelief=0;
            }
        }
    }



    this.frame_decide = function(){
        var MS = (new Date()).getTime();
        $('#gameboardMarkers').html('');

        // Check Hits of Player Ship
        this.checkHits(0);

        this.decide_ship();
        this.MSship-=- ((new Date()).getTime() - MS);

        var MS = (new Date()).getTime();
        var o,O,oldX,oldY;
        var P = this.O[0];

        // Squads Decide
        for(s in this.Squads)
            this.decide_squad(s);

        // Bullet Decide
        for(o in this.Obullet){
            O = this.O[o];
            if(O.speedT) O.angle -=- O.speedT;

            if(this.Obullet[o]==1){
                var X = O.x-P.x;
                var Y = O.y-P.y;
                var Dist = Math.sqrt(X*X- -Y*Y);
                if(Dist < 2- -P.radius)    this.hit(o,0,O.Power);
                        else             this.checkHits(o);
            } else
                this.checkHits(o);

            if(--O.dec < 0)
                this.removeObj(o);
        }

        // Comp Decide
        for(o in this.Ocomp)
            this.checkHits(o);
        for(o in this.Ocomp)
            this.decide(o);


        // Animations Decide
        for(o in this.Oanim)
            if(++this.O[o].timeTick >= this.O[o].timeDeath)
                this.removeObj(o);

        for(o in this.Oregion){
            if(this.tick < this.O[o].ActiveTime) continue;
            if(this.tick > this.O[o].DieTime){
                this.removeObj(o);
                continue;
            }
            this.checkHits(o);
        }

        ++this.tick;

        this.MSdecide-=-((new Date()).getTime() - MS);
    }

    this.frame_move = function(){
        var MS = (new Date()).getTime();
        var o,O,oldX,oldY;
        var PIx = Math.PI / 180;

        for(o in this.Omoving){
            O = this.O[o];
            if(O.M=='static') continue;
            oldX = O.x;
            oldY = O.y;

            if( O.squadDirectPlace ){
                var Master = this.O[ O.squadDirectPlace.o ];
                var MasterS = Master.squadScheme[ O.squadDirectPlace.i ];
                O.x = Master.x- -MasterS.radius * Math.sin( (-parseInt(MasterS.angle- -Master.angle)-180)*PIx );
                O.y = Master.y- -MasterS.radius * Math.cos( (-parseInt(MasterS.angle- -Master.angle)-180)*PIx );

                O.angle = Master.angle;
            }
            else {
                O.x -=- O.speed * Math.sin( (-parseInt(O.angle)-180)*PIx);
                O.y -=- O.speed * Math.cos( (-parseInt(O.angle)-180)*PIx);

                if (O.vector){
                    for(var i in O.vector){
                        var V = O.vector[i];
                        O.x -=- V.speed * Math.sin( (-parseInt(V.angle)-180)*PIx);
                        O.y -=- V.speed * Math.cos( (-parseInt(V.angle)-180)*PIx);
                    }
                    delete(O.vector);
                }
            }

            if(O.T!='bullet')
                this.putOnXY(o,oldX,oldY);

            if(o==0){
                this.ShipMoveX = O.x - oldX;
                this.ShipMoveY = O.x - oldY;
            }

        }

        $('#countEnemies').html(this.EnemiesC);
      //  $('#gameboard').css({left: (-this.O[0].x- -(this.Dx/2))+'px',top: (-this.O[0].y- -(this.Dy/2))+'px'});

        this.MSmove-=-((new Date()).getTime() - MS);
    }

    this.frame_draw = function(){
        var MS = (new Date()).getTime();
        var o,O,oldX,oldY;
        var P = this.O[0];
        var CH = this.CanvasHandle;
        var Px = P.x-(this.Dx/2);
        var Py = P.y-(this.Dy/2);

        CH.save();
        CH.fillStyle="rgba(0,0,0,0.12)";
        if(GET['BLUR'] > 1) CH.translate(this.shipMoveX,this.shipMoveY);
        if(!GET['BLUR'])
            CH.fillStyle="black";
        CH.fillRect(0, 0, this.Dx, this.Dy);
        CH.restore();

        var Radi = Math.PI/180;

        for(o in this.O){
            O = this.O[o];
            if(GET['DEBUG']){
                CH.save();
                CH.strokeStyle = 'white';
                CH.beginPath();
                if(O.squareCorners){
                    CH.moveTo( (O.squareCorners.A.x-Px).toFixed(1), (O.squareCorners.A.y-Py).toFixed(1) );
                    CH.lineTo( (O.squareCorners.B.x-Px).toFixed(1), (O.squareCorners.B.y-Py).toFixed(1) );
                    CH.lineTo( (O.squareCorners.C.x-Px).toFixed(1), (O.squareCorners.C.y-Py).toFixed(1) );
                    CH.lineTo( (O.squareCorners.D.x-Px).toFixed(1), (O.squareCorners.D.y-Py).toFixed(1) );
                    CH.lineTo( (O.squareCorners.A.x-Px).toFixed(1), (O.squareCorners.A.y-Py).toFixed(1) );
                }else if(O.coneAngle){
                    var Angle1 = (O.angle- -O.coneAngle-90)*Radi;
                    var Angle2 = (O.angle - O.coneAngle-90)*Radi;
                    CH.arc(O.x-Px,O.y-Py,O.radius,Angle1,Angle2,true);
                    CH.arc(O.x-Px,O.y-Py,O.coneRad2,Angle2,Angle1,false);
                    CH.closePath();
                }else{
                    CH.arc((O.x-Px).toFixed(0), (O.y-Py).toFixed(0),O.radius,0,Math.PI*2,true);
                }
                CH.stroke();
                CH.restore();
            }

            if(typeof O.canvasId != 'undefined'){
                CH.save();
                CH.translate((O.x-Px).toFixed(0), (O.y-Py).toFixed(0));
                if(O.viewAngle)
                    CH.rotate(Radi*(O.angle- -O.viewAngle));
                else if(O.angle)
                    CH.rotate(Radi*O.angle);
                CH.drawImage(O.canvasId,-O.canvasX,-O.canvasY);

                if(O.energyField && O.energyField > 0){
                    CH.beginPath();
                    var Radius = O.radius;
                    var lineWidth = O.energyField;
                    if(lineWidth > 2)
                        lineWidth = 2- -(lineWidth-2)/2;

                    if(o==0){
                        CH.strokeStyle = 'rgba(154,255,255,0.8)';
                        CH.fillStyle = 'rgba(154,255,255,0.2)';
                        Radius-=-7;
                    } else {
                        CH.strokeStyle = 'rgba(0,255,0,0.8)';
                        CH.fillStyle = 'rgba(0,255,0,0.2)';
                    }
                    CH.arc(0,0,Radius- -parseInt(lineWidth/2),0,Math.PI*2,true);
                    CH.lineWidth = lineWidth;
                    CH.stroke();
                    CH.fill();
                }
                CH.restore();
            }
            if(O.TT=='anim'){
                CH.save();
                CH.translate((O.x-Px).toFixed(0), (O.y-Py).toFixed(0));
                var Canvas = CanvasManager.getCanvas(O);
                if(O.angle != 0) CH.rotate(Radi*O.angle);
                CH.drawImage(Canvas.Id, -Canvas.X, -Canvas.Y);
                CH.restore();
                continue;
            }
            if(O.TT=='dirAnim'){
                CanvasManager.directRender(CH,O);
                continue;
            }
            if(O.TT=='regionAnim'){
                CanvasManager.regionAnim(CH,O);
                continue;
            }
            if(O.TT=='simpleFilling'){
                CanvasManager.simpleFilling(CH,O);
                continue;
            }
        }
        ++this.tickD;
        this.MSdraw-=-((new Date()).getTime() - MS);
    }

    this.frame = function(){
        if(GET['FRAMES']==0){
            this.frame_move();
            this.frame_decide();
            this.frame_draw();
        }else if(GET['FRAMES'] > 0){
            var FR = parseInt( 1000/this.Frames )-2;
            var now = new Date().getTime();
            var PASSED = now - this.FRAME_TIME;
            if(PASSED < FR){
                this.intervalIndex = window.requestAnimationFrame(function(){ GAME.frame(); });
                return true;
            }
            if(GET['FRAMES']==1){
                this.FRAME_TIME = now;
            }
            if(GET['FRAMES']==2){
                this.FRAME_TIME-=-FR;
            }
            this.frame_move();
            this.frame_decide();
            if(GET['FRAMES']==3 || GET['FRAMES']==4){
                PASSED-=FR;
                this.FRAME_TIME-=-FR;
                var X = 0;
                while(PASSED > FR){
                    this.frame_move();
                    this.frame_decide();
                    PASSED-=FR;
                    this.FRAME_TIME-=-FR;
                    if(++X >=3){
                        this.FRAME_TIME=now;
                        break;
                    }
                }
            } else {
            }
            this.frame_draw();
        }


        if(GET['FPS'] > 0){
            var D = parseInt(new Date().getTime()/1000);
            if(D != this.FPSx){
                var FPS = this.tick - this.FPSy;
                var FPSu = this.tickD - this.FPSz;
                if(GET['FPS'] > 1){
                    $('#FPSpillar').prepend('<div><div style="height: '+FPS*3+'px;"><div style="height: '+FPSu*3+'px;"></div></div></div>');
                    $('#FPSpillar div:nth-child(151)').remove();
                }
                var html = '';
                html += parseInt(this.O[0].x)+' '+parseInt(this.O[0].y)+'<br/>';
                html += FPSu+' / '+FPS+' fps';
                $('#FPSnum').html(html);
                this.FPSy=this.tick;
                this.FPSz=this.tickD;

                if(GET['FPS'] > 2){
                    var u = 1000 - this.MSship - this.MSdecide - this.MSmove - this.MSdraw;
                    html = '';
                    html += '<div class="FPS_MS">'+this.MSship+'<div class="" style="height: '+parseInt(this.MSship/10)+'px;">[s]</div></div>';
                    html += '<div class="FPS_MS">'+this.MSdecide+'<div class="" style="height: '+parseInt(this.MSdecide/10)+'px;">[d]</div></div>';
                    html += '<div class="FPS_MS">'+this.MSmove+'<div class="" style="height: '+parseInt(this.MSmove/10)+'px;">[m]</div></div>';
                    html += '<div class="FPS_MS">'+this.MSdraw+'<div class="" style="height: '+parseInt(this.MSdraw/10)+'px;">[c]</div></div>';
                    html += '<div class="FPS_MS">'+u+'<div class="" style="height: '+parseInt(u/10)+'px;"></div></div>';

                    $('#FPS_MS').html(html);

                    this.MSdraw = 0;
                    this.MSdecide = 0;
                    this.MSship = 0;
                    this.MSmove = 0;
                }

            }
            this.FPSx=D;
        }

        if(this.EnemiesC < 1 || this.O[0].life < 1)
            this.endGame();

        if(!this.pause && !this.doEndGame)
            if(GET['FRAMES'] < 4)
                this.intervalIndex = window.requestAnimationFrame(function(){ GAME.frame(); });
            else
                this.intervalIndex = setTimeout(function(){ GAME.frame(); }, 1);
    }


    this.endGame = function(){
        window.cancelAnimationFrame(this.intervalIndex);
        if(this.doEndGame==true) return false;
        this.doEndGame=true;

        var html='';
        if(this.EnemiesC==0 && this.O[0].life > 0)
            html='<span style="font-size: 70px;">You Won!</span><br/>';
        else
            html='<span style="font-size: 70px;">'+this.EnemiesC+' enemies left</span><br/>';
        $('#Game').append('<div id="endGameBoard">'+html+'</div>');

        $('.enemy').each(function(){
            var html='',Letter,T = $(this).attr('class');
            if(T.indexOf('dregos') > -1) Letter='U';
            if(T.indexOf('carras') > -1) Letter='A';
            if(T.indexOf('muerto') > -1) Letter='M';
            if(T.indexOf('orhenes') > -1) Letter='Q';
            if(T.indexOf('tartaros') > -1) Letter='T';
            if(T.indexOf('belzebub') > -1) Letter='B';
            if(T.indexOf('nemezis') > -1) Letter='N';
            if(T.indexOf('koriaz') > -1) Letter='K';
            if(T.indexOf('cloacker') > -1) Letter='C';
            if(T.indexOf('fariax') > -1) Letter='F';
            if(T.indexOf('gargamon') > -1) Letter='G';
            if(T.indexOf('hajaher') > -1) Letter='S';
            if(T.indexOf('dandares') > -1) Letter='D';
            if(T.indexOf('juggernaut') > -1) Letter='J';
            if(T.indexOf('vitotas') > -1) Letter='V';
            if(T.indexOf('edison') > -1) Letter='E';
            if(T.indexOf('hiacynt') > -1) Letter='H';
            if(T.indexOf('warastein') > -1) Letter='W';
            if(T.indexOf('iskariot') > -1) Letter='I';
            if(T.indexOf('royale') > -1) Letter='R';

            if(T.indexOf('life-dead') > -1) html='<span class="killed">'+Letter+'</span> ';
                        else            html=Letter+' ';
            $('#endGameBoard').append(html);
        });
        setTimeout("$('#Game').unbind('click').click(function(){ GAME.goToMenu(); });",1200);

    }
    this.goToMenu = function(){
        $(window).unbind();
        delete GAME;
        $('#Game').unbind('click').html('').hide();
        $('#Menu').show();
    }
}

$(document).ready(function(){
    MENU = new MENUobject();
    MENU.start();
});
</script>

<style type="text/css">    /* Menu */
html{ height: 80%;}
body{
    background: darkblue;
    width: 100%;
    margin: 0px;
    min-height: 100%;
    padding: 0px;
    font-family: Arial,sans-serif;
}
#Menu{
    width: 100%;
    max-width: 100%;
    overflow: hidden;
}
.keys{
    color: white;
    font-size: 14px;
}
.keys:before{
    content: 'keys: ';
}
.keys span{
    display: inline-block;
    padding: 5px 12px;
}

.ShipPresets{
    font-size: 24px;
    font-weight: bold;
    border: 6px double black;
    border-radius: 12px;
}
.ShipPresets span{
    display: inline-block;
}
.ShipPresets .chooseShipPresets{
    display: inline-block;
    margin: 5px 0px 5px 10px;
    border: 5px double black;
    min-width: 30px;
    border-radius: 100%;
    cursor: pointer;
}
.ShipPresets .chooseShipPresets.choosenPreset{
    border: 5px solid black;
    text-shadow: 1px 0px white, 0px 1px white, -1px 0px white, 0px -1px white;
}

#MenuBoards{
    width: 70%;
    left: 12%;
    top: 20px;
    min-height: 400px;
    padding: 20px;
    background: black;
    background: rgba(0,0,0,0.2);
    border: 10px double black;
    text-align: center;
    border-radius: 30px;
    position: absolute;

}
.MainMenuButton{
    display: inline-block;
    font-weight: bold;
    margin: 10px;
    padding: 10px 25px;
    border: 10px solid black;
    color: white;
    font-size: 30px;
    cursor: pointer;
    border-radius: 100%;
}
.MainMenuButton:hover{
    color: black;
    background: white;
}
#MenuBoards .ToggleMenu{
    background: black;
    background: rgba(0,0,0,0.2);
    border-color: black;
    border-radius: 0px 30px 30px 0px;
    border-style: double;
    border-width: 10px 10px 10px 0px;
    cursor: pointer;
    height: 80px;
    position: absolute;
    right: -100px;
    top: 50px;
    width: 80px;
}

#MenuShip{
    width: 70%;
    left: 12%;
    top: 20px;
    min-height: 400px;
    padding: 20px;
    background: black;
    background: rgba(0,0,0,0.2);
    border: 10px double black;
    text-align: center;
    border-radius: 30px;
    position: absolute;
}
#MenuShip .ToggleMenu{
    background: black;
    background: rgba(0,0,0,0.2);
    border-color: black;
    border-radius: 30px 0px 0px 30px;
    border-style: double;
    border-width: 10px 0px 10px 10px;
    cursor: pointer;
    height: 80px;
    position: absolute;
    left: -100px;
    top: 50px;
    width: 80px;
}

#moneyTable{
    font-size: 40px;
    color: gold;
    text-shadow: 2px 0px white, -2px 0px white, 0px 2px white, 0px -2px white;
    font-weight: bold;
    letter-spacing: 5px;
}

#shipTable{
    float: left;
    width: 30%;
    min-height: 200px;
    color: white;
    font-size: 18px;
    font-weight: bold;
    text-align: left;
}

#upgradesTable{
    float: left;
    width: 70%;
    min-height: 200px;
    position: relative;
    color: white;
}

#upgradesTable .upgradesType{
    width: 100%;
    position: absolute;
    top: 30px;
    left: 0px;
    z-index: 1;
}
#upgradesTable .upgradesType.wybrany{ z-index: 2; }

#upgradesTable .upgradesTitle{
    border-width: 2px 2px 0px 2px;
    border-radius: 10px 10px 0px 0px;
    border-style: solid;
    border-color: black;
    display: inline-block;
    padding: 5px 15px;
    background: #00006f;
    position: absolute;
    top: -30px;
    left: 0px;
    cursor: pointer;
}
#upgradesTable .upgradesType:nth-child(1) .upgradesTitle{ left: 0px; }
#upgradesTable .upgradesType:nth-child(2) .upgradesTitle{ left: 90px; }
#upgradesTable .upgradesType:nth-child(3) .upgradesTitle{ left: 180px; }
#upgradesTable .upgradesType:nth-child(4) .upgradesTitle{ left: 270px; }

#upgradesTable .upgradesContent{
    border-top: 2px solid black;
    padding-top: 10px;
    height: 100%;
    min-height: 320px;
    background: #00006f;
}
#upgradesTable .upgradesContent .upgrade{
    border: 5px double #000;
    margin: 3px;
    border-radius: 8px;
    padding: 5px 10px;
    display: inline-block;
}
#upgradesTable .upgradesContent .upgrade.on_ship{
    border-color: gold;
    color: gold;
}

</style>
<style type="text/css">    /* Ship Consoles */
#Game{overflow: hidden;}
#countEnemies{
    position: absolute;
    height: 20px;
    padding: 4px 8px;
    top: 0px;
    right: 0px;
    background: black;
    color: white;
    font-weight: bold;
    font-size: 20px;
    line-height: 20px;
    border-style: solid;
    border-color: blue;
    border-width: 0px 0px 2px 2px;
    border-radius: 0px 0px 0px 20px;
    z-index: 1;
}
#countEnemies:before{
    content: 'Enemies: ';
}
#countHealth{
    position: absolute;
    height: 20px;
    padding: 4px 8px;
    top: 0px;
    left: 0px;
    background: black;
    color: blue;
    font-weight: bold;
    font-size: 20px;
    line-height: 20px;
    border-style: solid;
    border-color: blue;
    border-width: 0px 2px 2px 0px;
    border-radius: 0px 0px 20px 0px;
    z-index: 1;
}
#countHealth .disabledHealth    {    color: grey; }
#countHealth .XenergyField{            color: #0ff; }
#countHealth .XenergyFieldDisabled{    color: grey; }


#countSpeed{
    cursor: crosshair;
    position: absolute;
    padding: 8px 0px 0px;
    bottom: 0px;
    left: 63px;
    background: black;
    color: white;
    width: 30px;
    font-weight: bold;
    font-size: 20px;
    line-height: 20px;
    border-style: solid;
    border-color: blue;
    border-width: 2px 2px 0px 2px;
    border-radius: 8px 8px 0px 0px;
    z-index: 1;
}
#countSpeed .speedBox{
    position: absolute;
    bottom: 0px;
    left: -62px;
    border-width: 2px 2px 0px 2px;
    border-style: solid;
    border-color: blue;
    border-radius: 6px 6px 0px 0px;
    padding: 4px 4px 34px;
    background: black;
    text-align: center;
    width: 30px;
}
#countSpeed .speedBoxSpeed{
    font-size: 15px;
}

#countSpeed .speedBoxEnergy{
    border: 2px solid blue;
    border-radius: 8px;
    bottom: 4px;
    font-size: 18px;
    line-height: 24px;
    left: -5px;
    position: absolute;
    text-align: center;
    background: black;
    width: 45px;
}
#countSpeed .speedOmeter{
    margin-top: 1px;
    width: 30px;
    height: 0px;
    background: #040;
}
#countSpeed .speedOmeter.speed_1{ height: 6px; background: #050; }
#countSpeed .speedOmeter.speed_2{ height: 10px; background: #0a0; }
#countSpeed .speedOmeter.speed_3{ height: 12px; background: #0f0;  }
#countSpeed .speedOmeter.speed_4{ height: 14px; background: #5f0;  }
#countSpeed .speedOmeter.speed_5{ height: 16px; background: #af0;  }
#countSpeed .speedOmeter.speed_6{ height: 18px; background: #ff0;  }
#countSpeed .speedOmeter.speed_7{ height: 20px; background: #fc0;  }
#countSpeed .speedOmeter.speed_8{ height: 22px; background: #fa0;  }
#countSpeed .speedOmeter.speed_9{ height: 24px; background: #f80;  }
#countSpeed .speedOmeter.speed_10{ height: 26px; background: #f40;  }
#countSpeed .speedOmeter.speed_11{ height: 28px; background: #f00;  }
#countSpeed .speedOmeter.speed_12{ height: 28px; background: #e00;  }
#countSpeed .speedOmeter.speed_13{ height: 28px; background: #d00;  }
#countSpeed .speedOmeter.speed_14{ height: 28px; background: #c00;  }
#countSpeed .speedOmeter.speed_15{ height: 28px; background: #900;  }
#countSpeed .speedOmeter.speed_16{ height: 28px; background: #500;  }
#countSpeed .speedOmeter.speed_17{ height: 28px; background: #500;  }
#countSpeed .speedOmeter.speed_18{ height: 28px; background: #500;  }
#countSpeed .speedOmeter.speed_19{ height: 28px; background: #500;  }
#countSpeed .speedOmeter.speed_20{ height: 28px; background: #500;  }

#countSpeed .speedOmeter span{
    display: block;
    background: black;
    width:30px;
}
#countSpeed .speedOmeter span.speedCap_10{ height: 10%; }
#countSpeed .speedOmeter span.speedCap_20{ height: 20%; }
#countSpeed .speedOmeter span.speedCap_30{ height: 30%; }
#countSpeed .speedOmeter span.speedCap_40{ height: 40%; }
#countSpeed .speedOmeter span.speedCap_50{ height: 50%; }
#countSpeed .speedOmeter span.speedCap_60{ height: 60%; }
#countSpeed .speedOmeter span.speedCap_70{ height: 70%; }
#countSpeed .speedOmeter span.speedCap_80{ height: 80%; }
#countSpeed .speedOmeter span.speedCap_90{ height: 90%; }
#countSpeed .speedOmeter span.speedCap_100{ height: 100%; }

#countSpeed .cBox{
    position: relative;
    height: 32px;
}
#countSpeed .energyBox{
    text-align:center;
    border-radius: 8px;
    border: 2px solid blue;
    background: #6f0;
    color: white;
    font-size: 18px;
    padding: 2px 4px;
    position: absolute;
    top: 0px;
    left: -14px;
    width: 45px;
    cursor: pointer;
    height: 21px;
    text-shadow: 0 1px black, 0 -1px black, -1px 0 black, 1px 0 black;
}
#countSpeed .energyBox.energyCap_00{ background: #000; }
#countSpeed .energyBox.energyCap_10{ background: linear-gradient(to bottom, #000 90%,#6f0 90%); }
#countSpeed .energyBox.energyCap_20{ background: linear-gradient(to bottom, #000 80%,#6f0 80%); }
#countSpeed .energyBox.energyCap_30{ background: linear-gradient(to bottom, #000 70%,#6f0 70%); }
#countSpeed .energyBox.energyCap_40{ background: linear-gradient(to bottom, #000 60%,#6f0 60%); }
#countSpeed .energyBox.energyCap_50{ background: linear-gradient(to bottom, #000 50%,#6f0 50%); }
#countSpeed .energyBox.energyCap_60{ background: linear-gradient(to bottom, #000 40%,#6f0 40%); }
#countSpeed .energyBox.energyCap_70{ background: linear-gradient(to bottom, #000 30%,#6f0 30%); }
#countSpeed .energyBox.energyCap_80{ background: linear-gradient(to bottom, #000 20%,#6f0 20%); }
#countSpeed .energyBox.energyCap_90{ background: linear-gradient(to bottom, #000 10%,#6f0 10%); }
#countSpeed .energyBox.energyCap_100{ background: #6f0; }


#countSpeed .energyBox.min{
    color: grey;
    background: black;
}
#countSpeed .energyBox .min{
    top: -11px;
    position: absolute;
    left: 16px;
    font-size: 10px;
    color: grey;
    text-align: left;
}
#countSpeed .energyBox.active{
    color: gold;
}
#countSpeed .energyBox .active{
    top: -11px;
    position: absolute;
    left: 11px;
    font-size: 10px;
    color: gold;
    text-align: left;
}
#countSpeed .energyBox .smaller{
    font-size: 10px;
}
#countSpeed .energyBox.max{
    color: gold;
}
#countSpeed .energyBox .max{
    top: -11px;
    position: absolute;
    left: 16px;
    font-size: 10px;
    color: gold;
    text-align: left;
}
#countSpeed .energyBox .max{
    line-height:
}
#countSpeed .energyBox .infoBox{
    position: absolute;
    top: 0px;
    cursor: crosshair;
    right: -113px;
    width: 100px;
    border-style: solid;
    border-color: blue;
    border-width: 1px 1px 1px 0px;
    border-radius: 6px;
    padding: 3px 6px;
    height: 16px;
    font-size: 16px;
    line-height: 16px;
    text-shadow: none!important;
}
#countSpeed .letter{
    color: white;
    font-size: 10px;
    font-weight: normal;
    left: -17px;
    position: absolute;
    text-shadow: 0 1px blue, 0 -1px blue, 1px 0 blue, -1px 0 blue;
    top: 4px;
    z-index: 2;
}

#countSpeed .energyBox .infoBox .smaller_title{
    font-size: 12px;
    font-weight: bold;
    line-height: 17px;
    width: 110px;
    left: -3px;
    text-align: center;
    position: relative;
}
#countSpeed .energyBox .infoBox .titleBox{
    position: absolute;
    font-size: 13px;
    top: -10px;
    left: 10px;
    width: 110px;
    text-align: left;
}
#countSpeed .energyBox .infoBox .titleBox .smaller_title{
    font-size: 12px;
    font-weight: bold;
    line-height: 17px;
    top: 13px;
    left: -7px;
    position: absolute;
    width: 110px;
    text-align: center;
}
#countSpeed .energyBox .infoBox .progresBar{
    height: 12px;
    margin-top: 2px;
    width: 100px;
    background: black;
    position: relative;
}
#countSpeed .energyBox .infoBox .progresBar .progresBarOBar{
    background: yellow;
    height: 12px;
}
#countSpeed .energyBox .infoBox .progresBar .info{
    position: absolute;
    top: 0px;
    right: 0px;
    color: white;
    font-size: 12px;
    font-weight: bold;
    text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
    line-height: 12px;
    padding-right: 10px;
}
#countSpeed .energyBox .infoBox .progresBar .progresBarOBar.green{
    background: #0f0;
}
#countSpeed .energyBox .laserBoxBox{
    position: absolute;
    top: 0px;
    right: 0px;
}
#countSpeed .energyBox .laserBox{
    color: grey;
    font-size: 10px;
    display: inline-block;
    position: absolute;
    border-style: solid;
    border-color: blue;
    border-width: 1px 1px 1px 0px;
    border-radius: 6px;
    padding: 2px 6px;
    left: -1px;
}
#countSpeed .energyBox .laserBox span{
    color: yellow;
}
#countSpeed .energyBox .ammoBoxBox{
    position: absolute;
    top: 0px;
    right: 0px;
    cursor: crosshair;
}
#countSpeed .energyBox .ammoBox{
    color: grey;
    font-size: 10px;
    display: inline-block;
    float: left;
    border-style: solid;
    border-color: blue;
    border-width: 1px 1px 1px 0px;
    border-radius: 6px;
    padding: 2px 6px;
    left: -4px;
}
#countSpeed .energyBox .ammoBoxes{
    width: 900px;
    position: absolute;
    top: 0px;
    left: 0px;
}
#countSpeed .energyBox .ammoBox span{
    color: yellow;
}
#countSpeed .energyBox .attackBox{
    color: grey;
    cursor: pointer;
    font-size: 10px;
    display: inline-block;
    float: left;
    border-style: solid;
    border-color: blue;
    border-width: 1px 1px 1px 0px;
    border-radius: 6px;
    padding: 2px 6px;
    min-width: 20px;
    height: 20px;
    position: relative;
}
#countSpeed .energyBox .attackBoxNum{
    position: absolute;
    color: white;
    top: -13px;
    left: 14px;
}
#countSpeed .energyBox .attackBox.attackBoxActive{
    border-color: #04f;
}
#countSpeed .energyBox .attackBox  span{ position: absolute; display: block; color: grey; }
#countSpeed .energyBox .attackBox.attackBoxActive span{ color: yellow; }
#countSpeed .energyBox .attackBox.attack_single span:nth-child(1){ top: -3px; left: 16px; }
#countSpeed .energyBox .attackBox.attack_single span:nth-child(1):before{ content: 'i'; }
#countSpeed .energyBox .attackBox.attack_single span:nth-child(2){ top: 6px; left: 16px; }
#countSpeed .energyBox .attackBox.attack_single span:nth-child(2):before{ content: 'i'; }

#countSpeed .energyBox .attackBox.attack_double span:nth-child(1){ top: -3px; left: 12px; }
#countSpeed .energyBox .attackBox.attack_double span:nth-child(1):before{ content: 'i'; }
#countSpeed .energyBox .attackBox.attack_double span:nth-child(2){ top: 6px; left: 12px; }
#countSpeed .energyBox .attackBox.attack_double span:nth-child(2):before{ content: 'i'; }
#countSpeed .energyBox .attackBox.attack_double span:nth-child(3){ top: -3px; left: 19px; }
#countSpeed .energyBox .attackBox.attack_double span:nth-child(3):before{ content: 'i'; }
#countSpeed .energyBox .attackBox.attack_double span:nth-child(4){ top: 6px; left: 19px; }
#countSpeed .energyBox .attackBox.attack_double span:nth-child(4):before{ content: 'i'; }

#countSpeed .energyBox .attackBox.attack_rose span:nth-child(1){ top: 0px; left: 16px; }
#countSpeed .energyBox .attackBox.attack_rose span:nth-child(1):before{ content: 'i'; }
#countSpeed .energyBox .attackBox.attack_rose span:nth-child(2){ top: 2px; left: 20px; transform: rotate(25deg);}
#countSpeed .energyBox .attackBox.attack_rose span:nth-child(2):before{ content: 'i'; }
#countSpeed .energyBox .attackBox.attack_rose span:nth-child(3){ top: 2px; left: 11px; transform: rotate(-25deg); }
#countSpeed .energyBox .attackBox.attack_rose span:nth-child(3):before{ content: 'i'; }
#countSpeed .energyBox .attackBox.attack_rose span:nth-child(4){ top: 6px; left: 23px; transform: rotate(50deg); }
#countSpeed .energyBox .attackBox.attack_rose span:nth-child(4):before{ content: 'i'; }
#countSpeed .energyBox .attackBox.attack_rose span:nth-child(5){ top: 6px; left: 7px; transform: rotate(-50deg); }
#countSpeed .energyBox .attackBox.attack_rose span:nth-child(5):before{ content: 'i'; }

#countSpeed .energyBox .attackBox.attack_missle span:nth-child(1){ top: 2px; left: 12px; }
#countSpeed .energyBox .attackBox.attack_missle span:nth-child(1):before{ content: 'Y'; font-size: 16px; }


#countSpeed .energyBox .attackBox.attack_missleR span{ font-size: 8px; }
#countSpeed .energyBox .attackBox.attack_missleR span:nth-child(1){ top: 0px; left: 15px; }
#countSpeed .energyBox .attackBox.attack_missleR span:nth-child(1):before{ content: 'Y'; }
#countSpeed .energyBox .attackBox.attack_missleR span:nth-child(2){ top: 2px; left: 20px; transform: rotate(45deg);}
#countSpeed .energyBox .attackBox.attack_missleR span:nth-child(2):before{ content: 'Y'; }
#countSpeed .energyBox .attackBox.attack_missleR span:nth-child(3){ top: 3px; left: 7px; transform: rotate(-45deg); }
#countSpeed .energyBox .attackBox.attack_missleR span:nth-child(3):before{ content: 'Y'; }




#countSpeed .energyBox .attackBox.attack_bomb span:nth-child(1){ top: 2px; left: 12px; }
#countSpeed .energyBox .attackBox.attack_bomb span:nth-child(1):before{ content: 'P'; font-size: 16px; }

#countSpeed .energyBox .attackBox.attack_tele span:nth-child(1){ top: 10px; left: 10px; }
#countSpeed .energyBox .attackBox.attack_tele span:nth-child(1):before{ content: '*'; font-size: 40px; }

#countSpeed .energyBox .attackBox.attack_laser span:nth-child(1){ top: 0px; left: 14px; width: 6px; background: #888; height: 24px; }
#countSpeed .energyBox .attackBox.attack_laser span:nth-child(1):before{ content: ' '; position: absolute; top: 0px; left: 2px; width: 2px; height: 24px; background: #555; }

#countSpeed .energyBox .attackBox.attackBoxActive.attack_laser span:nth-child(1){ background: white; }
#countSpeed .energyBox .attackBox.attackBoxActive.attack_laser span:nth-child(1):before{ background: #08f; }



.estimationMarkers{
    position: absolute;
    width: 2px;
    height: 2px;
    background: red;
}
.estimationMarkers.GluedOne span{
    position: absolute;
    border: 2px dashed rgba(255,0,0,0.4);
    border-radius: 100%;
}

.estimationMarkers.MissleAim{
    background: transparent;
}
.estimationMarkers.MissleAim span{
    position: absolute;
    border: 2px dashed rgba(255,255,0,0.4);
    border-radius: 100%;
}

.estimationMarkers.LaserAim{
    background: transparent;
}
.estimationMarkers.LaserAim span{
    position: absolute;
    border: 2px dashed rgba(255,0,0,0.4);
    border-radius: 100%;
}

#countRadar{
    position: absolute;
    bottom: 0px;
    right: 0px;
    z-index: 1;

}
#Radar{
    position: absolute;
    bottom: -2px;
    right: -2px;
    border: 2px solid blue;
    border-radius: 160px 0px 0px 0px;
    background: rgba(0,0,0,0.6);
    width: 160px;
    height: 160px;

}
.radarDial{
    width: 200px;
    height: 200px;
    border-radius: 100%;
    border: 6px double blue;
    position: absolute;
    background: rgba(0,0,0,1);
    bottom: 5px;
    right: 5px;
}
.radarCenter{
    position: absolute;
    bottom: 100px;
    right: 100px;
    width: 1px;
    height: 1px;
    background: white;

}
.radarStick{
    potision: absolute;
    width: 1px;
    height: 100px;
    background: white;
    transform-origin: 0px 0px;
}

.radarPoint{
    width: 2px;
    height: 2px;
    background: grey;
    position: absolute;
}
.rP_350, .rP_351, .rP_352, .rP_353, .rP_354, .rP_355, .rP_356, .rP_357, .rP_358, .rP_359,
.rP_340, .rP_341, .rP_342, .rP_343, .rP_344, .rP_345, .rP_346, .rP_347, .rP_348, .rP_349{
    background: #ff0;
}
.rP_330, .rP_331, .rP_332, .rP_333, .rP_334, .rP_335, .rP_336, .rP_337, .rP_338, .rP_339{
    background: #fff;
}
.rP_320, .rP_321, .rP_322, .rP_323, .rP_324, .rP_325, .rP_326, .rP_327, .rP_328, .rP_329{
    background: #ccc;
}


.object.laserAiming{
    width: 0px;
    height: 650px;
    border-left: 1px dashed red;
    position: absolute;
    top: 0px;
    left: 0px;
    transform-origin: 0px 0px;
}
.object.life-dead .laserAiming{ display: none;}

</style>
<style type="text/css">    /* Game Divs */
#CanvasPreviews{ display: none; }
//#CanvasPreviews{position: fixed; background: #005; top: 0px; left: 0px; z-index: 1000; display: block; }

#Game{
    position: relative;
    width: 0px;
    height: 0px;
    margin: 0px auto;
    background: orange;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
#gamearea{
    position: absolute;
    top: 0px;
    left: 0px;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: black;
}
#gameboard{
    display: none;
    position: absolute;
}
#gameboard2{
    position: absolute;
}
#gameboardMarkers{
    position: absolute;
}

#endGameBoard{
    border: 5px solid blue;
    width: 50%;
    left: 24%;
    top: 30%;
    padding: 30px 20px;
    text-align: center;
    background: black;
    background: rgba(0,0,0,0.5);
    position: relative;
    font-size: 30px;
    color: maroon;
    font-weight: bold;
}
#endGameBoard .killed{ color: #444; }

#pause{
    border-radius: 0px 0px 0px 400px;
    border-style: double;
    border-color: blue;
    border-width: 0px 0px 20px 20px;
    background: darkblue;
    background: rgba(0,0,120,0.5);
    position: absolute;
    top: 0px;
    right: 0px;
    width: 360px;
    height: 360px;
    display: none;
    z-index: 1;
}
#pause span{
    font-size: 100px;
    font-weight: bold;
    border-radius: 100%;
    display: block;
    width: 130px;
    line-height: 130px;
    text-align: center;
    background: darkblue;
    color: white;
    position: absolute;
    top: 60px;
    right: 60px;
}

#gameOverlay{
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0px;
    left: 0px;
    line-height: 100%;
    overflow: hidden;
}

#gameOverlay #bulletRadius{
    position: absolute;
    top: 50%;
    left: 50%;
    width: 1px;
    height: 1px;
}
#gameOverlay #bulletRadius #bullRadX{
    border-radius: 100%;
    margin: auto;
    border: 3px solid rgba(0,0,255,0.2);
    width: 100px;
    height: 100px;
    position: absolute;
    top: -50px;
    left: -50px;
}
#gameOverlay.cursorCross{ cursor: crosshair; }
#gameOverlay.cursorCross #bulletRadius #bullRadX{ cursor: crosshair; }
#gameOverlay.cursorWait{ cursor: not-allowed; }
#gameOverlay.cursorWait #bulletRadius #bullRadX{ cursor: not-allowed; }

.redMist{
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0px;
    left: 0px;
    background: transparent;
    animation-name: redMist;
    animation-duration: 0.8s;
}
@keyframes redMist {
    0% { background: rgba(255,0,0,0.3); }
    100% {background: transparent;}
}

</style>
<style>    /* Debug - FPS */
#FPS{
    position: fixed;
    right: 0px;
    bottom: 0px;
    font-size: 20px;
    color: white;
    text-align: right;
    padding: 2px 6px;
}
#FPSpillar{
    position: absolute;
    bottom: 0px;
    right: 0px;
    width: 150px;
    height: 100px;
}
#FPSpillar div{
    float: right;
    width: 1px;
    height: 100px;
    position: relative;
}
#FPSpillar > div > div{
    background: white;
    position: absolute;
    bottom: 0px;
    right: 0px;
}
#FPSpillar > div > div > div{
    background: orange;
    position: absolute;
    bottom: 0px;
    right: 0px;
}
#FPSnum{
    color: black;
    position: absolute;
    bottom: 0px;
    right: 0px;
    width: 100px;
    z-index: 2;
    text-shadow: -1px 0 white, 0 1px white, 1px 0 white, 0 -1px white;
}
#FPS_MS{
    position: absolute;
    bottom: 0px;
    right: 150px;
    width: 150px;
    height: 100px;
    text-align: center;
    font-size: 13px;
    color: white;
    text-shadow: 1px 0px black, 0px 1px black, 0px -1px black, -1px 0px black;
}
.FPS_MS{
    float: left;
    width: 30px;
    height: 100px;
    position: relative;
}
.FPS_MS div{
    position: absolute;
    bottom: 0px;
    left: 0px;
    width: 30px;
}
#FPS_MS .FPS_MS:nth-child(1) div{ background-color: blue; }
#FPS_MS .FPS_MS:nth-child(2) div{ background-color: green; }
#FPS_MS .FPS_MS:nth-child(3) div{ background-color: red; }
#FPS_MS .FPS_MS:nth-child(4) div{ background-color: orange; }
#FPS_MS .FPS_MS:nth-child(5) div{ background-color: yellow; }
</style>
</head>
<body oncontextmenu="return false;">
    <div id="CanvasPreviews"></div>
    <div id="Menu"></div>
    <div id="Game"></div>
    <div id="FPS"><div id="FPS_MS"></div><div id="FPSpillar"></div><div id="FPSnum"></div></div>

</body></html>
